"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(o,i){try{var a=t[o](i),c=a.value}catch(u){return void n(u)}return a.done?void e(c):Promise.resolve(c).then(function(e){r("next",e)},function(e){r("throw",e)})}return r("next")})}}var _slicedToArray=function(){function e(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var a,c=e[Symbol.iterator]();!(r=(a=c.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(u){o=!0,i=u}finally{try{!r&&c["return"]&&c["return"]()}finally{if(o)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_get=function e(t,n,r){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,n);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,n,r)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(r)},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e};!function(){function e(){var e=document.createElement("div");document.body.appendChild(e),angular.bootstrap(e,["castifyExt.bgApp"],{strictDi:!1})}!function(e){function t(e,t,n,r){if("string"!=typeof e)throw"System.register provided no module name";t="boolean"==typeof n?{declarative:!1,deps:t,execute:r,executingRequire:n}:{declarative:!0,deps:t,declare:n},t.name=e,e in u||(u[e]=t),e=t.deps,n=[],r=0;for(var o=e.length;r<o;r++)-1==s.call(n,e[r])&&n.push(e[r]);t.deps=n,t.normalizedDeps=t.deps}function n(e,t){if(t[e.groupIndex]=t[e.groupIndex]||[],-1==s.call(t[e.groupIndex],e)){t[e.groupIndex].push(e);for(var r=0,o=e.normalizedDeps.length;r<o;r++){var i=u[e.normalizedDeps[r]];if(i&&!i.evaluated){var a=e.groupIndex+(i.declarative!=e.declarative);if(void 0===i.groupIndex||i.groupIndex<a){if(void 0!==i.groupIndex&&(t[i.groupIndex].splice(s.call(t[i.groupIndex],i),1),0==t[i.groupIndex].length))throw new TypeError("Mixed dependency cycle detected");i.groupIndex=a}n(i,t)}}}}function r(e){return l[e]||(l[e]={name:e,dependencies:[],exports:{},importers:[]})}function o(t){if(!t.module){var n=t.module=r(t.name),i=t.module.exports,a=t.declare.call(e,function(e,t){n.locked=!0,i[e]=t;for(var r=0,o=n.importers.length;r<o;r++){var a=n.importers[r];if(!a.locked){var c=s.call(a.dependencies,n);a.setters[c](i)}}return n.locked=!1,t});if(n.setters=a.setters,n.execute=a.execute,!n.setters||!n.execute)throw new TypeError("Invalid System.register form for "+t.name);for(var a=0,d=t.normalizedDeps.length;a<d;a++){var f=t.normalizedDeps[a],p=u[f],h=l[f];h?f=h.exports:p&&!p.declarative?f=p.module.exports&&p.module.exports.__esModule?p.module.exports:{"default":p.module.exports,__useDefault:!0}:p?(o(p),h=p.module,f=h.exports):f=c(f),h&&h.importers?(h.importers.push(n),n.dependencies.push(h)):n.dependencies.push(null),n.setters[a]&&n.setters[a](f)}}}function i(t){if(!t.module){var n={},r=t.module={exports:n,id:t.name};if(!t.executingRequire)for(var o=0,s=t.normalizedDeps.length;o<s;o++){var l=u[t.normalizedDeps[o]];l&&i(l)}t.evaluated=!0,(n=t.execute.call(e,function(e){for(var n=0,r=t.deps.length;n<r;n++)if(t.deps[n]==e){if(e=t.normalizedDeps[n],n=void 0,r=u[e])r.declarative?a(e,[]):r.evaluated||i(r),n=r.module.exports;else if(n=c(e),!n)throw Error("Unable to load dependency "+e+".");return e=(!r||r.declarative)&&n&&n.__useDefault?n["default"]:n}throw new TypeError("Module "+e+" not declared as a dependency.")},n,r))&&(r.exports=n)}}function a(t,n){var r=u[t];if(r&&!r.evaluated&&r.declarative){n.push(t);for(var o=0,i=r.normalizedDeps.length;o<i;o++){var l=r.normalizedDeps[o];-1==s.call(n,l)&&(u[l]?a(l,n):c(l))}r.evaluated||(r.evaluated=!0,r.module.execute.call(e))}}function c(e){if(d[e])return d[e];var t=u[e];if(!t)throw"Module "+e+" not present.";var r=u[e];r.groupIndex=0;var c=[];n(r,c);for(var r=!!r.declarative==c.length%2,s=c.length-1;0<=s;s--){for(var l=c[s],f=0;f<l.length;f++){var p=l[f];r?o(p):i(p)}r=!r}return a(e,[]),u[e]=void 0,c=t.module.exports,c&&(t.declarative||!0===c.__esModule)||(c={"default":c,__useDefault:!0}),d[e]=c}var u={},s=Array.prototype.indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(this[t]===e)return t;return-1},l={},d={};return function(n,r){var o;for(o={register:t,get:c,set:function(e,t){d[e]=t},newModule:function(e){return e},global:e},o.set("@empty",{}),r(o),o=0;o<n.length;o++)c(n[o])}}("undefined"!=typeof window?window:global)(["background-exports"],function(e){e.register("crypto",[],function(e){var t;return e("generateKey",function(){return t.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}),e("exportKey",function(e){return t.subtle.exportKey("jwk",e)}),e("importKey",function(e){return t.subtle.importKey("jwk",e,{name:"AES-GCM"},!0,["encrypt","decrypt"])}),e("encrypt",function(e,n){var r=window.crypto.getRandomValues(new Uint8Array(16)),o=new Uint8Array(0);return t.subtle.encrypt({name:"AES-GCM",iv:r,additionalData:o,tagLength:128},n,e).then(function(e){return[r,o,e]})}),e("decrypt",function(e,n){return t.subtle.decrypt({name:"AES-GCM",iv:e[0],additionalData:e[1],tagLength:128},n,e[2])}),{setters:[],execute:function(){t=window.crypto}}}),e.register("bg-storage-service",[],function(e){function t(){return o||(o=new r),o}var n,r,o;return{setters:[],execute:function(){n={set:function(e,t){return new Promise(function(n,r){var o;chrome.storage.local.set((o={},Object.defineProperty(o,e,{value:t,configurable:!0,enumerable:!0,writable:!0}),o),function(){return chrome.runtime.lastError?r(chrome.runtime.lastError):void n()})})},get:function(e,t){return new Promise(function(n,r){chrome.storage.local.get(e,function(o){return chrome.runtime.lastError?r(chrome.runtime.lastError):void n(o.hasOwnProperty(e)?o[e]:t)})})}},r=function i(){function e(){return $traceurRuntime.asyncWrap(function(e){for(;;)switch(e.state){case 0:a=n.get("cfDraw_store",{}),e.state=5;break;case 5:return void Promise.resolve(a).then(e.createCallback(3),e.errback);case 3:r=e.value,e.state=-2;break;default:return e.end()}},this)}function t(e){return e&&"castifyDrawStore"===e.type&&(r=e.data,n.set("cfDraw_store",r)),!1}var r,i={},o=!1,a=null;return i.getData=function(){return $traceurRuntime.asyncWrap(function(e){for(;;)switch(e.state){case 0:return void Promise.resolve(a).then(e.createCallback(2),e.errback);case 2:e.returnValue=r,e.state=4;break;case 4:e.state=-2;break;default:return e.end()}},this)},i.start=function(){o||(o=!0,chrome.runtime.onMessage.addListener(t),e())},i.stop=function(){o&&(o=!1,chrome.runtime.onMessage.removeListener(t))},i},o=null,e("getBgStorageService",t)}}}),e.register("chrome-messaging",[],function(e){function t(e){return e instanceof Error?Promise.reject(e.toString()):Promise.reject(e)}return e("sendMessage",function(e,t){return new Promise(function(n,r){chrome.runtime.sendMessage({type:e,data:t},function(e){chrome.runtime.lastError?r(chrome.runtime.lastError):e?"result"===e.type?n(e.data):"error"===e.type&&r(e.data):r()})})}),e("respond",function(e,n){Promise.resolve(n)["catch"](t).then(function(t){e({type:"result",data:t})},function(t){e({type:"error",data:t})})}),{setters:[],execute:function(){}}}),e.register("w69b/q",[],function(e){var t;return{setters:[],execute:function(){t={defer:function(){var e={};return e.promise=new Promise(function(t,n){e.resolve=t,e.reject=n}),e}},t.when=Promise.resolve.bind(Promise),t.all=Promise.all.bind(Promise),t.reject=Promise.reject.bind(Promise),Promise.prototype["finally"]||(Promise.prototype["finally"]=function(e){var t=this.constructor;return this.then(function(n){return t.resolve(e()).then(function(){return n})},function(n){return t.resolve(e()).then(function(){throw n})})}),e("default",t)}}}),e.register("throttle",[],function(e){function t(e,t,n){var r,o,i;n=!1!==n;var a=function(){i=Object.assign([],arguments),o=function(){return o=r=null,e.apply(null,i)},n?(r&&window.clearTimeout(r),r=window.setTimeout(o,t)):r||(r=window.setTimeout(o,t))};return a.flush=function(){r&&(window.clearTimeout(r),o())},a.cancel=function(){r&&window.clearTimeout(r)},a}return{setters:[],execute:function(){e("default",t)}}}),e.register("bg-message-service",["crypto"],function(e){function t(){return o||(o=new r),o}var n,r,o;return{setters:[function(e){n=e}],execute:function(){r=function i(){function e(e,n,r){if(!e)return!1;if("castifyDrawGetMsgKey"===e.type){if(n.tab.url.startsWith("https://"))return t.then(function(e){r(e)})["catch"](function(){r(null)}),!0;r("plain")}else if("castifyDrawFrameBroadcast"===e.type&&n.tab)chrome.tabs.sendMessage(n.tab.id,e.data);else if("castifyDrawFrameMsgWithResult"===e.type&&n.tab)return chrome.tabs.sendMessage(n.tab.id,e.data,r),!0;return!1}var t=n.generateKey().then(n.exportKey),i={},r=!1;return i.start=function(){r||(chrome.runtime.onMessage.addListener(e),r=!0)},i.stop=function(){r&&(r=!1,chrome.runtime.onMessage.removeListener(e))},i},o=null,e("getBgMessageService",t)}}}),e.register("w69b/promise-tool",["w69b/q"],function(e){var t,n;return{setters:[function(e){t=e["default"]}],execute:function(){n={wrapChromeError:function(e,n){return function(){var r=Array.prototype.slice.call(arguments,0),o=t.defer();return r.push(function(e){chrome.runtime.lastError?o.reject(chrome.runtime.lastError):o.resolve(e)}),e.apply(n,r),o.promise}},wrapCallbacks:function(e,n){return function(){var r=Array.prototype.slice.call(arguments,0),o=t.defer();return r.push(o.resolve.bind(o)),r.push(o.reject.bind(o)),e.apply(n,r),o.promise}}},e("default",n)}}}),e.register("w69b/webrtc",["w69b/promise-tool","w69b/q"],function(e){function t(e){return e.some(function(e){return!!e.label})}var n,r,o,i;return{setters:[function(e){n=e["default"]},function(e){r=e["default"]}],execute:function(){o={},i=window.navigator,o.getUserMedia=i.mediaDevices&&i.mediaDevices.getUserMedia?i.mediaDevices.getUserMedia.bind(i.mediaDevices):n.wrapCallbacks(i.getUserMedia||i.webkitGetUserMedia||i.mozGetUserMedia||i.msGetUserMedia,i),o.getSources=i.mediaDevices&&i.mediaDevices.enumerateDevices?function(){return r.when(i.mediaDevices.enumerateDevices()).then(function(e){return e.filter(function(e){return e.kind.endsWith("input")}).map(function(e){var t={id:e.deviceId,label:e.label};return t.kind=e.kind.substring(0,e.kind.length-5),t})})}:window.MediaStreamTrack&&MediaStreamTrack.getSources?n.wrapCallbacks(MediaStreamTrack.getSources,MediaStreamTrack):function(){return Promise.resolve([])},o.getSourcesByKind=function(e){return o.getSources().then(function(t){return t.filter(function(t){return t.kind===e})})},o.getVideoSources=function(){return o.getSourcesByKind("video")},o.getAudioSources=function(){return o.getSourcesByKind("audio")},o.hasCamera=function(){return o.getVideoSources().then(function(e){return 0<e.length})},o.hasMicrophone=function(){return o.getAudioSources().then(function(e){return 0<e.length})},o.hasVideoAccess=function(){return o.getVideoSources().then(t)},o.hasAudioAccess=function(){return o.getAudioSources().then(t)},e("default",o)}}}),e.register("bg-cam-sustain-service",["chrome-messaging","w69b/webrtc"],function(e){function t(){return i||(i=new o),i}var n,r,o,i;return{setters:[function(e){n=e},function(e){r=e["default"]}],execute:function(){o=function a(){function e(){t&&(t.getTracks().forEach(function(e){e.stop()}),o=t=null)}function a(e,t,r){return!!(e&&"castifyDrawCamSustainMsg"===e.type&&(e=e.data)&&u.hasOwnProperty(e.type))&&(n.respond(r,u[e.type](e.data)),!0)}var t,o,i={},c=!1,u={start:function(n){return $traceurRuntime.asyncWrap(function(i){for(;;)switch(i.state){case 0:i.state=t?4:6;break;case 4:i.state=JSON.stringify(o)===JSON.stringify(n)?1:3;break;case 1:i.returnValue=void 0,i.state=2;break;case 2:i.state=-2;break;case 3:e(),i.state=6;break;case 6:return void Promise.resolve(r.getUserMedia({video:n})).then(i.createCallback(10),i.errback);case 10:t=i.value,i.state=9;break;case 9:o=n,i.state=-2;break;default:return i.end()}},this)},stop:function(){e()}};return i.start=function(){c||(chrome.runtime.onMessage.addListener(a),c=!0)},i.stop=function(){c&&(c=!1,e(),chrome.runtime.onMessage.removeListener(a))},i},i=null,e("getBgCamSustainService",t)}}}),e.register("bg-castify-draw-service",["bg-message-service","bg-storage-service","bg-cam-sustain-service","throttle"],function(e){function t(e,t){return function(){var n=Array.prototype.slice.call(arguments,0);return new Promise(function(r,o){n.push(function(e){chrome.runtime.lastError?o(chrome.runtime.lastError):r(e)}),e.apply(t,n)})}}function n(e,t,n){function u(t){var r=[c.executeScript(e,{file:t?b:y,allFrames:!0,matchAboutBlank:!0,runAt:"document_start"})];return t&&r.push(c.insertCSS(e,{file:n,allFrames:!0,matchAboutBlank:!0,runAt:"document_start"})),Promise.all(r)}function s(){if(!m){var t=u(!0).then(function(){return g=c.connect(e,{name:"castifyDraw"}),g.onDisconnect.addListener(function(){m===t&&(m=null)}),g.onMessage.addListener(function(e){x.hasOwnProperty(e.type)&&x[e.type](g,e.data)}),g});t["catch"](function(e){console.error("BgCastifyDrawServiceError",e)}),m=t}return m}function l(e){var n,r;return $traceurRuntime.asyncWrap(function(i){for(;;)switch(i.state){case 0:n=new Promise(function(e){x.initializeDone=function(){x.initializeDone=null,e()}}),e=Object.assign({bundlesPath:t},e),i.state=9;break;case 9:return void Promise.resolve(s()).then(i.createCallback(2),i.errback);case 2:return void Promise.resolve(o().getData()).then(i.createCallback(5),i.errback);case 5:r=i.value,i.state=4;break;case 4:p("initialize",{config:e,storage:r}),i.state=11;break;case 11:return void Promise.resolve(n).then(i.createCallback(7),i.errback);case 7:x.initializeDone=null,v=void 0,i.state=-2;break;default:return i.end()}},this)}function d(t){t.tabId==e&&(0===t.frameId?(S.cancel(),h(),l(v)):S())}function f(t){t.replacedTabId===e&&(e=t.tabId,h(),l(v))}function p(e,t){return s().then(function(n){n.postMessage({type:e,data:t})})}function h(){m&&(m.then(function(e){e.disconnect()}),m=null)}var g,m,v,b=t+"content-script.js",y=t+"content-script-frame.js",w={},x={},S=a(function(){u()},1e3);return w.initialize=function(e){return $traceurRuntime.asyncWrap(function(t){for(;;)switch(t.state){case 0:v=e,t.state=5;break;case 5:t.returnValue=l(e),t.state=2;break;case 2:t.state=-2;break;default:return t.end()}},this)},w.dispose=function(){h(),chrome.webNavigation.onCommitted.removeListener(d),chrome.webNavigation.onTabReplaced.removeListener(f),i().stop()},r().start(),o().start(),i().start(),s(),chrome.webNavigation.onCommitted.addListener(d),chrome.webNavigation.onTabReplaced.addListener(f),w}var r,o,i,a,c;return{setters:[function(e){r=e.getBgMessageService},function(e){o=e.getBgStorageService},function(e){i=e.getBgCamSustainService},function(e){a=e["default"]}],execute:function(){c={executeScript:t(chrome.tabs.executeScript,chrome.tabs),insertCSS:t(chrome.tabs.insertCSS,chrome.tabs),connect:chrome.tabs.connect.bind(chrome.tabs)},e("BgCastifyDrawService",n)}}}),e.register("background-exports",["bg-castify-draw-service"],function(e){var t;return{setters:[function(e){t=e.BgCastifyDrawService}],execute:function(){window.BgCastifyDrawService=t}}})}),window.angular&&angular.module("w69b.es6",[]),Array.prototype.find||(Array.prototype.find=function(e){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,n=Object(this),r=n.length>>>0,o=arguments[1],i=0;i<r;i++)if(t=n[i],e.call(o,t,i,n))return t}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(void 0===this||null===this)throw new TypeError("Cannot convert this value to object");var t=Object(this),n=parseInt(t.length,10)||0;if(0===n)return!1;var r=parseInt(arguments[1],10)||0;if(r>=n)return!1;var o;for(r>=0?o=r:(o=n+r,o<0&&(o=0));o<n;){var i=t[o];if(e===i||e!==e&&i!==i)return!0;o++}return!1}}),String.prototype.endsWith||Object.defineProperty(String.prototype,"endsWith",{value:function(e,t){var n=this.toString();(void 0===t||t>n.length)&&(t=n.length),t-=e.length;var r=n.indexOf(e,t);return r!==-1&&r===t}}),String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(e,t){return t=t||0,this.lastIndexOf(e,t)===t}}),angular.module("castifyExt.commonConfig",["castifyExt.castifyAuth","w69b.chromeAnalytics","w69b.chromeRuntime","castifyExt.helpCenterConfig","castifyExt.appOptions","castifyExt.userAccount","castifyExt.deployConfig"]).config(["$compileProvider","$sceDelegateProvider","analyticsProvider","$locationProvider",function(e,t,n,r){n.setTrackingId("UA-23874345-14"),n.setApp("Screencastify"),t.resourceUrlWhitelist(["self","http://localhost:9008/**","blob:**","filesystem:chrome-extension://**","https://**"]);var o=/^\s*(https?|mailto|blob|chrome-extension|filesystem:chrome-extension):/;e.aHrefSanitizationWhitelist(o),e.imgSrcSanitizationWhitelist(o),r.hashPrefix("")}]).run(["$rootScope","analytics","chromeRuntime","appOptions","$injector","userAccount",function(e,t,n,r,o,i){function a(){return i.getAccount().then(function(e){var o="unknown";if(e.license.isPaid)o="paid";else{if(!e.license.isTester)return o="trial";o="tester"}t.tracker.set("dimension1",o),t.tracker.set("dimension2",n.getManifest().version),e.user?(t.tracker.set("userId",e.user.analyticsUid),t.tracker.set("dimension4",e.user.analyticsUid),t.setEnabled(r.values.enableAnalytics&&e.user.analyticsEnabled!==!1)):t.setEnabled(r.values.enableAnalytics)})}var c=o.has("$transitions")?o.get("$transitions"):null,u=r.loadedPromise.then(a);c&&c.onSuccess({},function(e){var n=e.targetState().state(),r=n.analyticsView||n.pageTitle;r&&u.then(function(){t.tracker.sendAppView(r)})}),e.$on("event:userAccountChanged",a)}]).factory("castifyConfig",["deployConfig",function(e){return{API_URL:e.apiUrl,IS_E2E:window.localStorage.e2e}}]),angular.module("castifyExt.authConfig",["castifyExt.youtubeAuth","castifyExt.castifyAuth","w69b.chromeRuntime","w69b.googleHttpAuthInterceptor","castifyExt.youtubeAuth"]).config(["$httpProvider","youtubeAuthProvider","googleHttpAuthInterceptorProvider","deployConfigProvider",function(e,t,n,r){t.setClientId(r.clientId),e.interceptors.push("youtubeHttpAuthInterceptor"),e.interceptors.push("googleHttpAuthInterceptor"),n.enableAuthAutoRetry(!0),n.setAuthProvider("castifyAuth")}]),angular.module("castifyExt.deployConfig",[]).provider("deployConfig",function(){var e={apiUrl:"https://www.screencastify.com/api",clientId:"242262968495-o42n5tqeo08dsa75p3j4dk1k61t05ln3.apps.googleusercontent.com",scopes:chrome.runtime.getManifest().oauth2.scopes,redirectUri:"https://www.screencastify.com/oauth2postback",editorOpenUri:"https://editor.screencastify.com/open/drive"};return _extends({},e,{$get:function(){return e}})}),angular.module("castifyExt.audioStreamMixer",["castifyExt.audioContextPool"]).factory("audioStreamMixer",["audioContextPool",function(e){function t(){var t=e.acquire(),n=t.createMediaStreamDestination(),r={},o={},i={};return i.addStream=function(e,i){var a=t.createMediaStreamSource(i),c=t.createGain();o[e]=a,r[e]=c,a.connect(c),c.connect(n)},i.replaceStream=function(e,n){var a=o[e];a||i.addStream(e,n),a.disconnect();var c=t.createMediaStreamSource(n);c.connect(r[e])},i.setGain=function(e,t){r[e].gain.value=t},i.outStream=n.stream,i.dispose=function(){i.outStream.getTracks().forEach(function(e){e.stop()}),n.disconnect(),angular.forEach(r,function(e){e.disconnect()}),angular.forEach(o,function(e){e.disconnect()}),e.release(t)},i}return t}]),angular.module("castifyExt.chromeVideoRecorder",["w69b.pnaclVideoEncoder","w69b.webrtc","w69b.chromeCapture","w69b.chromeTabs","w69b.promiseTool","w69b.spawn","w69b.chromeCommands","castifyExt.ui.audioCountdown","castifyExt.optionalPermissions","castifyExt.castifyDrawService","castifyExt.resizeTab","castifyExt.audioStreamMixer","castifyExt.requestMicPermission","castifyExt.webrtcRecorder","castifyExt.hdpiTool"]).provider("chromeVideoRecorder",function(){var e="/components/castify/pnacl/manifest_pnacl.nmf",t=!0;this.setEncoderUrl=function(n,r){e=n,t=!!r},this.$get=["$log","pnaclVideoEncoder","webrtc","chromeCapture","$q","castifyDrawService","resizeTab","chromeTabs","audioStreamMixer","$interval","$rootScope","requestMicPermission","promiseTool","optionalPermissions","spawn","hdpiTool","webrtcRecorder","audioCountdown","chromeCommands",function(n,r,o,i,a,c,u,s,l,d,f,p,h,g,m,v,b,y,w){function x(){n.warn("video stream ended while still recording"),f.$broadcast("chromeVideoRecorder:streamEnded")}function S(e){e.getTracks().forEach(function(e){e.stop()})}function E(){return Number((/Chrome\/(\d+)/.exec(window.navigator.userAgent)||[void 0,0])[1])}function k(){N&&N.dispose(),N=null,G.video&&G.video.removeEventListener("inactive",x),angular.forEach(G,function(e){S(e)}),G={},O&&(Y.pause(),Y.src="",URL.revokeObjectURL(O),O=null),q&&(URL.revokeObjectURL(q),q=null)}function R(e){G.video&&(G.video.removeEventListener("inactive",x),S(G.video)),G.video=e,e.addEventListener("inactive",x),O&&URL.revokeObjectURL(O),O=URL.createObjectURL(e)}function C(e){q&&URL.revokeObjectURL(q),q=URL.createObjectURL(e)}function A(e){function t(){var t=[],n=W.filter(function(e){return e.height<=i.height});e.resolution&&(n=n.filter(function(e){return e.height!==i.height}),n.unshift(i)),n.forEach(function(e){t.push({minHeight:e.height})});var r={audio:T(e),video:{optional:t,mandatory:{maxWidth:i.width,maxHeight:i.height}}};return e.camSourceId&&(r.video.mandatory.sourceId=e.camSourceId),o.getUserMedia(r)}function r(){return t()["catch"](function(e){return!e||"PermissionDeniedError"!==e.name&&"MediaDeviceFailedDueToShutdown"!==e.name&&"InvalidStateError"!==e.name?(n.warn("failed to get webcam stream",e),a.reject(e)):(n.debug("webcam permission error detected"),p().then(function(){return r()}))})}var i=e.resolution;return i||(i={width:4096,height:4096}),r()}function _(e){return e?e:a.reject("stream is null")}function P(e){var t=e.resolution;t||(t={width:4096,height:4096});var n=e.audio.system;if(V&&V.cancelled)return a.reject("cancelled");if("desktop"===e.captureSource||"screen"===e.captureSource){var r="desktop"===e.captureSource?["screen","window"]:["screen"];E()>=50&&e.audio.system&&r.push("audio"),K=i.chooseDesktopMedia(r);var c=K.promise.then(function(r){if(!r)return a.reject("cancelled");var i={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,maxWidth:t.width,maxHeight:t.height,maxFrameRate:e.targetFPS}}};return n&&(i.audio={mandatory:{chromeMediaSource:E()>=52?"desktop":"system"}}),o.getUserMedia(i).then(_)});return c["finally"](function(){K=!1}),c}if("tab"==e.captureSource){var u={video:!0,videoConstraints:{mandatory:{maxWidth:t.width,maxHeight:t.height,maxFrameRate:e.targetFPS}},audio:n};return n&&(u.audioConstraints={mandatory:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1}}),i.tabCapture(u).then(_)}if("cam"==e.captureSource)return A(e).then(_);throw Error()}function T(e){if(e.audio.mic){var t={echoCancellation:e.audio.micAudioProcessing!==!1};return e.audio.micSourceId&&(t.sourceId=e.audio.micSourceId),{mandatory:t}}return!1}function I(e){function t(){return o.getUserMedia({audio:T(e),video:r})["catch"](function(e){return n.debug("capture mic failed",e&&e.name),a.reject(e)})}var r=!!e.embedWebcam;return r&&e.camSourceId&&(r={mandatory:{sourceId:e.camSourceId}}),t()["catch"](function(){return n.debug("requesting mic permission"),p().then(t)})}function $(){j&&(j.dispose(),j=null),k(),B&&(B=null)}function D(e){return n.warn("chromeVideoRecorder: could not get video stream",e),a.reject(e)}function F(){B.onCrash=function(e){n.warn("video encoder crashed",e),$(),f.$broadcast("chromeVideoRecorder:crash",e)},B.onError=function(e){"start_timeout"===e||angular.isString(e)&&e.startsWith("start_timeout:")||($(),f.$broadcast("chromeVideoRecorder:error",e))}}function L(e){var t=e.audio.system&&"tab"==e.captureSource;t&&(Y.src=O,Y.volume=1,Y.play())}function U(e){for(var t=2,n=t,r=1;r<Math.floor(16/v.devicePixelRatio);++r)if(n=Math.round(100*v.devicePixelRatio*r)/100,n%2===0){t=n;break}var o=e.width%t,i=e.height%t;return!(!o&&!i)&&(e.width-=o,e.height-=i,!0)}var M,j,O,q,B,N,V,W=[{width:1920,height:1080},{width:1280,height:720},{width:854,height:480},{width:640,height:360},{width:320,height:240},{width:320,height:180}],H=1e4,z=2e3,J=30,G={},Y=document.createElement("video"),K=null,Q={};return Q.start=function(i){function d(){return n.debug("chromeVideoRecorder: loading castifyDraw..."),j=c(i.tabId),h.withTimeout(function(){return a.when(j.initialize(i.draw))},H)}function p(){if("webrtc"==i.codec){if(b.isSupported())return b();W.codec=null}return r(e,t)}function x(){return"tab"===i.captureSource?s.get(i.tabId).then(function(e){W.originalMainSize={width:e.width,height:e.height}}):null}function S(){return i.audio.mic||i.embedWebcam?"cam"===i.captureSource?A:I(i):null}function E(){return i.startDelay?h.withTimeout(function(){return y.load(i.startDelay)["catch"](function(e){n.warn("chromeVideoRecorder: loading countdown failed: ",e)})},z,function(){return n.warn("chromeVideoRecorder: loading countdown timed out"),!0}):null}function k(){if(i.draw=i.draw||{showToolbox:!0},"tab"===i.captureSource&&(i.draw.hasOwnProperty("tool")||(i.draw.tool="pointer"),i.draw.allowWebcam=!1,i.draw.embedWebcam=i.embedWebcam,i.draw.camSourceId=i.camSourceId,i.draw.camPosition=i.camPosition),i.targetFPS=i.targetFPS||J,"cam"===i.captureSource&&(i.audio.system=!1,i.embedWebcam=!1),M=i,!i.filename)throw new Error("filename required");i.audio||(i.audio={}),i.brandingFilename&&(W.brandingFilename="/html5_persistent/"+i.brandingFilename),"nacl"===i.codec?W.codec=null:i.codec&&(W.codec=i.codec),i.audioCodec&&(W.audioCodec=i.audioCodec),"webrtc"===i.codec&&"cam"===i.captureSource&&(W.mimeType='video/webm; codecs="vp8, opus"'),i.startDelay&&(W.startDelay=i.startDelay),V={cancelled:!1,cancel:function(){V.cancelled=!0,K&&K.cancel("cancelled")}},B=p(),F()}var A,_=m.wrap(regeneratorRuntime.mark(function Q(){var e,t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if("tab"===i.captureSource){n.next=2;break}return n.abrupt("return",null);case 2:return n.t0=v,n.next=5,s.get(i.tabId);case 5:if(n.t1=n.sent,e=n.t0.toPhysicalResolution.call(n.t0,n.t1),i.resolution||(i.resolution=angular.copy(e)),U(i.resolution),!U(e)){n.next=13;break}return t=v.toCssResolution(e),n.next=13,u(i.tabId,t.width,t.height,!1);case 13:return n.abrupt("return",null);case 14:case"end":return n.stop()}},Q,this)})),T=m.wrap(regeneratorRuntime.mark(function X(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if("tab"===i.captureSource){t.next=2;break}return t.abrupt("return");case 2:return t.next=4,g.hasTabPermissions(i);case 4:if(e=t.sent){t.next=7;break}return t.abrupt("return",a.reject("tab_permissions_denied"));case 7:return t.abrupt("return",null);case 8:case"end":return t.stop()}},X,this)})),O=m.wrap(regeneratorRuntime.mark(function Z(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("tab"===i.captureSource){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,w.getAll();case 4:i.draw.chromeCommands=e.sent;case 5:case"end":return e.stop()}},Z,this)})),q=m.wrap(regeneratorRuntime.mark(function ee(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,a.all([B.load(),_(),T(),E(),O()]);case 2:return n.debug("chromeVideoRecorder: getting video stream"),t.next=5,P(i)["catch"](D);case 5:return A=t.sent,n.debug("chromeVideoRecorder: got video stream"),R(A),t.next=10,x();case 10:if("tab"!==i.captureSource){t.next=26;break}if(t.t0=i.audio.mic||i.embedWebcam,!t.t0){t.next=16;break}return t.next=15,o.hasVideoAccess();case 15:t.t0=t.sent;case 16:return i.draw.allowWebcam=t.t0,i.embedWebcam=!1,t.prev=18,t.next=21,d();case 21:t.next=26;break;case 23:t.prev=23,t.t1=t["catch"](18),n.warn("chromeVideoRecorder: failed to initialize draw",t.t1);case 26:return t.next=28,S();case 28:return e=t.sent,n.debug("chromeVideoRecorder: got all streams"),W.videoTrack=A.getVideoTracks()[0],i.audio.system&&!A.getAudioTracks().length&&(i.audio.system=!1,n.warn("failed to capture system audio - stream has no audio track."),f.$broadcast("chromeVideoRecorder:systemAudioUnsupported")),i.audio.system&&i.audio.mic||"tab"===i.captureSource&&i.audio.system||i.audio.mic&&Math.abs((i.audio.micGain||1)-1)>.3?(N=l(),W.audioTrack=N.outStream.getAudioTracks()[0],e&&i.audio.mic&&(N.addStream("mic",e),N.setGain("mic",i.audio.micGain||1)),i.audio.system&&N.addStream("system",A)):i.audio.mic?W.audioTrack=e.getAudioTracks()[0]:i.audio.system&&(W.audioTrack=A.getAudioTracks()[0]),e&&(G.mic=e),i.embedWebcam&&e&&e.getVideoTracks().length&&(W.camTrack=e.getVideoTracks()[0],W.camPosition=i.camPosition,C(e)),L(i),n.debug("chromeVideoRecorder: staring encoder..."),t.next=39,B.start(i.filename,W);case 39:n.debug("chromeVideoRecorder: recording started"),y.start();case 41:case"end":return t.stop()}},ee,this,[[18,23]])})),W={};k();var Y=q()["catch"](function(e){return n.error("chromeVideoRecorder: start error",e),$(),a.reject(e)});return V.promise=Y,Y["finally"](function(){V=null}),Y},Q.stop=function(){return y.stop(),j&&(j.dispose(),j=null),B.stop()["finally"](function(){k()})},Q.pause=function(){var e=B.pause();return e.then(function(){y.pause()}),e},Q.resume=function(){var e=B.resume();return e.then(function(){y.start()}),e},Q.setMicGain=function(e){N&&N.setGain("mic",e)},Q.getState=function(){return Q.getStateObj().state},Q.getStateObj=function(){var e;return e=B?B.getStateObj():{state:"inactive",time:0},angular.extend({},e,{videoUrl:O,cameraUrl:q,isDesktopDialogShown:!!K})},Q.cancelPendingStart=function(){return!!V&&(V.cancel(),!0)},Q.getCurrentTime=function(){return B?B.getCurrentTime():0},Q.getRecordingConfig=function(){return M},Q.replaceStream=function(e){var t=M.audio.system,r=angular.extend({},M,e);return B.replaceTracks?P(r).then(function(e){M=r,j&&(j.dispose(),j=c(r.tabId),j.initialize());var n={videoTrack:e.getVideoTracks()[0]};return t&&N.replaceStream("system",e),B.replaceTracks(n).then(function(){R(e),L(r)})},function(e){return n.warn("could not get replacement stream",e),a.reject(e)}):a.reject("chromeVideoRecorder: replaceTracks not supported by chosen recorder")},Q}],this.$get.$inject=["$log","pnaclVideoEncoder","webrtc","chromeCapture","$q","castifyDrawService","resizeTab","chromeTabs","audioStreamMixer","$interval","$rootScope","requestMicPermission","promiseTool","optionalPermissions","spawn","hdpiTool","webrtcRecorder","audioCountdown","chromeCommands"]}),angular.module("castifyExt.fileNameGenerator",["w69b.filesHelper","w69b.uuid"]).factory("fileNameGenerator",["uuid","filesHelper",function(e,t){
return function(n,r){function o(){return n+e()+r}function i(){var e=o();return t.getFileEntryByPath(e).then(function(){return i()},function(){return e})}return n||(n=""),r||(r=""),i()}}]),angular.module("castifyExt.appOptions",["w69b.chromeStorage","castifyExt.enterprisePolicy"]).factory("appOptions",["chromeStorage","$rootScope","$q","enterprisePolicy",function(e,t,n,r){function o(e){return r.options.hasOwnProperty(e)}function i(e){return r.options[e]}var a={notifyAudio:!0,notifyFramerate:!1,notifyTabFocus:!0,uploadPrivacy:"public",autoOpen:!0,autoPlay:!0,driveSync:!1,enableDiskSpaceWatcher:!0,notifySyncProgress:!0,notifyEditProgress:!0,enableAnalytics:!0,enableCrashReports:!1,showDrawingToolsHint:!0,showEditToolsHint:!0,enableWindowPicker:!0,encoder:null,audioCodec:null},c={micGain:1,micAudioProcessing:!0,defaultEncoder:null},u=!1,s={},l=angular.copy(a);return s.localValues=angular.copy(c),s.loadedPromise=n.all({sync:e.sync.getSingle("options"),local:e.local.getSingle("options"),managed:r.loadedPromise}).then(function(e){angular.extend(l,e.sync),angular.extend(s.localValues,e.local),u=!0}),s.values={},Object.keys(a).forEach(function(e){Object.defineProperty(s.values,e,{enumerable:!0,get:function(){return o(e)?i(e):l[e]},set:function(t){l[e]=t}})}),s.save=function(){return e.sync.setSingle("options",l)},s.saveLocal=function(){return e.local.setSingle("options",s.localValues)},s.isLoaded=function(){return u},s.isSetByEnterprisePolicy=function(e){return o(e)},e.onChanged.addListener(function(e,n){"sync"==n&&e.options&&(angular.extend(l,e.options.newValue),t.$$phase||t.$digest()),"local"==n&&e.options&&(angular.extend(s.localValues,e.options.newValue),t.$$phase||t.$digest())}),s}]),angular.module("castifyExt.bgRecord",["w69b.chromeTabs","w69b.chromeAnalytics","w69b.chromeCommands","w69b.chromeStorage","w69b.chromeWindows","w69b.chromeNotifications","w69b.filesHelper","w69b.spawn","castifyExt.chromeVideoRecorder","castifyExt.bgFiles","castifyExt.bgUserAccount","castifyExt.appOptions","castifyExt.recordTool","castifyExt.fileNameGenerator","castifyExt.crashReporter","castifyExt.helpCenter","castifyExt.branding","castifyExt.connect.appRegistry","castifyEdit.bgEditJobScheduler","castifyExt.ui.countdownIcon","castifyExt.statsClient"]).factory("bgRecordService",["chromeVideoRecorder","$rootScope","$q","$log","chromeRuntime","chromeTabs","$window","analytics","appOptions","recordTool","fileNameGenerator","chromeCommands","bgFiles","chromeStorage","chromeWindows","crashReporter","chromeNotifications","helpCenter","branding","appRegistry","filesHelper","spawn","bgEditJobScheduler","countdownIcon","statsClient","userAccount",function(e,t,n,r,o,i,a,c,u,s,l,d,f,p,h,g,m,v,b,y,w,x,S,E,k,R){function C(e){return{path:{19:"images/"+e+"19.png",38:"images/"+e+"38.png"}}}function A(){return w.getDirByPath(re,{create:!0})}function _(e){if(te)throw new Error("already blocked");te=!0;var t=n.defer();return ne=t.promise,e["finally"](function(){te=!1,t.resolve()}),e}function P(e,t){r.warn("bgRecord: recorder_fatal_error",t),c.tracker.sendException(t,!0),F(),"out_of_disk_space"===t?v.setNotifyHelp(m.simple.create({priority:1,title:"Out of disk space",message:"Recording was stopped forcefully. Your recording might be corrupted.",buttons:[{title:"Help"}]},"disk_space")):"no_data"===t?v.setNotifyHelp(m.simple.create({priority:1,title:"Oops, we failed to capture anything",message:"Please try to restart you computer if this problem persists."}),"no_audio"):m.simple.create({priority:1,title:"Oops, something went wrong",message:"Please try to restart Chrome if this problem persists."})}function T(e,t){if(c.tracker.sendException(e,!0),"nacl_load"===e)v.setNotifyHelp(m.simple.create({priority:1,title:"Failed to load NaCl module",message:"Click for help",buttons:[{title:"Help"}]}),"load_nacl");else if("tab_permissions_denied"===e)m.simple.create({priority:1,title:"Tab recording requires additional permissions.",message:"Please use the Screencastify Icon to start recording."});else if("trial_monthly_limit"===e)v.setNotifyHelp(m.simple.create({priority:1,title:"Monthly recordings limit reached.",message:"Please upgrade to make more recordings this month.",buttons:[{title:"Upgrade"}]}),"trial_monthly_limit");else if("start_timeout:no_audio"===e)v.setNotifyHelp(m.simple.create({priority:1,title:"Failed to capture audio",message:"Please try to restart you computer or re-plug your mic."}),"no_audio");else if("start_timeout:no_cam"===e)v.setNotifyHelp(m.simple.create({priority:1,title:"Failed to capture your webcam",message:"Please try to restart you computer or re-plug your cam."}),"no_cam");else{var n="tab"===t.captureSource?"Please try to re-open the tab you are trying to record.":"Please try to restart your computer if this problem persists";v.setNotifyHelp(m.simple.create({priority:1,title:"Failed to start recording",message:n,buttons:[{title:"Help"}]}),"start_recording")}}function I(e,t){u.values.enableCrashReports&&g.report("encoder",t),c.tracker.sendException("encoder_crash",!0),F(),U(),m.simple.create({priority:2,title:"Encoder crashed",message:"Oops, the video encoder crashed. This should not have happened. Please submit a bug report."},"crash")}function $(e,t){ee.forEach(function(n){n.postMessage({type:e,data:t})})}function D(t,n){if(ee.length){var r=angular.copy(e.getStateObj());angular.extend(r,t),r.config=e.getRecordingConfig(),r.previewShown=!!Q,r.isBlocked=te,!n&&angular.equals(r,ie)||($("stateUpdate",r),ie=r)}}function F(){r.debug("bgRecord: cleaning up after fatal error stop"),i.onActivated.removeListener(H),G(),te=!1,le()}function L(e){return i.getActiveTab().then(function(t){e.tabId=t.id,e.windowId=t.windowId,e.tabTitle=t.title,e.resolution||(e.resolution=s.getResolutionLimit(e,t))})}function U(){r.info("bgRecord: Saving webrtc as default encoder..."),u.localValues.defaultEncoder="webrtc",u.saveLocal()}function M(e,t){return(!e.embedWebcam||"desktop"!==e.captureSource)&&(t||"tab"!==e.captureSource)}function j(e){return u.values.encoder?u.values.encoder:angular.isDefined(window.navigator.mimeTypes["application/x-nacl"])?u.localValues.defaultEncoder?"webrtc"!==u.localValues.defaultEncoder||M(e)?u.localValues.defaultEncoder:null:void 0:"webrtc"}function O(){c.trackEvent("recorder","streamEnded","",1),ue.stop()}function q(){m.simple.create({priority:1,title:"Not recording system audio",message:"Capturing system audio is only supported for full-screen or tab recording."},"noSystemAudio")}function B(t){if(!te){if(r.debug("bgRecord: replacing stream...",t),"inactive"===e.getState())return void r.error("bgRecord: cannot replace tab while not recording");m.clear("activeTab"),c.trackEvent("recorder","replaceStream","",1),_(e.replaceStream(t))}}function N(e){if("recorder"==e.name){ee.push(e),D({},!0),e.onDisconnect.addListener(function(){var t=ee.indexOf(e);t>=0&&ee.splice(t,1)});var n={start:ue.start,stop:ue.stop,replaceStream:B,pause:ue.pause,resume:ue.resume,cancelPendingStart:ue.cancelPendingStart,showPreview:function(e){e?Y():G()}};e.onMessage.addListener(function(e){n.hasOwnProperty(e.type)&&n[e.type](e.data),t.$$phase||t.$digest()})}}function V(){m.clear("audioDropped"),m.clear("lowFrameRate"),m.clear("activeTab"),m.clear("noSystemAudio")}function W(t){if(!te){var n=e.getState();if("toggle-recording"==t)"recording"===n||"paused"===n?ue.stop():s.getRecordConfig().then(function(e){ue.start(e)});else if("toggle-pause"==t)"paused"===n?ue.resume():"recording"===n&&ue.pause();else if("focus-tab"==t){var r=e.getRecordingConfig();if("inactive"===n||"tab"!==r.captureSource)return;i.getActiveTab().then(function(e){r.tabId!=e.id&&B({tabId:e.id,windowId:e.windowId,tabTitle:e.title})})}}}function H(t){var n=e.getRecordingConfig();"recording"===e.getState()&&u.values.notifyTabFocus&&"tab"==n.captureSource&&t.windowId==n.windowId&&(t.tabId!==n.tabId?(r.debug("bgRecord: recording tab lost focus"),d.getAll().then(function(e){for(var t=0;t<e.length;++t)if("focus-tab"==e[t].name)return e[t];return null}).then(function(e){var t="Screencastify is recording a tab in the background. ";"webrtc"!==n.codec&&(t+="Use the extension icon to switch the record focus to your current tab.",e&&e.shortcut&&(t+=" You can also use the keyboard shortcut "+e.shortcut+".")),m.simple.create({priority:2,title:"Recording a background tab",message:t},"activeTab")})):(r.debug("bgRecord: recording tab got focus"),m.clear("activeTab")))}function z(){var t=!1;X.$watchCollection(e.getStateObj,function(){D()}),X.$watch(function(){return te},function(e,t){e!==t&&D()}),X.$watch(function(){return[e.getState(),Math.min(0,e.getCurrentTime())]},function(){return ae()},!0),X.$watch(function(){return Math.floor(e.getStateObj().droppedAudioTime)},function(e){if(u.values.notifyAudio&&e){var n={type:"basic",priority:2,title:"Dropping Audio Frames",message:"Screencastify dropped "+e+" seconds audio. Audio will be choppy. Try to restart recording with a lower resolution or frame rate.",iconUrl:"images/icon128.png"};t?m.update("audioDropped",n):m.create("audioDropped",n),t=!0}}),X.$watch(function(){return u.localValues.micGain},function(t,n){t!==n&&e.setMicGain(t)}),X.$on("chromeVideoRecorder:streamEnded",O),X.$on("chromeVideoRecorder:crash",I),X.$on("chromeVideoRecorder:error",P),X.$on("chromeVideoRecorder:systemAudioUnsupported",q)}function J(){(te||"inactive"!==e.getState())&&(r.info("bgRecord: onSuspend() while recorder is active, preventing unloading"),o.getBackgroundPage())}function G(){Q&&h.remove(Q),D()}function Y(){if(!Q){r.debug("bgRecord: opening preview window");var e=Math.ceil(a.screen.width/4),t=Math.ceil(a.screen.height/4);h.create({url:"livepreview.html",type:"panel",width:e,height:t,top:a.screen.height-t,left:a.screen.width-e}).then(function(e){Q=e.id,D(),h.onRemoved.addListener(function t(n){e.id==n&&(h.onRemoved.removeListener(t),r.debug("bgRecord: closed preview window"),Q=null,D())})})}}var K,Q,X,Z,ee=[],te=!1,ne=n.when(),re="/_recording",oe="bgRecord:pendingConfig",ie={},ae=x.wrap(regeneratorRuntime.mark(function de(t){var n,r;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(t||(t=e.getState()),"paused"!==t){o.next=5;break}n=C("icon_paused"),o.next=17;break;case 5:if("recording"!==t){o.next=16;break}if(r=e.getCurrentTime()<0,!r){o.next=13;break}return o.next=10,E.getIcon(e.getCurrentTime());case 10:n=o.sent,o.next=14;break;case 13:n=C("icon_recording");case 14:o.next=17;break;case 16:n=C("icon");case 17:chrome.browserAction.setIcon(n);case 18:case"end":return o.stop()}},de,this)})),ce=x.wrap(regeneratorRuntime.mark(function fe(){var n,o,i,c,u,s;return regeneratorRuntime.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(r.debug("bgRecord: stopped"),n=e.getRecordingConfig(),o=n.filename,i=o.split("/").slice(-1)[0],c=f.localFilenameToId(i),u=!1,!a.navigator.userAgent.includes("Windows")||"webrtc"===n.codec){l.next=19;break}return l.t0=w,l.next=10,w.getFileEntryByPath(o);case 10:return l.t1=l.sent,l.next=13,l.t0.getMetadata.call(l.t0,l.t1);case 13:if(s=l.sent,!(s.size>2e9)){l.next=19;break}return r.debug("Working around 2GB chrome bug on Windows for file of size",s.size),l.next=18,se(o,c,i);case 18:u=!0;case 19:if(u){l.next=22;break}return l.next=22,w.moveFileByPath(o,i);case 22:p.local.remove(oe),t.$broadcast("recorder:stopped",c,n);case 24:case"end":return l.stop()}},fe,this)})),ue={};ue.stop=function(){if(te||"inactive"===e.getState())return n.reject();i.onActivated.removeListener(H),G(),r.debug("bgRecord: stopping...");var t=e.getCurrentTime(),o=e.stop();return _(o)["finally"](ce),V(),K.send(),t>0&&k.sendRecordingCreated(t),c.trackEvent("recorder","stop","",Math.round(t)),o},ue.pause=function(){if(te||"recording"!==e.getState())return n.reject();r.debug("bgRecord: pausing...");var t=e.pause();return _(t),t["finally"](function(){r.debug("bgRecord: paused")}),m.clear("activeTab"),c.trackEvent("recorder","pause","",1),t},ue.resume=function(){te||"paused"!==e.getState()||(r.debug("bgRecord: resuming..."),_(e.resume())["finally"](function(){r.debug("bgRecord: resumed")}),i.getActiveTab().then(function(e){H({tabId:e.id,windowId:e.windowId})}),c.trackEvent("recorder","resume","",1))},ue.start=function(t){function o(){return t.autoShareApp?y.getAppInfo(t.autoShareApp.id).then(function(e){t.autoShareApp=e}):n.when()}function a(){var e=[];return e.push(A()),e.push(l(re+"/",".webm").then(function(e){t.filename=e})),e.push(L(t)),t.autoShareApp&&t.autoShareApp.isPaid||e.push(b.getFilename().then(function(e){e&&(t.brandingFilename=e)})),n.all(e)}function s(){function o(){r.info("bgRecord: retrying with webrtc..."),t.codec="webrtc";var n=e.start(t);return n}return e.start(t)["catch"](function(e){return"nacl_load"===e&&"webrtc"!==t.encoder&&M(t,!0)?o():n.reject(e)})}if(te||"inactive"!==e.getState())return n.reject();i.onActivated.addListener(H),c.trackEvent("recorder","start",t.captureSource,1),K=c.trackTimer("recorder","duration"),t.audio.micGain=u.localValues.micGain,t.audio.micAudioProcessing=u.localValues.micAudioProcessing,t.audioCodec=u.values.audioCodec,u.values.enableWindowPicker||"desktop"!==t.captureSource||(t.captureSource="screen"),t.codec=j(t);var d=x.wrap(regeneratorRuntime.mark(function h(){var e,r;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(!t.autoShareApp||!t.autoShareApp.isPaid){o.next=2;break}return o.abrupt("return");case 2:return o.next=4,R.getAccount();case 4:if(e=o.sent,r=e.license,!(r.limitNumRecordings&&e.numRecordingsMonth>=r.maxNumRecordings)){o.next=8;break}return o.abrupt("return",n.reject("trial_monthly_limit"));case 8:case"end":return o.stop()}},h,this)}));r.debug("bgRecord: starting...",t),Z={cancelled:!1,cancel:function(){Z.cancelled=!0,e.cancelPendingStart()}};var f=o().then(d).then(a).then(function(){return Z.cancelled?n.reject("cancelled"):s()});return _(f),f["finally"](function(){Z=null}),f.then(function(){r.debug("bgRecord: started recording"),p.local.setSingle(oe,t),t.showPreview&&Y()},function(e){if("cancelled"!==e)return D({startError:e}),T(e,t),n.reject(e)}),f};var se=x.wrap(regeneratorRuntime.mark(function pe(e,t,n){var o,i;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=w,a.next=3,w.getFileEntryByPath(e);case 3:return a.t1=a.sent,a.next=6,a.t0.getMetadata.call(a.t0,a.t1);case 6:return o=a.sent,r.debug("bgRecord: adding fix job for incomplete recording",e,o.size),i=S.addJob({type:"fixWebm",inPath:e,fileId:t,outPath:n}),a.prev=9,a.next=12,i.promise;case 12:r.debug("bgRecord: fixed incomplete recording",e),a.next=20;break;case 15:return a.prev=15,a.t2=a["catch"](9),r.warn("bgRecord: failed to fix incomplete recording",e,a.t2),a.next=20,w.moveFileByPath(e,n);case 20:case"end":return a.stop()}},pe,this,[[9,15]])})),le=x.wrap(regeneratorRuntime.mark(function he(){var e,n,r,o,i,a,c,u,s,l,d,h;return regeneratorRuntime.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:return g.next=2,w.listByPath(re)["catch"](function(){return null});case 2:if(e=g.sent){g.next=5;break}return g.abrupt("return");case 5:return g.next=7,p.local.getSingle(oe);case 7:n=g.sent,r=!0,o=!1,i=void 0,g.prev=11,a=e[Symbol.iterator]();case 13:if(r=(c=a.next()).done){g.next=26;break}return u=c.value,s=u.fullPath,l=s.split("/").slice(-1)[0],d=f.localFilenameToId(l),g.next=20,se(s,d,l);case 20:h={},n&&n.filename!==s&&(h=n),t.$broadcast("recorder:fixedFile",d,h);case 23:r=!0,g.next=13;break;case 26:g.next=32;break;case 28:g.prev=28,g.t0=g["catch"](11),o=!0,i=g.t0;case 32:g.prev=32,g.prev=33,!r&&a["return"]&&a["return"]();case 35:if(g.prev=35,!o){g.next=38;break}throw i;case 38:return g.finish(35);case 39:return g.finish(32);case 40:case"end":return g.stop()}},he,this,[[11,28,32,40],[33,,35,39]])}));return ue.install=function(){X=t.$new(!0),z(),le(),o.onConnect.addListener(N),o.onConnectExternal.addListener(N),o.onSuspend.addListener(J),chrome.commands.onCommand.addListener(W)},ue.uninstall=function(){X.$destroy(),o.onConnect.removeListener(N),chrome.commands.onCommand.removeListener(W)},ue.getRecorderState=function(){return e.getStateObj()},ue.cancelPendingStart=function(){return!!Z&&(Z.cancel(),!0)},ue.getConfig=function(){return e.getRecordingConfig()},ue.isBlocked=function(){return te},ue.waitWhileBlocked=function(){return ne},ue}]),angular.module("castifyExt.upload.uploadBase",["castifyExt.bgFiles","w69b.filesHelper"]).factory("UploadBase",["$q","$log","bgFiles","filesHelper",function(e,t,n,r){function o(e){return r.getFileByPath(n.idToLocalFilename(e))}function i(e){this.config=e,this.minStartTime=0,this.numErrors=0}i.targetClasses_={},i.register_=function(e,t){i.targetClasses_[e]=t},i.create=function(e){var t=i.targetClasses_[e.target];if(!t)throw new Error("unknown target "+e.target);return new t(e)},i.CancelledError={reason:"cancelled",isCancelled:!0};var a=i.prototype;return i.unserialize=function(e){var t=e[0],n=e[1],r=i.targetClasses_[t];if(!r)throw new Error("unknown target "+t);return r.fromObject(n)},a.serialize=function(){return[this.config.target,this.toObject()]},a.fromObject=function(e){throw new Error},a.toObject=function(){throw new Error},a.start=function(){},a.cancel=function(){return!1},a.onProgress=function(){},a.onComplete=function(){},a.onError=function(e){},a.handleComplete_=function(e){t.debug("upload complete",e),this.responseData=e},a.handleError_=function(t){return e.reject(t)},a.handleProgress_=function(e){return e},a.loadFile_=function(){var t=this.config,r=o(t.fileId);return e.all({file:r,fileDesc:n.getFileDescriptor(t.fileId)})["catch"](function(n){return t.isSyncUpload?e.reject(i.CancelledError):e.reject(n)})},a.toString=function(){var e=this.config;return"Upload of file "+e.fileId+" to "+e.target},i}]),angular.module("castifyExt.upload.googleUpload",["castifyExt.upload.uploadBase","castifyExt.driveUtils","w69b.googledrive","w69b.googleUploader","castifyExt.bgFiles","castifyExt.youtubeAuth"]).run(["UploadBase","driveUtils","googledrive","googleUploader","bgFiles","$q","$log","$http","$timeout","youtubeAuth","castifyConfig",function(e,t,n,r,o,i,a,c,u,s,l){function d(e){if(angular.isObject(e)&&angular.isNumber(e.status)){var t=e.status;if(t<=0||t>=500&&t<600||e.config&&e.config.authAutoRetry===!1&&401===t)return!0;var n=p.getErrorReason(e);if(["userRateLimitExceeded"].includes(n))return!0}return!1}function f(e){return{id:e.id,channelId:e.snippet.channelId}}function p(t,n){e.call(this,t),this.uploadUrl=n,this.cancelled=!1}function h(){p.apply(this,arguments)}function g(e){p.apply(this,arguments)}function m(t,n){e.call(this,t),this.pollTimer_=null,this.jobId=n}function v(t,n){if(!t.channelId)throw Error("channelId required");e.call(this,t),n&&this.setupDelegate_(n)}var b=l.API_URL+"/upload";p.prototype=Object.create(e.prototype),p.prototype.constructor=e;var y=p.prototype;y.handleProgress_=function(e){e.uploadUrl?this.uploadUrl=e.uploadUrl:(this.loadedBytes_=e.loaded,this.progress=e.loaded/e.total)},y.handleError_=function(t){return t===e.CancelledError||this.cancelled?i.reject(e.CancelledError):(a.debug("googleUploader: handling error",t),i.reject({isTransient:d(t),reason:p.getErrorReason(t)}))},y.resumeUpload_=function(e){return this.uploader_=r.resumeUpload(e,this.uploadUrl),this.uploader_.promise},y.start=function(){this.cancelled=!1;var t=this;this.loadFile_().then(function(n){return t.totalBytes_=n.file.size,t.cancelled?i.reject(e.CancelledError):t.uploadUrl?t.resumeUpload_(n.file,n.fileDesc):t.startUpload_(n.file,n.fileDesc)}).then(this.handleComplete_.bind(this),this.handleError_.bind(this),this.handleProgress_.bind(this)).then(function(e){t.onComplete(e)},function(e){t.onError(e)},function(e){t.onProgress(e)})},p.getErrorReason=function(e){if(angular.isString(e))return e;if(e&&e.data){var t,n=e.data;if(n.error&&n.error.errors&&n.error.errors.length&&(t=n.error.errors[0]),t)return t.reason}else if(e&&e.message)return e.message;return"unknown"},y.toObject=function(){return{config:this.config,uploadUrl:this.uploadUrl}},y.cancel=function(){return!!this.cancelled||(this.loadedBytes_&&this.totalBytes_-this.loadedBytes_<512e3?(a.debug("googleUploader: refusing to cancel almost complete upload"),!1):(this.cancelled=!0,this.uploader_&&this.uploader_.cancel(),!0))},h.prototype=Object.create(p.prototype),h.prototype.constructor=p,e.register_("drive",h),y=h.prototype,y.handleComplete_=function(e){return p.prototype.handleComplete_.call(this,e),o.updateLocalInfo(this.config.fileId,{driveInfo:e}),this.openLink=e.alternateLink,this.setDrivePrivacy_(e.id,this.config.privacy,this.config.domain)},h.doesFileExistInParent=function(e,t){return n.getFile(e).then(function(e){return e.parents&&e.parents.some(function(e){return e.id===t})&&(!e.labels||!e.labels.trashed)},function(e){return 404!=e.status&&i.reject(e)})},y.startUpload_=function(o,a){function c(){if(l.cancelled)return i.reject(e.CancelledError);var t={title:d,description:s.description||"",mimeType:"video/webm",properties:h.toDrivePropertyList_(p),parents:[{id:f}]};return l.uploader_=r.driveUpload(o,t),l.uploader_.promise}function u(t){return l.cancelled?i.reject(e.CancelledError):n.patchFile(t,{properties:h.toDrivePropertyList_(p)})}var s=this.config,l=this,d=s.title;/\.webm$/i.test(d)||(d+=".webm");var f,p={duration:a.duration,width:a.width,height:a.height,uuid:a.id,recordingDate:a.createdAt.getTime(),isScreencastifySyncFile:!0};return t.getDriveUploadParentId().then(function(t){if(l.cancelled)return i.reject(e.CancelledError);if(f=t,a.driveInfo&&a.driveInfo.id){var n=a.driveInfo.id;return h.doesFileExistInParent(n,f).then(function(e){return e?u(n):c()})}return c()})},y.setDrivePrivacy_=function(n,r,o){return"private"===r?i.when(null):this.cancelled?i.reject(e.CancelledError):t.setSimplePrivacy(n,r,o)},h.toDrivePropertyList_=function(e){var t=[];return angular.forEach(e,function(e,n){t.push({key:n,value:e,visibility:"PRIVATE"})}),t},y.toObject=function(){return{config:this.config,uploadUrl:this.uploadUrl}},h.fromObject=function(e){return new h(e.config,e.uploadUrl)},g.prototype=Object.create(p.prototype),g.prototype.constructor=p,e.register_("_youtube_local",g),y=g.prototype,y.handleComplete_=function(e){return p.prototype.handleComplete_.call(this,e),o.updateYoutubeInfo(this.config.fileId,f(e)),this.openLink="http://youtu.be/"+e.id,e},y.startUpload_=function(e){var t=this.config,n={title:t.title,privacy:t.privacy,description:t.description||""};return this.uploader_=r.youtubeUpload(e,n,{youtubeAuth:t.channelId}),this.uploader_.promise},y.resumeUpload_=function(e){return this.uploader_=r.resumeUpload(e,this.uploadUrl,{youtubeAuth:this.config.channelId}),this.uploader_.promise},y.toObject=function(){return{config:this.config,uploadUrl:this.uploadUrl}},g.fromObject=function(e){return new g(e.config,e.uploadUrl)},m.prototype=Object.create(e.prototype),m.prototype.constructor=e,e.register_("_youtube_remote",m),y=m.prototype,y.start=function(){var e=this,t=this.config;this.jobId?this.pollAndHandle_():o.getFileDescriptor(t.fileId).then(function(e){return c.post(b,{driveId:e.driveInfo.id,privacy:t.privacy,channelId:t.channelId},{googleAuth:!0})}).then(function(t){var n=t.data;a.debug("RemoteYoutubeUpload: job created",n),e.jobId=n.id,e.startPollTimer_()},this.handleError_.bind(this))},y.handleComplete_=function(t){e.prototype.handleComplete_.call(this,t),o.updateYoutubeInfo(this.config.fileId,f(t)),this.openLink="http://youtu.be/"+t.id,this.onComplete()},y.pollJob_=function(){return c.get(b+"/"+this.jobId,{googleAuth:!0}).then(function(e){return e.data})},y.handleError_=function(e){this.onError({isTransient:d(e),reason:p.getErrorReason(e)})},y.pollAndHandle_=function(){var e=this;this.pollJob_().then(function(t){a.debug("remote upload job is ",t);var n=t.state;if("completed"===n)e.handleComplete_(t.result);else if("failed"===n){var r=null;if(t.result&&t.result.error)try{r=JSON.parse(t.result.error)}catch(o){}r?e.handleError_({data:r}):e.handleError_("remote job failed")}else e.progress=t.progress,e.onProgress(),e.startPollTimer_()},this.handleError_.bind(this))},y.startPollTimer_=function(){var e=this;this.pollTimer_&&u.cancel(this.pollTimer_),u(function(){e.pollTimer_=null,e.pollAndHandle_()},3e3)},y.toObject=function(){return{config:this.config,jobId:this.jobId}},m.fromObject=function(e){return new m(e.config,e.jobId)},v.prototype=Object.create(e.prototype),v.prototype.constructor=e,e.register_("youtube",v),y=v.prototype,y.toObject=function(){var e=null;return this.delegate_&&(e=this.delegate_.serialize()),{config:this.config,serializedDelegate:e}},v.fromObject=function(t){var n=null;return t.serializedDelegate&&(n=e.unserialize(t.serializedDelegate)),new v(t.config,n)},y.handleError_=function(e){a.warn("YoutubeUploadProxy error",e),this.onError({isTransient:!1,reason:"unknown"})},y.start=function(){var t=this;o.getFileDescriptor(this.config.fileId).then(function(n){var r;if(r=n.driveInfo&&n.driveInfo.id?"_youtube_remote":"_youtube_local",!t.delegate_||t.delegate_.config.target!==r){var o=angular.copy(t.config);o.target=r,t.setupDelegate_(e.create(o))}t.delegate_.start()},this.handleError_.bind(this))},["progress"].forEach(function(e){Object.defineProperty(y,e,{get:function(){var t=this.delegate_;return t?t[e]:null}})}),y.setupDelegate_=function(e){var t=this;if(t.delegate_){var n=t.delegate_;delete n.onError,delete n.onProgress,delete n.onError}t.delegate_=e,e.onError=function(e){t.onError(e)},e.onProgress=function(){t.onProgress()},e.onComplete=function(){t.onComplete()}},y.cancel=function(){return!!this.delegate_&&this.delegate_.cancel()}}]),angular.module("castifyExt.bgUpload",["w69b.chromeStorage","w69b.chromeRuntime","w69b.chromeAnalytics","castifyExt.upload.uploadBase","castifyExt.upload.googleUpload","w69b.throttle","castifyExt.offline","castifyExt.syncAuthTool"]).factory("bgUploadService",["chromeStorage","chromeRuntime","$log","analytics","$rootScope","UploadBase","throttle","onlineState","syncAuthTool","$timeout",function(e,t,n,r,o,i,a,c,u,s){function l(e){if("uploader"==e.name){G.push(e),X(),e.onDisconnect.addListener(function(){var t=G.indexOf(e);t>=0&&G.splice(t,1)});var t={upload:K.upload,cancel:K.cancel};e.onMessage.addListener(function(e){t.hasOwnProperty(e.type)&&t[e.type](e.data)})}}function d(){z.length&&(n.info("onSuspend() while upload queue is not empty, preventing unloading"),t.getBackgroundPage()),Q.flush()}function f(){function e(e,n){var r=e.fileId,o=e.target;n.fileId=r,n.target=o,n.isSyncUpload=e.isSyncUpload,t[r]=t[r]||{},t[r][o]=n}if(G.length){var t={};J.forEach(function(t){e(t.config,{state:"error",error:t.error,config:t.config})}),z.forEach(function(t){e(t.config,{state:"queued",config:t.config})}),H.forEach(function(t){var n={state:"uploading",progress:t.progress};e(t.config,n)}),p("stateUpdate",t)}}function p(e,t){G.forEach(function(n){n.postMessage({type:e,data:t})})}function h(){var t=H.concat(z).map(function(e){return e.serialize()});e.local.setSingle(M,{queued:t,recentErrors:J})}function g(){Q(),X(),Y++}function m(){return e.local.getSingle(M).then(function(e){e&&(J=e.recentErrors||[],z=(e.queued||[]).map(function(e){return i.unserialize(e)}))})}function v(e){delete e.onProgress,delete e.onComplete,delete e.onError;var t=H.indexOf(e);H.splice(t,1),P(),g()}function b(e){var t=z.indexOf(e);z.splice(t,1)}function y(e,t){J=J.filter(function(n){return n.config.target!==t||n.config.fileId!==e})}function w(e,t){for(y(e.fileId,e.target),J.push({config:e,error:t});J.length>j;)J.shift()}function x(e){n.debug("bgUpload: upload complete",e.toString()),v(e),o.$broadcast("uploader:complete",{config:e.config,data:e.responseData,link:e.openLink})}function S(e){e.numErrors++;var t=Math.min(V,Math.pow(2,e.numErrors-1)*N);e.minStartTime=Date.now()+t+Math.random()*W,n.debug("transient upload error, re-queuing in %s: %s",t,e.toString()),I(e)}function E(e,t){if(n.warn("upload error",t),v(e),t===i.CancelledError)n.debug("upload was cancelled",e.toString());else if(t.isTransient)S(e),c.check();else{u.broadcastIfSyncError(t);var a=e.config;o.$broadcast("uploader:failed",{config:a,error:t}),w(a,t),t.reason&&r.tracker.sendException("upload_failed: "+t.reason,!1)}g()}function k(e){g()}function R(e){e.onComplete=x.bind(null,e),e.onError=E.bind(null,e),e.onProgress=k.bind(null,e)}function C(e){return z.filter(function(t){return t.config.fileId===e.fileId&&t.config.target===e.target})[0]}function A(e){return H.filter(function(t){return t.config.fileId===e.fileId&&t.config.target===e.target})[0]}function _(e){return C(e)||A(e)}function P(){function e(){var e=H.length<q&&z.length;if(!e)return!1;var t=z[0],n=t.minStartTime<=Date.now();if(!n)return!1;var r=H.length<B;return!t.config.isSyncUpload||r}if(T(),U&&(s.cancel(U),U=null),c.isOnline()&&z.length)if(z[0].minStartTime<=Date.now()){for(;e();){var t=z.shift();n.debug("starting queued upload",t.toString()),R(t),H.push(t),t.start()}g()}else{var r=z[0],o=r.minStartTime-Date.now();n.debug("scheduling upload queue start in "+o),U=s(P,o)}else;}function T(){z.sort(function(e,t){var n=e.minStartTime-t.minStartTime;if(0===n){if(e.config.isSyncUpload&&!t.config.isSyncUpload)return 1;if(t.config.isSyncUpload&&!e.config.isSyncUpload)return-1}return n})}function I(e){n.debug("queuing upload",e.toString()),z.push(e),g(),P()}function $(){var e=!0,t=!1,n=void 0;try{for(var r,o=z[Symbol.iterator]();!(e=(r=o.next()).done);e=!0){var i=r.value;i.minStartTime=0}}catch(a){t=!0,n=a}finally{try{!e&&o["return"]&&o["return"]()}finally{if(t)throw n}}}function D(e,t){if(n.debug("online state changed to ",t),t)$(),P();else{for(var r=H.concat([]);r.length;){var o=r.pop();o.cancel()&&(v(o),I(i.unserialize(o.serialize())))}$(),g()}}function F(){K.cancelAllUploads()}var L,U,M="uploadsPending",j=5,O=3,q=5,B=q-O,N=2e3,V=12e4,W=1e3,H=[],z=[],J=[],G=[],Y=0,K={},Q=a(h,2e3,!1),X=a(f,300,!1);return K.cancelAllUploads=function(e){var t=z.filter(function(t){return!e||t.config.isSyncUpload}),r=t.length;t.forEach(function(e){n.debug("bgUpload: cancelling queued sync upload",e.toString()),b(e)}),H.forEach(function(t){e&&!t.config.isSyncUpload||(n.debug("bgUpload: cancelling active sync upload",t.toString()),t.cancel(),++r)}),r&&(n.debug("bgUpload: cancelled %s sync uploads",r),g())},K.upload=function(e){var t=e.fileId,o=_(e);return o?(n.info("upload already pending "+t),void(o.config.isSyncUpload&&!e.isSyncUpload&&(n.info("marking upload as non-sync "+t),o.config.isSyncUpload=!1,g(),P()))):(y(e.fileId,e.target),r.trackEvent("uploader","start",e.target,1),void I(i.create(e)))},K.cancel=function(e){if(!e.fileId||!e.target)throw new Error;var t=C(e);t?b(t):(t=A(e),t&&t.cancel()),t?(n.debug("cancelled upload",t.toString()),g()):n.debug("no queued or active upload found to cancel",e)},K.getTargetFileState=function(e,t){function n(n){return n.config.fileId===e&&n.config.target===t}var r=H.find(n);if(r)return{state:"uploading",config:r.config,progress:r.progress};var o=z.find(n);return o?{state:"queued",config:o.config}:null},K.isOnline=function(){return c.isOnline()},K.getWatcherStateId=function(){return Y},K.install=function(){return L=o.$new(!0),m().then(function(){P(),t.onConnect.addListener(l),t.onSuspend.addListener(d),L.$on("onlineState:changed",D),o.$on("event:signInChanged",F)})},K.uninstall=function(){t.onConnect.removeListener(l),t.onSuspend.removeListener(d),L.$destroy()},K.STORAGE_KEY=M,K}]),angular.module("castifyExt.localFileDb",["w69b.chromeStorage","w69b.filesHelper","w69b.chromeRuntime","castifyExt.chromeEventPublisher"]).factory("localFileDb",["$rootScope","chromeStorage","$q","filesHelper","$filter",function(e,t,n,r,o){function i(e){return f+e}function a(e){var t=i(e),n=d.getSingle(t,{});return n}function c(e){return o("date")(e,"MMM d, y h:mm a")}function u(e){return e.title||(e.title=""+c(e.createdAt)),e}function s(e){angular.extend(this,e)}var l={},d=t.local,f="filedb_",p=s.prototype;return s.createFromIdOrFileEntry=function(e){var t,o,i=angular.isString(e)?r.getFileEntryByPath(l.idToFilename(e)):n.when(e);return i.then(function(e){return t=e,
o=l.filenameToId(e.name),n.all({metadata:r.getMetadata(t),info:a(o)}).then(function(e){var n=t.toURL(),r={id:o,uuid:o,url:n,mimeType:"video/webm",createdAt:e.metadata.modificationTime,title:e.info.title,size:e.metadata.size};if(u(r),e.info.videoInfo){var i=e.info.videoInfo;angular.extend(r,{duration:i.duration,width:i.size.width,height:i.size.height})}if(e.info.previewImages&&(r.thumbnailUrl=e.info.previewImages[0].url),e.info.driveInfo&&(r.driveInfo=e.info.driveInfo),e.info.youtubeInfo){var a=e.info.youtubeInfo;r.youtubeInfo={id:a.id,channelId:a.channelId}}return e.info.autoShare&&(r.autoShare=e.info.autoShare),new s(r)})})},p.rename=function(e){return l.updateInfo(this.id,{title:e})},p.remove=function(){var e=this.id;return n.all({result:r.removeByPath(l.idToFilename(e)),info:a(e)}).then(function(e){if(e.info.previewImages)return n.all(e.info.previewImages.map(function(e){return r.removeByPath(e.path)}))}).then(function(){return d.remove(i(e))})},p.updateYoutubeInfo=function(e){return l.updateInfo(this.id,{youtubeInfo:e})},l.listFiles=function(){return r.listByPath("/").then(function(e){var t=[];return e.forEach(function(e){e.isFile&&"."!==e.name[0]&&t.push(s.createFromIdOrFileEntry(e))}),n.all(t).then(function(e){var t={};return e.forEach(function(e){t[e.id]=e}),t})})},l.filenameToId=function(e){if(/\.webm/i.test(e))return e.slice(0,-5);throw new Error("invalid filename: "+e)},l.idToFilename=function(e){return e+".webm"},l.getFileDescriptor=function(e){return s.createFromIdOrFileEntry(e)},l.updateInfo=function(e,t,r){var o,a=i(e);return o=r?n.when(t):d.get(a).then(function(e){return angular.extend(e[a]||{},t)}),o.then(function(e){var t={};return t[a]=e,d.set(t),e})},l}]),angular.module("castifyExt.recordTool",["castifyExt.connect.connectedApps","castifyExt.connect.appRegistry","castifyExt.hdpiTool","w69b.webrtc","w69b.chromeStorage","w69b.chromeWindows","w69b.spawn","w69b.chromeSystem"]).factory("recordTool",["chromeStorage","$window","webrtc","connectedApps","appRegistry","hdpiTool","spawn","chromeSystem","castifyConfig","chromeWindows",function(e,t,n,r,o,i,a,c,u,s){function l(){return t.navigator.userAgent}function d(){return Number((/Chrome\/(\d+)/.exec(window.navigator.userAgent)||[void 0,0])[1])}function f(){return l().indexOf("CrOS")>=0}function p(){return l().indexOf("Mac OS")>=0}function h(){return l().indexOf("CrOS arm")>=0}function g(){return l().indexOf("CrOS x86_64")>=0}function m(){return h()?5:(g(),30)}function v(e){return n.getSources().then(function(t){function n(e,n){return t.some(function(t){return t.kind===e&&t.label&&(!n||n===t.id)})}return e.audio.mic&&(n("audio")?e.audio.micSourceId&&!n("audio",e.audio.micSourceId)&&delete e.audio.micSourceId:e.audio.mic=!1),n("video")?e.camSourceId&&!n("video",e.camSourceId)&&delete e.camSourceId:("cam"===e.captureSource&&(e.captureSource="tab"),e.embedWebcam&&(e.embedWebcam=!1)),e})}function b(e){return e.autoShareApp?r.isConnected(e.autoShareApp.id).then(function(t){return t||delete e.autoShareApp,e}):e}var y={},w="recordConfig",x=null;y.toResolution=function(e){return{width:e.width,height:e.height}},y.scaleResolution=function(e,t){var n=Math.min(t.height/e.height,t.width/e.width,1);return{width:Math.floor(e.width*n),height:Math.floor(e.height*n)}},y.getResolutionLimit=function(e,t){return e.limitResolution?"tab"===e.captureSource?y.scaleResolution(i.toPhysicalResolution(t),e.maxResolution):e.maxResolution:null};var S=a.wrap(regeneratorRuntime.mark(function R(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(x){e.next=4;break}return e.next=3,c.cpu.getInfo();case 3:x=e.sent.numOfProcessors;case 4:return e.abrupt("return",x);case 5:case"end":return e.stop()}},R,this)})),E=a.wrap(regeneratorRuntime.mark(function C(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,S();case 2:if(e=t.sent,!(e>=4)){t.next=7;break}return t.abrupt("return",{width:1920,height:1080});case 7:return t.abrupt("return",{width:1280,height:720});case 8:case"end":return t.stop()}},C,this)})),k=a.wrap(regeneratorRuntime.mark(function A(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=h(),e.t0){e.next=6;break}return e.next=4,S();case 4:e.t1=e.sent,e.t0=e.t1<=4;case 6:return e.abrupt("return",e.t0);case 7:case"end":return e.stop()}},A,this)}));return y.canCaptureSystemAudio=function(){return l().indexOf("Windows")>=0||f()&&d()>=46},y.getRecentlyConnectedApp=function(){return r.getRecent().then(function(e){return e?o.getAppInfo(e):null})},y.clearRecentlyConnectedApp=function(){return r.clearRecent()},y.setRecordConfig=function(t){return e.local.setSingle(w,t)},y.isPreviewSupported=a.wrap(regeneratorRuntime.mark(function _(e){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if("tab"!==e){n.next=2;break}return n.abrupt("return",!1);case 2:if("cam"!==e&&p()){n.next=4;break}return n.abrupt("return",!0);case 4:return n.next=6,s.getCurrent();case 6:return t=n.sent,n.abrupt("return","fullscreen"!==t.state);case 8:case"end":return n.stop()}},_,this)})),y.getRecordConfig=a.wrap(regeneratorRuntime.mark(function P(){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e.local.getSingle(w,{});case 2:if(t=n.sent,!angular.isDefined(t.limitResolution)){n.next=7;break}n.t0=t.limitResolution,n.next=10;break;case 7:return n.next=9,k();case 9:n.t0=n.sent;case 10:if(t.limitResolution=n.t0,!t.maxResolution){n.next=15;break}n.t1=t.maxResolution,n.next=18;break;case 15:return n.next=17,E();case 17:n.t1=n.sent;case 18:if(t.maxResolution=n.t1,t.audio=angular.isObject(t.audio)?t.audio:{mic:!0,system:!1},t.draw=t.draw||{showToolbox:!0,tool:"pointer"},t.embedWebcam=t.embedWebcam||!1,t.camPosition=t.camPosition||"bottomRight",t.captureSource=t.captureSource||"desktop",t.targetFPS=t.targetFPS||m(),t.startDelay=angular.isDefined(t.startDelay)?t.startDelay:u.IS_E2E?0:3,"desktop"!==t.captureSource||y.canCaptureSystemAudio()||(t.audio.system=!1),n.t2=t.showPreview,!n.t2){n.next=32;break}return n.next=31,y.isPreviewSupported(t.captureSource);case 31:n.t2=!n.sent;case 32:if(!n.t2){n.next=34;break}t.showPreview=!1;case 34:return n.next=36,v(t);case 36:return t=n.sent,n.next=39,b(t);case 39:return t=n.sent,n.abrupt("return",t);case 41:case"end":return n.stop()}},P,this)})),y}]),angular.module("castifyExt.resizeTab",["w69b.chromeTabs","w69b.chromeWindows"]).factory("resizeTab",["chromeTabs","chromeWindows","$q",function(e,t,n){function r(r,o,i,a){function c(){return e.get(r).then(function(e){return l=e})}function u(){return t.get(l.windowId).then(function(e){if("normal"!==e.state&&a===!1)return n.reject();var r=e.width-l.width,c=e.height-l.height,u=o+r+d,s=i+c+f;return t.update(l.windowId,{width:u,height:s,state:"normal"})})}function s(e){return e.width!=o||e.height!=i?(d+=o-e.width,f+=i-e.height,u().then(c)):e}var l,d=0,f=0;return c().then(u).then(c).then(s).then(s)["catch"](function(){return l})}return r}]),angular.module("castifyExt.castifyDrawService",[]).factory("castifyDrawService",function(){return function(e){return window.BgCastifyDrawService(e,"components/castifyDraw/release/","components/castifyDraw/release/global-ext.css")}}),angular.module("castifyExt.recordingHooks",["castifyExt.videoPreviewRenderer","castifyExt.appOptions","castifyExt.ui.openInAppTab","castifyExt.bgFiles","castifyExt.connect.bgConnectService","w69b.spawn","w69b.clipboard","w69b.chromeRuntime","w69b.chromeTabs"]).factory("recordingHooks",["$rootScope","videoPreviewRenderer","chromeTabs","appOptions","bgFiles","clipboard","openInAppTab","chromeRuntime","$q","$log","$timeout","filesHelper","spawn","bgConnectService","chromeStorage",function(e,t,n,r,o,i,a,c,u,s,l,d,f,p,h){function g(e){l(function(){a("app.html#/files/"+encodeURIComponent(e))},500)}function m(e){if(0===e.lastIndexOf(k,0)){var t=e.substr(k.length);n.create({url:t}),chrome.notifications.clear(e)}}function v(e,t){if(!t.config.isSyncUpload){var n=t.config,r=t.link;if(/https?:\/\//.test(r)){var o='Your screencast "'+n.title+'" has been uploaded. Click here to open it.';n.copyLinkToClipboard&&(i.copy(r),o+=" The link was copied to your clipboard.");var a={type:"basic",priority:0,title:"Upload complete",message:o,iconUrl:"images/icon128.png"};n.showNotification&&chrome.notifications.create(k+r,a,angular.noop)}}}function b(e){return d.getFileEntryByPath(e).then(function(e){return d.getMetadata(e)}).then(function(e){return e.size})}function y(e){return t.renderPreview(e)["catch"](function(t){s.warn("rendering preview image failed",e);var n=o.idToLocalFilename(e);return b(n).then(function(e){return e<R?(s.warn("file is empty, removing it"),d.removeByPath(n),u.reject(t)):null})})}function w(e,t){return f(regeneratorRuntime.mark(function n(){var r,i,a;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return r=t.autoShareApp.id,i=t.connectMeta&&t.connectMeta.shareUrl,a=t.connectMeta&&t.connectMeta.payload,n.next=5,o.updateLocalInfo(e,{autoShare:{appId:r,shareUrl:i,payload:a,timestamp:Date.now()}});case 5:return n.next=7,o.registerLocalFile(e);case 7:return n.next=9,p.share(r,e,i);case 9:case"end":return n.stop()}},n,this)}))}function x(e,t,n){f(regeneratorRuntime.mark(function i(){return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,y(t);case 2:if(!n.autoShareApp){i.next=7;break}return i.next=5,w(t,n);case 5:i.next=10;break;case 7:return i.next=9,o.registerLocalFile(t);case 9:r.values.autoOpen&&"recorder:fixedFile"!==e.name&&g(t);case 10:s.debug("recording hooks completed for",t);case 11:case"end":return i.stop()}},i,this)}))}var S=[],E={},k="upload:",R=1e4;return E.install=function(){S=[e.$on("recorder:stopped",x),e.$on("recorder:fixedFile",x),e.$on("uploader:complete",v)],chrome.notifications.onClicked.addListener(m)},E.uninstall=function(){S.forEach(function(e){e()}),S=[],chrome.notifications.onClicked.removeListener(m)},E}]),angular.module("castifyExt.videoPreviewRenderer",["castifyExt.bgFiles","w69b.filesHelper","w69b.promiseTool"]).factory("videoPreviewRenderer",["bgFiles","filesHelper","$q","promiseTool",function(e,t,n,r){function o(e){return t.getFileEntryByPath(l+"/"+e,{create:!0},{create:!0})}function i(e,t){var n=Math.max(t.width/e.width,t.height/e.height);return{width:e.width*n,height:e.height*n}}function a(e){function t(){o.resolve(i)}function r(){o.reject("failed to load video")}var o=n.defer(),i=document.createElement("video");return i.src=e,i.addEventListener("canplay",t),i.addEventListener("error",r),o.promise["finally"](function(){i.removeEventListener("canplay",t),i.removeEventListener("error",r)}),o.promise}function c(e){for(var t=window.atob(e),n=new Uint8Array(new ArrayBuffer(t.length)),r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return n}function u(e){var t=e.toDataURL(),r="data:image/png;base64,";if(0!==t.lastIndexOf(r,0))throw Error();var o=t.substring(r.length);return o=new Uint8Array(c(o)),n.when(new Blob([o],{type:"image/png"}))}function s(e,t){var n=document.createElement("canvas");n.width=t.width,n.height=t.height;var r=n.getContext("2d");return r.drawImage(e,0,0,t.width,t.height),u(n)}var l="_previewImages",d={width:640,height:360},f={};return f.renderPreview=function(n){return r.withTimeout(function(){var r,c,u,f=n+".png",p={};return t.getFileEntryByPath(e.idToLocalFilename(n)).then(function(e){return a(e.toURL())}).then(function(e){var t={width:e.videoWidth,height:e.videoHeight};return p.size=t,p.duration=e.duration,u=i(t,d),s(e,u)}).then(function(e){return r=e,o(f)}).then(function(e){return c=e,t.createWriter(c)}).then(function(e){return t.writeFile(e,r)}).then(function(){var t={path:l+"/"+f,size:u,url:c.toURL()};return e.updateLocalInfo(n,{previewImages:[t],videoInfo:p})}).then(function(){return c})},3e3)},f}]),angular.module("castifyExt.updateMigrationService",["w69b.chromeRuntime","w69b.chromeVersionOrder","castifyExt.setupService","w69b.chromeAnalytics","w69b.chromeStorage"]).factory("updateMigrationService",["chromeRuntime","$log","chromeVersionOrder","chromeTabs","setupService","analytics","chromeStorage",function(e,t,n,r,o,i,a){function c(e,r){e!==r&&(t.info("updating from "+e+" to "+r),n.isLess(e,"1.26.0"),n.isLess(e,"1.8.16")&&o.setStorageDecided(!0),n.isLessOrEqual(r,"1.25.6")&&chrome.storage.local.remove("defaultEncoder"))}function u(){i.sendNonInteractionEvent("install","success"),a.local.setSingle("tos_confirmed",!0)}function s(n){t.debug("installed",n),"update"===n.reason&&c(n.previousVersion,e.getManifest().version),"install"===n.reason&&u()}var l={};return l.install=function(){e.onInstalled.addListener(s)},l}]),angular.module("castifyExt.setupService",["castifyExt.appOptions","w69b.webrtc","w69b.chromeStorage","w69b.spawn","castifyExt.userAccount","castifyExt.optionalPermissions"]).factory("setupService",["webrtc","spawn","chromeStorage","$q","appOptions","$log","optionalPermissions","userAccount",function(e,t,n,r,o,i,a,c){function u(){return t(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.sync.getSingle(d,!1),e.next=3,o.loadedPromise;case 3:if(e.t0=o.isSetByEnterprisePolicy("driveSync"),e.t0){e.next=8;break}return e.next=7,t;case 7:e.t0=e.sent;case 8:return e.abrupt("return",e.t0);case 9:case"end":return e.stop()}},e,this)}))}function s(){return t(regeneratorRuntime.mark(function n(){var t,r,o;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.hasVideoAccess(),r=e.hasMicrophone(),o=e.hasAudioAccess(),n.next=5,t;case 5:if(n.t0=n.sent,n.t0){n.next=15;break}return n.next=9,r;case 9:if(n.t1=!n.sent,n.t1){n.next=14;break}return n.next=13,o;case 13:n.t1=n.sent;case 14:n.t0=n.t1;case 15:return n.abrupt("return",n.t0);case 16:case"end":return n.stop()}},n,this)}))}var l={},d="setupService:storageDecided",f="setupService:welcomeShown";return l.getDriveSyncEnabled=t.wrap(regeneratorRuntime.mark(function p(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.loadedPromise;case 2:return e.abrupt("return",o.values.driveSync);case 3:case"end":return e.stop()}},p,this)})),l.setStorageDecided=function(e){return n.sync.setSingle(d,e)},l.setWelcomeShown=function(e){return n.sync.setSingle(f,e)},l.getWelcomeShown=function(){return n.sync.getSingle(f,!1)},l.getSetupState=function(){return t(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.hasLiteTabPermissions();case 2:return e.t0=e.sent,e.next=5,s();case 5:return e.t1=e.sent,e.next=8,c.getAccount();case 8:return e.t2=!!e.sent.user,e.next=11,u();case 11:return e.t3=e.sent,e.next=14,l.getDriveSyncEnabled();case 14:return e.t4=e.sent,e.abrupt("return",{tab:e.t0,cam:e.t1,signIn:e.t2,storage:e.t3,driveSync:e.t4});case 16:case"end":return e.stop()}},e,this)}))},l.isComplete=function(){return t(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.getSetupState();case 2:return t=e.sent,i.debug("setupService.isComplete state",t),e.abrupt("return",t.cam&&t.storage&&(!t.driveSync||t.signIn));case 5:case"end":return e.stop()}},e,this)}))},l}]),angular.module("castifyExt.diskSpaceWatcher",["castifyExt.bgRecord","w69b.filesHelper","w69b.ui.bytesFilter","castifyExt.appOptions","w69b.chromeNotifications","castifyExt.helpCenter"]).factory("diskSpaceWatcher",["bgRecordService","$timeout","filesHelper","$rootScope","$filter","appOptions","chromeNotifications","helpCenter","$log",function(e,t,n,r,o,i,a,c,u){function s(){return m}function l(){return n.getPersistentQuota().then(function(e){return e.quota-e.usage})}function d(t){var n={priority:2,title:"Critically low disk space",message:"You have less than 1GB left. Recording was paused automatically.",buttons:[{title:"Help"}]};a.clear("diskSpaceCritical")["finally"](function(){c.setNotifyHelp(a.simple.create(n,"diskSpaceCritical"),"disk_space")}),u.info("diskSpaceWatcher: auto-pausing on critical low space"),e.pause()}function f(e){e+=1073741824;var t={priority:2,title:"Low disk space",message:"You have only "+o("bytes")(e)+" left. Recording will be paused automatically soon.",buttons:[{title:"Help"}]};c.setNotifyHelp(a.simple.create(t,"diskSpaceLow"),"disk_space")}function p(){h(),i.values.enableDiskSpaceWatcher&&l().then(function(e){e<=s()?d(e):e<=v&&f(e),e>s()&&(g=t(p,b))})}function h(){g&&(t.cancel(g),g=null)}var g,m=0,v=104857600,b=1e4,y={};return y.install=function(){r.$watch(function(){return"recording"===e.getRecorderState().state&&!e.isBlocked()},function(e,t){e!==t&&(e?p():h())}),r.$on("recorder:stopped",function(){a.clear("diskSpaceCritical"),a.clear("diskSpaceLow")})},y.setThresholds=function(e,t){m=t,v=e},y}]),angular.module("castifyExt.audioContextPool",[]).factory("audioContextPool",["$window",function(e){var t=[],n={};return n.acquire=function(){return t.length?t.pop():new e.AudioContext({latencyHint:"playback"})},n.release=function(e){t.push(e)},n}]),angular.module("castifyExt.ui.openInAppTab",["w69b.chromeTabs","w69b.chromeWindows"]).service("openInAppTab",["chromeTabs","chromeRuntime","chromeWindows","$q",function(e,t,n,r){return function(r){var o="chrome-extension://"+t.id+"/app.html";return 0===r.lastIndexOf("#",0)&&(r=o+r),e.create({active:!0,url:r}).then(function(e){n.update(e.windowId,{focused:!0})})}}]).directive("openInAppTab",["$window","openInAppTab",function(e,t){return{restrict:"A",link:function(n,r,o){r.bind("click",function(n){var r=angular.element(n.target),i=o.href||r.attr("href");i&&(n.preventDefault(),t(i).then(function(){e.close()}))})}}}]),angular.module("castifyExt.ui.audioCountdown",[]).factory("audioCountdown",["$q","$timeout",function(e,t){function n(){r||(r=new Audio(i))}var r,o,i="components/castifyExt/ui/audio-countdown.dat",a=10,c=0,u=0,s=!1,l={};return l.load=function(t){s=!0,n();var o=e.defer();return r.addEventListener("canplay",function i(){r.removeEventListener("canplay",i),o.resolve()}),r.error?(s=!1,o.reject("failed to load audio countdown: "+(r.error&&r.error.code))):r.addEventListener("error",function u(){s=!1,r.removeEventListener("error",u),o.reject("failed to load audio countdown: "+(r.error&&r.error.code))}),r.currentTime=Math.max(a-t,0),c=1e3*Math.max(t-a,0),o.promise},l.pause=function(){r&&s&&(o?(t.cancel(o),o=null,c-=Date.now()-u):r.pause())},l.start=function(){r&&s&&!r.ended&&(u=Date.now(),c?o=t(function(){o=null,r.play()},c):r.play())},l.stop=function(){l.pause(),s=!1},l}]),angular.module("castifyExt.ui.countdownIcon",["w69b.spawn"]).factory("countdownIcon",["spawn","$q",function(e,t){function n(e){var n=o.get(e);if(n)return n;var r="images/icon"+e+".png",i=t.defer(),a=new Image;return a.addEventListener("load",function c(){a.removeEventListener("load",c),i.resolve(a)}),a.src=r,o.set(e,i.promise),i.promise}var r={},o=new Map,i={path:{19:"images/icon_countdown19.png",38:"images/icon_countdown38.png"}},a=e.wrap(regeneratorRuntime.mark(function c(e,t){var r,o,i,a;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return r=document.createElement("canvas"),r.width=e,r.height=e,o=r.getContext("2d"),i=38,a=e/i,o.scale(a,a),c.t0=o,c.next=10,n(i);case 10:return c.t1=c.sent,c.t0.drawImage.call(c.t0,c.t1,0,0),o.font="bold 35px sans-serif",o.textBaseline="middle",o.textAlign="center",o.fillStyle="red",o.fillText(t,i/2,i/2),c.abrupt("return",o.getImageData(0,0,r.width,r.height));case 18:case"end":return c.stop()}},c,this)}));return r.getIcon=e.wrap(regeneratorRuntime.mark(function u(e){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(e=Math.ceil(-e),!(e>=10)){n.next=3;break}return n.abrupt("return",t.when(i));case 3:return n.next=5,a(38,e);case 5:return n.t0=n.sent,n.t1={38:n.t0},n.abrupt("return",{imageData:n.t1});case 8:case"end":return n.stop()}},u,this)})),r}]),angular.module("castifyExt.bgLicensing",["castifyExt.castifyAuth","w69b.chromeStorage","w69b.chromeRuntime","w69b.spawn","w69b.promiseTool","castifyExt.connect.connectedApps"]).factory("bgLicensing",["castifyAuth","$http","chromeRuntime","chromeStorage","$q","$log","castifyConfig","promiseTool","spawn","connectedApps",function(e,t,n,r,o,i,a,c,u,s){function l(t){return e.getAuthToken({interactive:t})}function d(){function e(){var e=window.chrome.identity,t=c.wrapChromeError(e.getAuthToken,e);return t({interactive:!1,scopes:["email","https://www.googleapis.com/auth/chromewebstore.readonly"]})}function i(){return u(regeneratorRuntime.mark(function r(){var o,i,a,c,u;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return o=h+n.id,r.next=3,e();case 3:return i=r.sent,r.next=6,t.get(o,{headers:{Authorization:"Bearer "+i}});case 6:if(a=r.sent,c=a.data,!c.result||!c.createdTime){r.next=11;break}return u=new Date(Number(c.createdTime)),r.abrupt("return",u<g);case 11:return r.abrupt("return",!1);case 12:case"end":return r.stop()}},r,this)}))}return r.sync.getSingle(m).then(function(e){return angular.isDefined(e)?e:o.reject()})["catch"](function(){return i().then(function(e){return r.sync.setSingle(m,e),e})})["catch"](function(){return!1})}function f(){return s.getConnectedAppInfo().then(function(e){var t=Date.now(),n=e.some(function(e){return e.isPaidInstall&&(!e.userExpiryDate||e.userExpiryDate>=t)});return n?{access:"full",type:"app",maxAgeSecs:3600}:null})}function p(e){function t(){var t="trial";return e&&(t=e.access,e.type&&(t+="_"+e.type)),t}function n(){return!y||e&&("tester"===e.access||"full"==e.access)}function r(){return!n()}function o(){return!(e&&!e.branding||n())}function i(){return!(!e||"full"!==e.access)}function a(){return!(!e||"tester"!==e.access)}function c(){return n()?Number.MAX_SAFE_INTEGER:v}function u(){return r()}function s(){return u()?b:Number.MAX_SAFE_INTEGER}var l=0;return e&&(l=Date.now()+1e3*e.maxAgeSecs),{validTill:l,type:t(),branding:o(),isTester:a(),isPaid:i(),limitLength:r(),maxLength:c(),limitNumRecordings:u(),maxNumRecordings:s()}}var h="https://www.googleapis.com/chromewebstore/v1.1/userlicenses/",g=1413892757176,m="cws_license",v=600,b=50,y=!0,w={};return w.getLicense=function(){function e(){return o.all([d(),f()]).then(function(e){var t=e[0],n=e[1];return n?n:t?{access:"tester",maxAgeSecs:2}:null})}var t=l().then(e,f).then(function(e){return e}).then(p);return t["catch"](function(e){i.debug("local update failed",e)}),t},w}]),angular.module("castifyExt.driveFileDb",["w69b.chromeStorage","w69b.spawn","castifyExt.driveUtils","castifyExt.offline","castifyExt.castifyAuth"]).factory("driveFileDb",["googledrive","driveUtils","castifyAuth","$q","onlineState","chromeStorage","spawn",function(e,t,n,r,o,i,a){function c(e,t){if(e){var n=e.match(/(.*)=s\d+$/);if(n)return n[1]+"=s"+t}return e}function u(e){var t=[];return angular.forEach(e,function(e,n){angular.isObject(e)?angular.forEach(e,function(e,r){t.push({key:n+"_"+r,value:e,visibility:"PRIVATE"})}):t.push({key:n,value:e,visibility:"PRIVATE"})}),t}function s(e){var t={};return e.forEach(function(e){if("PRIVATE"===e.visibility){if(e.key.indexOf("_")>0){var n=e.key.split("_",2),r=n[0],o=n[1];t[r]||(t[r]={}),t[r][o]=e.value}t[e.key]=e.value}}),t}function l(e){this.updateFromDriveResource_(e)}function d(){return r.when(i.local.getSingle(h,[]))}function f(e){i.local.setSingle(h,e)}var p=400,h="drive_files",g={},m=l.prototype;return m.updateFromDriveResource_=function(e){var t=s(e.properties),n={id:t.uuid,driveId:e.id,thumbnailUrl:c(e.thumbnailLink,p),createdAt:new Date(t.recordingDate?Number(t.recordingDate):e.createdDate),url:e.downloadUrl,urlRequiresAccessToken:!0,mimeType:e.mimeType,size:Number(e.fileSize),duration:Number(t.duration),width:Number(t.width),height:Number(t.height),driveInfo:e},r="."+e.fileExtension;e.fileExtension&&e.title.indexOf(r,e.title.length-r.length)!==-1?n.title=e.title.slice(0,-r.length):n.title=e.title,t.youtubeInfo&&(n.youtubeInfo=t.youtubeInfo),angular.extend(this,n)},m.remove=function(){return e.trashFile(this.driveId)},m.rename=function(t){var n=this.driveInfo.fileExtension;return n&&(n="."+n,t.indexOf(n,t.length-n.length)<0&&(t+=n)),e.patchFile(this.driveId,{title:t}).then(this.updateFromDriveResource_.bind(this))},m.updateYoutubeInfo=function(t){var n=s(this.driveInfo.properties);return n.youtubeInfo=t,e.patchFile(this.driveId,{properties:u({youtubeInfo:t})})},g.getFileDescriptor=function(t){var n="trashed = false and properties has { key='uuid' and value='"+t+"' and visibility='PRIVATE' }";return e.listFiles({maxResults:1,q:n}).then(function(e){return e.length?e[0]:r.reject()}).then(function(e){return new l(e)})},g.listFiles=function(){return a(regeneratorRuntime.mark(function n(){var r,i;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(!o.isOnline()){n.next=19;break}return n.prev=1,n.next=4,t.getDriveUploadParentId().then(function(t){var n="'"+t+"' in parents and trashed = false and properties has { key='isScreencastifySyncFile' and value='true' and visibility='PRIVATE' }";return e.listFiles({maxResults:1e3,q:n})});case 4:r=n.sent,f(r),n.next=17;break;case 8:if(n.prev=8,n.t0=n["catch"](1),!n.t0||!(n.t0.status<=0||n.t0.status>=500)){n.next=16;break}return n.next=13,d();case 13:r=n.sent,n.next=17;break;case 16:throw n.t0;case 17:n.next=22;break;case 19:return n.next=21,d();case 21:r=n.sent;case 22:return i={},r.forEach(function(e){var t=new l(e);i[t.id]=t}),n.abrupt("return",i);case 25:case"end":return n.stop()}},n,this,[[1,8]])}))},g}]),angular.module("castifyExt.bgFiles",["castifyExt.localFileDb","castifyExt.driveFileDb","w69b.chromeRuntime","castifyExt.appOptions","castifyExt.syncAuthTool","castifyExt.offline","w69b.spawn"]).factory("bgFiles",["localFileDb","driveFileDb","$q","$rootScope","chromeRuntime","appOptions","$log","syncAuthTool","$interval","onlineState","spawn",function(e,t,n,r,o,i,a,c,u,s,l){function d(e,t){this.$localDesc=e,this.$driveDesc=t,this.ownProperties_={}}function f(e){this.port=e}function p(e){return c.broadcastIfSyncError(e)}function h(){return i.values.driveSync}function g(e){var t={};return I.forEach(function(n){var r=e[n];angular.isDefined(r)&&(r instanceof Date&&(r=r.getTime()),t[n]=r)}),t}function m(e){var t={};return angular.forEach(e,function(e,n){t[n]=g(e)}),t}function v(){P++,A.listFiles().then(function(e){var t={full:m(e)};b("filesUpdate",t)})}function b(e,t){_.forEach(function(n){n.subscribed&&n.postMessage(e,t)})}function y(e){P++;var t=C[e],n={};t?(n.add={},n.add[e]=g(t)):n.remove=[e],b("filesUpdate",n)}function w(e){if("files"==e.name){var t=new f(e);_.push(t),e.onDisconnect.addListener(function(){var e=_.indexOf(t);e>=0&&_.splice(e,1)});var n={remove:A.remove,reload:function(e){A.reload(e).then(function(){t.postMessage("reloadSuccess",e)},function(){t.postMessage("reloadError",e)})},rename:function(e){A.rename(e.id,e.title)},removeAll:A.removeAll,subscribe:function(){t.subscribed=!0,t.postFiles()}};e.onMessage.addListener(function(e){n.hasOwnProperty(e.type)&&n[e.type](e.data)})}}function x(){return null}function S(e){a.debug("bgFiles: sync setting changed to "+e+" clearing cache"),A.clearCache(),_.length&&v(),r.$broadcast("bgFiles:syncSettingChanged",e)}function E(e){e&&k()}function k(){A.clearCache(),v()}var R,C={},A={},_=[],P=0,T=["id","size","width","height","duration","title","thumbnailUrl","createdAt","url","driveInfo","youtubeInfo","urlRequiresAccessToken","autoShare","mimeType"],I=T.concat(["isSynced","isLocal"]),$=d.prototype;return $.preferDriveDelegate_=function(){return this.$driveDesc?this.$driveDesc:this.$localDesc},$.preferLocalDelegate_=function(){return this.$localDesc?this.$localDesc:this.$driveDesc},$.getDelegate_=function(e){return this.ownProperties_.hasOwnProperty(e)?this.ownProperties_:"thumbnailUrl"===e||"urlRequiresAccessToken"===e||"url"===e?this.preferLocalDelegate_():this.preferDriveDelegate_()},$.callOnBoth_=function(e,t){t=Array.prototype.slice.call(arguments,1);var r,o=this;return r=o.$driveDesc?o.$driveDesc[e].apply(o.$driveDesc,t)["catch"](p):n.when(),r.then(function(){if(o.$localDesc)return o.$localDesc[e].apply(o.$localDesc,t)})},$.reload=function(){var r=[],o=this;o.$driveDesc&&r.push(t.getFileDescriptor(o.id).then(function(e){o.$driveDesc=e})),o.$localDesc&&r.push(e.getFileDescriptor(o.id).then(function(e){o.$localDesc=e}));var i=n.all(r).then(function(){o.ownProperties_={}});return i["finally"](function(){y(o.id)}),i},$.rename=function(e){var t=this,n=t.title;t.title=e;var r=t.callOnBoth_("rename",e);return r["catch"](function(){t.title=n}),r["finally"](function(){y(t.id)}),r},$.remove=function(){a.debug("bgFiles.remove",this.id);var e=this,t=e.callOnBoth_("remove");return t.then(function(){delete C[e.id],r.$broadcast("bgFiles:fileRemoved",e.id)}),t["finally"](function(){y(e.id)}),t},$.updateYoutubeInfo=function(e){var t=this,n=t.youtubeInfo;t.youtubeInfo=e;var r=t.callOnBoth_("updateYoutubeInfo",e);r["catch"](function(){t.youtubeInfo=n}),r["finally"](function(){y(t.id)})},T.forEach(function(e){Object.defineProperty($,e,{get:function(){var t=this.getDelegate_(e);return t?t[e]:null},set:function(t){this.ownProperties_[e]=t}})}),Object.defineProperty($,"isSynced",{get:function(){return!!this.$driveDesc}}),Object.defineProperty($,"isLocal",{get:function(){return!!this.$localDesc}}),$=f.prototype,$.postMessage=function(e,t){_.indexOf(this)<0||this.port.postMessage({type:e,data:t})},$.postFiles=function(){var e=this;A.listFiles().then(function(t){e.postMessage("filesUpdate",{full:m(t)})},function(t){a.warn("initial MessageClient subscribe postFiles failed",t),e.postMessage("filesUpdate",{error:!0})})},A.getFileDescriptor=function(e){return C[e]?n.when(C[e]):A.listFiles().then(function(t){return t[e]?t[e]:n.reject()})},A.listFiles=function(){if(!R){var r=i.loadedPromise.then(function(){return h()?t.listFiles():n.when({})});R=n.all({local:e.listFiles(),drive:r}).then(function(e){var t=Object.keys(e.local).concat(Object.keys(e.drive));return t.forEach(function(t){var n=e.local[t],r=e.drive[t],o=new d(n,r);C[o.id]=o}),C}),R["catch"](p),R["catch"](function(){R=null})}return R},A.removeAll=function(){var e=A.listFiles().then(function(e){return n.all(Object.keys(e).map(function(e){return A.remove(e)}))});return e["catch"](v),e},A.remove=function(e){return A.getFileDescriptor(e).then(function(e){return e.remove()})},A.rename=function(e,t){return A.getFileDescriptor(e).then(function(e){return e.rename(t)})},A.reload=function(e){return A.getFileDescriptor(e).then(function(e){return e.reload()})},A.clearCache=function(){R=null,angular.copy({},C)},A.idToLocalFilename=function(t){return e.idToFilename(t)},A.localFilenameToId=function(t){return e.filenameToId(t)},A.updateLocalInfo=function(t,n){return e.updateInfo(t,n).then(function(){A.reload(t).then(function(){y(t)})})},A.updateYoutubeInfo=function(e,t){return A.getFileDescriptor(e).then(function(e){return e.updateYoutubeInfo(t)})},A.getListVersionId=function(){return P},A.isSyncEnabled=h,A.registerLocalFile=function(t){return l(regeneratorRuntime.mark(function n(){var o,i;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e.getFileDescriptor(t);case 2:return o=n.sent,n.next=5,A.getFileDescriptor(t)["catch"](function(){return new d(o,null)});case 5:i=n.sent,C[i.id]=i,y(t),r.$broadcast("bgFiles:localFileCreated",t);case 9:case"end":return n.stop()}},n,this)}))},A.refresh=function(r){if(!/^[0-9a-zA-Z\-]*$/.test(r))throw new Error("invalid file id");return n.all({proxy:A.getFileDescriptor(r)["catch"](x),drive:t.getFileDescriptor(r)["catch"](x),local:e.getFileDescriptor(r)["catch"](x)}).then(function(e){var t=e.proxy;if(!t){if(!e.drive&&!e.local)return n.reject();t=new d(e.local,e.drive),C[t.id]=t}t.$driveDesc=e.drive,t.$localDesc=e.local,t.$driveDesc||t.$localDesc||(t.deleted=!0,delete C[r]),y(r)})},A.install=function(){u(k,9e5),r.$on("onlineState:changed",E),
r.$on("event:userAccountChanged",k),i.loadedPromise.then(function(){r.$watch(h,function(e,t){t!==e&&S(e)})}),o.onConnect.addListener(w)},A}]),angular.module("castifyExt.licenseEnforcer",["castifyExt.bgRecord","castifyExt.userAccount","w69b.chromeTabs"]).factory("licenseEnforcer",["bgRecordService","$rootScope","userAccount","chromeTabs","$log","analytics",function(e,t,n,r,o,i){function a(e){var t="https://www.screencastify.com/buy?utm_source=app&utm_medium="+e+"&utm_campaign=recording_length";r.create({url:t})}function c(){o.debug("recordLimitReached"),i.sendNonInteractionEvent("recording_limit","notify","",1);var t={type:"basic",priority:2,title:"Recording stopped",message:"You have reached the recording limit of Screencastify Lite. Please upgrade to record longer screencasts",iconUrl:"images/icon128.png"};chrome.notifications.clear("recordLimitInfo",angular.noop),chrome.notifications.clear("recordLimitReached",angular.noop),chrome.notifications.create("recordLimitReached",t,angular.noop),e.stop(),a("auto")}function u(e){o.debug("recordLimitApproaching");var t={type:"basic",priority:2,title:"Approaching free recording limit",message:"Recording will be stopped automatically in "+e+" seconds. Please upgrade Screencastify to record longer screencasts.",iconUrl:"images/icon128.png"};chrome.notifications.create("recordLimitInfo",t,angular.noop)}function s(e){"recordLimitReached"!==e&&"recordLimitInfo"!==e||(a("notify"),chrome.notifications.clear(e,angular.noop))}var l=30,d={};return d.install=function(){function r(){var t=e.getConfig();return t.autoShareApp&&t.autoShareApp.isPaid}function o(){n.getAccount().then(function(e){i=e.license.maxLength})}var i=Number.MAX_VALUE;t.$on("event:userAccountChanged",o),o(),t.$watch(function(){return e.getRecorderState().time>=i},function(e){e&&!r()&&c()}),t.$watch(function(){return i-Math.ceil(e.getRecorderState().time)},function(e){e>0&&e<=l&&!r()&&u(e)}),t.$on("recorder:stopped",function(){chrome.notifications.clear("recordLimitInfo",angular.noop)})},chrome.notifications.onClicked.addListener(s),d}]),angular.module("castifyExt.bgMessages",["castifyExt.ui.openInAppTab","castifyExt.connect.connectedApps","castifyExt.userAccount"]).factory("bgMessages",["chromeRuntime","chromePersistentLogger","openInAppTab","chromeTabs","castifyAuth","connectedApps","userAccount","bgFiles","$log","$timeout",function(e,t,n,r,o,i,a,c,u,s){function l(n,r,o){if("bg:load"===n&&h)e.sendMessage("bg:loaded")["catch"](function(){return null});else if("bg:flushLogs"===n)return t.save().then(function(){o(!0)}),!0;return!1}function d(t){return"chrome-extension://"+e.id+"/app.html#"+t}function f(t,n,c){if("bg:launchApp"===t||t&&"bg:launchApp"===t.type)return p(t.data,n).then(function(){return c(!0)})["catch"](function(e){u.warn("launchApp error:",e),c(!1)}),!0;if("bg:launchSupport"===t)r.create({url:d("/support")});else{if("bg:getSignInToken"===t)return o.getAuthToken({interactive:!0}).then(function(e){c(e)},function(){c(!1)}),!0;if("bg:updateLicense"===t)a.update();else if("bg:isInstalled"===t)c(e.getManifest().version);else{if(t&&"bg:connectApp"===t.type)return i.connect(t.data).then(function(){c(!0)},function(){c(!1)}),!0;if("bg:getLicenseInfo"===t)return a.getAccount().then(function(e){var t={isPaid:e.license.isPaid,isTester:e.license.isTester};e.user&&(t.email=e.user.email,t.analyticsUid=e.user.analyticsUid),t.license=e.license,t.user=e.user,c(t)}),!0}}return!1}var p=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(u.debug("handling bg:launchApp",e),n.tab&&n.tab.id){t.next=3;break}return t.abrupt("return");case 3:if(!e){t.next=11;break}return t.next=6,c.refresh(e);case 6:return t.next=8,s(g);case 8:r.update(n.tab.id,{url:d("/files/"+e)}),t.next=12;break;case 11:r.update(n.tab.id,{url:d("/")});case 12:case"end":return t.stop()}},t,this)}));return function(t,n){return e.apply(this,arguments)}}(),h=!1,g=500,m={};return m.install=function(){e.onMessage.addListener(l),e.onMessageExternal.addListener(f)},m.initializationCompleted=function(){e.sendMessage("bg:loaded")["catch"](function(){return null}),h=!0},m}]),angular.module("castifyExt.chromeEventPublisher",[]).run(["chromeRuntime","$rootScope",function(e,t){var n="event:";e.onMessage.addListener(function(e){angular.isObject(e)&&angular.isString(e.type)&&0===e.type.lastIndexOf(n,0)&&t.$broadcast(e.type,e.data),t.$$phase||t.$digest()})}]),angular.module("castifyExt.driveUtils",["w69b.googledrive","castifyExt.castifyAuth","w69b.es6","w69b.spawn","w69b.chromeStorage"]).factory("driveUtils",["googledrive","$q","spawn","$log","chromeStorage","$rootScope","$timeout",function(e,t,n,r,o,i,a){function c(){return r.debug("driveUtils: creating Drive folder"),e.postFile({title:"Screencastify",mimeType:"application/vnd.google-apps.folder",description:"Screencastify uses this folder to store Screencasts that you upload. You may rename or move it, it will upload to this folder.",properties:[{key:"isScreencastifyUploadFolder",value:!0,visibility:"PRIVATE"}]})}function u(e){if(e&&e.data){var t,n=e.data;if(n.error&&n.error.errors&&n.error.errors.length&&(t=n.error.errors[0]),t)return t.reason}else if(e&&e.message)return e.message;return null}function s(n){return e.getFile(n).then(function(e){return!e.labels.trashed},function(e){return 404!==e.status&&(r.warn("driveUtils: checkIfExists failed",e),t.reject(e))})}function l(){var t="mimeType = 'application/vnd.google-apps.folder' and trashed = false and properties has { key='isScreencastifyUploadFolder' and value='true' and visibility='PRIVATE' }";return e.listFiles({q:t,maxResults:1}).then(function(e){return r.debug("driveUtils: findFolder items #",e.length),e.length?e[0]:null})}function d(e,t){var n=e.filter(function(e){return e.type===t});return n.length?n[0]:null}function f(e){return d(e,"anyone")}function p(e){return d(e,"domain")}function h(e){var t=f(e),n=p(e);return t?t.withLink?"unlisted":"public":n?n.withLink?"domain_unlisted":"domain_public":"private"}function g(){m=null,o.sync.remove(y)}var m,v,b={},y="DRIVE_FOLDER_ID",w=1e4;return b.getDriveUploadParentId=function(e){return m&&!e||(m=n(regeneratorRuntime.mark(function t(){var e,n,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,o.sync.getSingle(y);case 2:if(e=t.sent,t.t0=e,!t.t0){t.next=8;break}return t.next=7,s(e);case 7:t.t0=t.sent;case 8:if(!t.t0){t.next=11;break}return r.debug("driveUtil: using cached parent Id",e),t.abrupt("return",e);case 11:return t.next=13,l();case 13:if(n=t.sent){t.next=18;break}return t.next=17,c();case 17:n=t.sent;case 18:return i=n.id,t.next=21,o.sync.setSingle(y,i);case 21:return t.abrupt("return",i);case 22:case"end":return t.stop()}},t,this)})),m["catch"](function(e){b.isRateLimitError(e)?(v&&a.cancel(v),v=a(function(){m=null,v=null},w)):m=null})),m},b.getSimplePrivacy=function(t){return e.listPermissions(t).then(h)},b.getLink=function(e){return"https://drive.google.com/file/d/"+e+"/view"},b.setSimplePrivacy=function(r,o,i){var a=o.startsWith("domain_");if(a&&!i)throw new Error;return n(regeneratorRuntime.mark(function c(){var n,u,s,l;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,e.listPermissions(r);case 2:if(n=c.sent,u=f(n),s=p(n),h(n)!==o){c.next=9;break}return c.abrupt("return",t.when(null));case 9:if("private"!==o){c.next=18;break}if(!u){c.next=13;break}return c.next=13,e.removePermission(r,u.id);case 13:if(!s){c.next=16;break}return c.next=16,e.removePermission(r,s.id);case 16:c.next=27;break;case 18:if(!u){c.next=21;break}return c.next=21,e.removePermission(r,u.id);case 21:if(!s){c.next=24;break}return c.next=24,e.removePermission(r,s.id);case 24:return l={role:"reader",type:a?"domain":"anyone",withLink:"unlisted"===o||"domain_unlisted"===o},a&&(l.value=i),c.abrupt("return",e.insertPermission(r,l));case 27:case"end":return c.stop()}},c,this)}))},b.isGoogleAppsForbiddenError=function(e){return e&&403==e.status&&"domainPolicy"===u(e)},b.isRateLimitError=function(e){return e&&403==e.status&&"rateLimitExceeded"===u(e)},i.$on("event:signInChanged",g),b}]),angular.module("castifyExt.youtubeUtils",["castifyExt.castifyAuth"]).factory("youtubeUtils",["$http","$q",function(e,t){function n(e){var n=e.data.items;return n.length?n[0]:t.reject("not found")}function r(t,r){return e.get(i,angular.extend({params:{id:t,part:"status,snippet"}},{youtubeAuth:r})).then(n)}function o(t,n,r){return r=angular.extend({id:t},r),e.put(i,r,angular.extend({params:{part:"status"}},{youtubeAuth:n})).then(function(e){return e.data})}var i="https://www.googleapis.com/youtube/v3/videos",a={};return a.getPrivacy=function(e,n){return r(e,n).then(function(e){return n!==e.snippet.channelId?t.reject():e.status.privacyStatus})},a.getLink=function(e){return"https://youtu.be/"+e},a.setPrivacy=function(e,t,n){return o(e,n,{status:{privacyStatus:t}})},a}]),angular.module("castifyExt.driveFileWatcher",["w69b.googledrive","w69b.chromeStorage","w69b.chromeAlarms","castifyExt.castifyAuth"]).factory("driveFileWatcher",["googledrive","chromeStorage","$rootScope","$log","chromeAlarms",function(e,t,n,r,o){function i(){return t.local.setSingle(f,{ids:Object.keys(v),lastCheckedAt:g})}function a(e,t){n.$broadcast("driveFileWatcher:"+e,t)}function c(e){delete v[e]}function u(t){if(v[t])return e.getFile(t).then(function(e){e.labels&&e.labels.trashed?(r.debug("file was trashed",t),a("removed",t),c(t)):e.thumbnailLink&&(r.debug("detected drive processing complete for file",t),a("processed",t),c(t))},function(e){r.debug("failed to check drive file",t,e),404==e.status?(r.debug("file was removed"),a("removed",t),c(t)):r.debug("we will try again later")})}function s(){function e(){return t.length?u(t.pop()).then(e,e):null}var t=Object.keys(v);t.length&&!h&&(r.debug("checking watched drive files",t),h=!0,e()["finally"](function(){h=!1,g=Date.now(),i(),l()}))}function l(e){Object.keys(v).length&&(!e&&Date.now()-g>=6e4*m?s():o.get(p).then(function(e){e||o.create(p,{delayInMinutes:m})}))}function d(e){e.name===p&&l()}var f="driveFileWatcher",p=f,h=!1,g=0,m=10,v={},b={};return b.watchFile=function(e){r.debug("watching drive file",e),v[e]=!0,i(),l(!0)},b.clear=function(){v={},i()},b.install=function(){t.local.getSingle(f).then(function(e){e&&(e.ids.forEach(function(e){v[e]=!0}),g=e.lastCheckedAt||0),l()}),o.onAlarm.addListener(d)},b}]),angular.module("castifyExt.bgSyncManager",["castifyExt.appOptions","castifyExt.bgUpload","w69b.chromeRuntime","castifyExt.driveFileWatcher","w69b.googledrive","castifyExt.localFileDb","castifyExt.chromeEventPublisher","castifyExt.bgFiles","w69b.spawn","castifyExt.bgSyncDownloader"]).factory("bgSyncManager",["$rootScope","appOptions","bgUploadService","localFileDb","googledrive","chromeRuntime","$q","driveFileWatcher","$log","bgFiles","spawn","bgSyncDownloader",function(e,t,n,r,o,i,a,c,u,s,l,d){function f(e){return u.debug("bgSyncManager: staring sync upload",e.id),n.upload({fileId:e.id,target:"drive",privacy:"private",title:e.title,isSyncUpload:!0})}function p(e,t){function n(e){if(e.title!==i.title){u.debug("bgSyncManager: title changed, applying post-upload changes");var t=e.title;return/\.webm/i.test(t)||(t+=".webm"),o.patchFile(l,{title:t})}return a.when()}if(t.config.isSyncUpload){var i=t.config,l=t.data.id;u.debug("bgSyncManager: sync upload of file %s complete, driveId %s",i.fileId,l),r.getFileDescriptor(i.fileId).then(function(e){return n(e)})["catch"](function(e){u.warn("bgSyncManager: sync upload hook failed",e)}).then(function(){s.refresh(i.fileId),c.watchFile(l)})}}function h(e){return r.listFiles().then(function(t){for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];if(r.driveInfo&&r.driveInfo.id===e)return r}return a.reject()})}function g(e){return r.getFileDescriptor(e).then(function(e){return e.remove().then(function(){return u.debug("bgSyncManager: removed local file",e.id),s.refresh(e.id)})},angular.identity)}function m(e,t){w()&&(u.debug("bgSyncManager: drive file %s processed",t),h(t).then(function(e){return s.refresh(e.id).then(function(){k(e.id)})},angular.identity))}function v(e,n){t.values.driveSync&&(u.debug("bgSyncManager: drive file %s remove detected, removing local file",n),h(n).then(function(e){g(e.id).then(function(){k(e.id)})},angular.identity))}function b(e){var t=I.get(e.id);if(t&&!t.downloadPending){var n=d.startDownload(e.id);t.downloadPending=!0,n.done.then(t.deferred.resolve.bind(t.deferred),t.deferred.reject.bind(t.deferred)),n.done["finally"](function(){t.downloadPending=!1,t.timestamp=Date.now()})}}function y(e,t){k(t)}function w(){return t.isLoaded()&&t.values.driveSync}function x(e){var t=I.get(e.id),n=e.isSynced&&!!e.driveInfo.thumbnailLink,r=e.isSynced&&new Date(e.driveInfo.createdDate)<Date.now()-F,o=t&&(t.downloadPending||t.timestamp+$>=Date.now());return e.isLocal&&(n||r)&&!o}function S(e){var t=e.autoShare;return t&&t.timestamp+$<Date.now()}function E(){return l(regeneratorRuntime.mark(function e(){var t,n,o,i,a,c,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=!0,n=!1,o=void 0,e.prev=3,e.t0=Object,e.next=7,r.listFiles();case 7:e.t1=e.sent,e.t2=Symbol.iterator,i=e.t0.keys.call(e.t0,e.t1)[e.t2]();case 10:if(t=(a=i.next()).done){e.next=20;break}return c=a.value,e.next=14,s.getFileDescriptor(c);case 14:if(u=e.sent,u.isSynced||u.autoShare){e.next=17;break}return e.abrupt("return",!1);case 17:t=!0,e.next=10;break;case 20:e.next=26;break;case 22:e.prev=22,e.t3=e["catch"](3),n=!0,o=e.t3;case 26:e.prev=26,e.prev=27,!t&&i["return"]&&i["return"]();case 29:if(e.prev=29,!n){e.next=32;break}throw o;case 32:return e.finish(29);case 33:return e.finish(26);case 34:return e.abrupt("return",!0);case 35:case"end":return e.stop()}},e,this,[[3,22,26,34],[27,,29,33]])}))}function k(e){l(regeneratorRuntime.mark(function t(){var n,r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,s.getFileDescriptor(e);case 2:if(n=t.sent,!w()){t.next=15;break}if(n.isSynced||n.autoShare||f(n),!x(n)){t.next=13;break}return t.next=8,E();case 8:if(!t.sent){t.next=12;break}g(n.id),t.next=13;break;case 12:D.add(n.id);case 13:r=I.get(n.id),r&&!r.isDone&&(n.isLocal?r.deferred.resolve():b(n));case 15:n.autoShare&&S(n)&&g(n.id);case 16:case"end":return t.stop()}},t,this)}))["catch"](function(t){u.error("bgSyncManager.syncFile("+e+") failed : ",t)})}function R(e,t){e={id:t,deferred:a.defer(),isDone:!1},I.set(t,e);var n=e.deferred.promise;return n.then(function(){e.isDone=!0}),n["catch"](function(){I["delete"](t)}),e}function C(e,t){t||n.cancelAllUploads(!0),T.syncFiles()}function A(){var e=!0,t=!1,n=void 0;try{for(var r,o=D[Symbol.iterator]();!(e=(r=o.next()).done);e=!0){var i=r.value;k(i)}}catch(a){t=!0,n=a}finally{try{!e&&o["return"]&&o["return"]()}finally{if(t)throw n}}}function _(){c.clear(),D.clear(),L()["finally"](function(){T.syncFiles()})}function P(e,r){t.values.driveSync&&n.cancel({target:"drive",fileId:r})}var T={},I=new Map,$=18e5,D=new Set,F=72e5;T.syncFiles=function(){l(regeneratorRuntime.mark(function e(){var t,n,o,i,a,c,u,s,l,d,f,p,h,g,m,v,b,y,w;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Set,n=!0,o=!1,i=void 0,e.prev=4,e.t0=Object,e.next=8,r.listFiles();case 8:e.t1=e.sent,e.t2=Symbol.iterator,a=e.t0.keys.call(e.t0,e.t1)[e.t2]();case 11:if(n=(c=a.next()).done){e.next=17;break}u=c.value,t.add(u);case 14:n=!0,e.next=11;break;case 17:e.next=23;break;case 19:e.prev=19,e.t3=e["catch"](4),o=!0,i=e.t3;case 23:e.prev=23,e.prev=24,!n&&a["return"]&&a["return"]();case 26:if(e.prev=26,!o){e.next=29;break}throw i;case 29:return e.finish(26);case 30:return e.finish(23);case 31:for(s=!0,l=!1,d=void 0,e.prev=34,f=I.keys()[Symbol.iterator]();!(s=(p=f.next()).done);s=!0)h=p.value,t.add(h);e.next=42;break;case 38:e.prev=38,e.t4=e["catch"](34),l=!0,d=e.t4;case 42:e.prev=42,e.prev=43,!s&&f["return"]&&f["return"]();case 45:if(e.prev=45,!l){e.next=48;break}throw d;case 48:return e.finish(45);case 49:return e.finish(42);case 50:for(g=!0,m=!1,v=void 0,e.prev=53,b=t[Symbol.iterator]();!(g=(y=b.next()).done);g=!0)w=y.value,k(w);e.next=61;break;case 57:e.prev=57,e.t5=e["catch"](53),m=!0,v=e.t5;case 61:e.prev=61,e.prev=62,!g&&b["return"]&&b["return"]();case 64:if(e.prev=64,!m){e.next=67;break}throw v;case 67:return e.finish(64);case 68:return e.finish(61);case 69:case"end":return e.stop()}},e,this,[[4,19,23,31],[24,,26,30],[34,38,42,50],[43,,45,49],[53,57,61,69],[62,,64,68]])}))};var L=l.wrap(regeneratorRuntime.mark(function U(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(w()){t.next=2;break}return t.abrupt("return");case 2:return u.info("Removing synced files before account change."),e=[],t.t0=angular,t.next=7,r.listFiles();case 7:return t.t1=t.sent,t.t2=function(t){t.driveInfo&&e.push(g(t.id))},t.t0.forEach.call(t.t0,t.t1,t.t2),t.next=12,a.all(e);case 12:case"end":return t.stop()}},U,this)}));return T.requestSyncLocal=function(e){if(!w())return a.when();var t=I.get(e)||R(t,e);return t.timestamp=Date.now(),k(e),t.deferred.promise},T.storeAutoSharedFile=l.wrap(regeneratorRuntime.mark(function M(e){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,s.getFileDescriptor(e);case 2:return t=n.sent,n.next=5,s.updateLocalInfo(e,{autoShare:null});case 5:t.autoShare=null,k(e);case 7:case"end":return n.stop()}},M,this)})),T.syncFile=k,T.areAllLocalFilesSynced=E,T.install=function(){e.$on("uploader:complete",p),e.$on("driveFileWatcher:processed",m),e.$on("driveFileWatcher:removed",v),e.$on("bgFiles:localFileCreated",y),e.$on("bgFiles:fileRemoved",P),e.$on("bgFiles:syncSettingChanged",C),e.$on("bgSyncStatus:syncComplete",A),e.$on("event:signInChanged",_),T.syncFiles()},T}]),angular.module("castifyExt.bgSyncDownloader",["castifyExt.bgFiles","w69b.filesHelper","w69b.chromeRuntime","castifyExt.simplePortService","w69b.spawn"]).factory("fetchTool",["spawn","castifyAuth","filesHelper","$q",function(e,t,n,r){function o(e){return t.getAuthToken({interactive:!1}).then(function(t){e.headers.append("Authorization","Bearer "+t)})}function i(e,t){return new Promise(function(n,r){e.onwriteend=n,e.onerror=r,e.write(t)})}function a(t,a){function c(){return e(regeneratorRuntime.mark(function r(){var e,c,d,f,p,h;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return e=new Request(t),r.next=3,o(e);case 3:return r.next=5,n.getFileEntryByPath(a,{create:!0});case 5:return c=r.sent,r.next=8,n.getMetadata(c);case 8:return d=r.sent,e.headers.append("range","bytes = "+d.size+" -"),r.next=12,fetch(e,{mode:"cors"});case 12:if(f=r.sent,f.ok){r.next=15;break}throw new Error("fetch failed");case 15:if(!l){r.next=17;break}return r.abrupt("return");case 17:return u=f.body.getReader(),r.next=20,u.read();case 20:return p=r.sent,r.prev=21,s.bytesLoaded=d.size,r.next=25,n.createWriter(c);case 25:h=r.sent;case 26:if(p.done){r.next=35;break}return r.next=29,i(h,new Blob([p.value]));case 29:return s.bytesLoaded+=p.value.length,r.next=32,u.read();case 32:p=r.sent,r.next=26;break;case 35:r.next=41;break;case 37:throw r.prev=37,r.t0=r["catch"](21),u.cancel(),r.t0;case 41:case"end":return r.stop()}},r,this,[[21,37]])}),!0)}var u,s={},l=!1;return s.path=a,s.cancel=function(){u&&u.cancel(),l=!0},s.done=r.when(c()),s}return{downloadUrlToFile:a}}]).factory("bgSyncDownloader",["bgFiles","spawn","castifyAuth","$window","filesHelper","fetchTool","$log","$q","simplePortService",function(e,t,n,r,o,i,a,c,u){function s(){return o.getDirByPath(g,{create:!0})}function l(){return t(regeneratorRuntime.mark(function e(){var t,n,r,i,a,u,l,d;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s();case 2:return e.next=4,o.listByPath(g);case 4:for(t=e.sent,n=[],r=!0,i=!1,a=void 0,e.prev=9,u=t[Symbol.iterator]();!(r=(l=u.next()).done);r=!0)d=l.value,n.push(o.remove(d));e.next=17;break;case 13:e.prev=13,e.t0=e["catch"](9),i=!0,a=e.t0;case 17:e.prev=17,e.prev=18,!r&&u["return"]&&u["return"]();case 20:if(e.prev=20,!i){e.next=23;break}throw a;case 23:return e.finish(20);case 24:return e.finish(17);case 25:return e.next=27,c.all(n);case 27:case"end":return e.stop()}},e,this,[[9,13,17,25],[18,,20,24]])}))["catch"](function(e){a.error("bgSyncDownloader.cleanup failed",e)})}function d(n){function r(){return t(regeneratorRuntime.mark(function r(){var t;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,p;case 2:return r.next=4,e.getFileDescriptor(n);case 4:if(u=r.sent,!s){r.next=7;break}return r.abrupt("return");case 7:return t=g+"/"+u.id,c=i.downloadUrlToFile(u.url,t),r.next=11,c.done;case 11:return r.next=13,o.moveFileByPath(t,e.idToLocalFilename(u.id));case 13:return r.next=15,e.registerLocalFile(u.id);case 15:case"end":return r.stop()}},r,this)}))}var c,u,s=!1,l={get bytesLoaded(){return c?c.bytesLoaded:0},get progress(){return u&&u.size?l.bytesLoaded/u.size:0}};return l.cancel=function(){c&&c.cancel(),s=!0},l.done=r(),l.done["catch"](function(e){a.warn("bgSyncDownloader: download failed",e)}),l}function f(){var e={},t=!0,n=!1,r=void 0;try{for(var o,i=m.entries()[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var a=o.value,c=a[0],u=a[1];e[c]={progress:u.progress}}}catch(s){n=!0,r=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(n)throw r}}v.postMessage("downloads",e)}var p,h={},g="_dl",m=new Map,v=u("syncDownloader");return h.getDownload=function(e){return m.get(e)},h.startDownload=function(e){var t=m.get(e);return t||(a.debug("bgSyncDownloader.startDownload("+e+")"),t=d(e),m.set(e,t),f(),t.done["finally"](function(){m["delete"](e),f()})),t},h.install=function(){p=l(),v.install()},v.handlers.update=function(){f()},h}]),angular.module("castifyExt.offline",[]).factory("onlineState",["$rootScope","$window","$http","$timeout","$log",function(e,t,n,r,o){function i(){if(f)return f;var e=Math.random().toString(36).substr(2,36),t=u+e;return f=n.get(t,{responseType:"arraybuffer",timeout:s}).then(function(){return f=null,o.debug("checkNetwork result is online"),!0},function(){return o.debug("checkNetwork result is offline"),f=null,!1}),f.then(a),f}function a(t){p!==t&&(o.debug("verified network state is ",t),p=t,e.$broadcast("onlineState:changed",t)),!t&&d.isNavigatorOnline()&&c(!0)}function c(e){function t(){return h=r(angular.noop,l),h.then(n)}function n(){return i().then(function(e){if(!e&&d.isNavigatorOnline()&&g)return t()})}g||(g=!0,(e?t():n())["finally"](function(){g=!1}))}var u="https://www.screencastify.com/images/cleardot.gif?",s=1e4,l=1e4,d={},f=null,p=!0,h=null,g=!1;return d.check=function(){return i()},d.isOnline=function(){return p},d.isNavigatorOnline=function(){return t.navigator.onLine!==!1},t.addEventListener("online",function(){d.check()}),t.addEventListener("offline",function(){a(!1),r.cancel(h),g=!1}),d}]),angular.module("castifyExt.syncAuthTool",["castifyExt.castifyAuth","w69b.chromeRuntime","castifyExt.appOptions","castifyExt.driveUtils"]).factory("syncAuthTool",["castifyAuth","$http","$q","$log","appOptions","chromeRuntime","$rootScope","driveUtils",function(e,t,n,r,o,i,a,c){var u={};return u.broadcastIfSyncError=function(e){return"not_signed_in"===e?(r.debug("syncAuthTool: sync enabled but not signed in"),a.$broadcast("event:syncAuthError"),i.sendMessage({type:"event:syncAuthError"})["catch"](angular.identity),n.reject(e)):(o.values.driveSync&&u.checkSetup()["catch"](function(t){switch(t){case"token":r.debug("syncAuthTool: sync enabled but we do not have a valid token"),a.$broadcast("event:syncAuthError"),i.sendMessage({type:"event:syncAuthError"})["catch"](angular.identity);break;case"forbidden":r.debug("syncAuthTool: detected drive-forbidden error",e),a.$broadcast("event:syncForbiddenError");break;default:r.warn("syncAuthTool: unhandled sync error detected",e)}}),n.reject(e))},u.hasValidAuthToken=function(){return e.getAuthToken({interactive:!1,validate:!0})},u.isRateLimitError=function(e){return c.isRateLimitError(e)},u.checkSetup=function(){function e(){return c.getDriveUploadParentId()["catch"](function(e){return c.isGoogleAppsForbiddenError(e)?n.reject("forbidden"):n.reject("unknown")})}return u.hasValidAuthToken()["catch"](function(){return n.reject("token")}).then(e).then(function(){return!0})},u}]),angular.module("castifyExt.requestMicPermission",[]).factory("requestMicPermission",["$window","$q","$interval",function(e,t,n){return function(){var r=t.defer(),o=e.open("mic.html","mic",""),i=!1;o.clGotStream=function(){i=!0,r.resolve()};var a=n(function(){o.closed&&!i&&r.reject("closed mic permission window without granting permission")},200);return r.promise["finally"](function(){n.cancel(a)}),r.promise}}]),angular.module("castifyExt.bgSyncStatus",["castifyExt.bgFiles","castifyExt.bgUpload","castifyExt.syncAuthTool","castifyExt.bgSyncManager","w69b.throttle","w69b.chromeRuntime","w69b.spawn"]).factory("bgSyncStatus",["bgFiles","bgUploadService","$rootScope","$log","throttle","syncAuthTool","chromeRuntime","bgSyncManager","spawn",function(e,t,n,r,o,i,a,c,u){function s(e){if("syncStatus"==e.name){U.push(e),d(),e.onDisconnect.addListener(function(){var t=U.indexOf(e);t>=0&&U.splice(t,1)});var t={retry:I.retry};e.onMessage.addListener(function(e){t.hasOwnProperty(e.type)&&t[e.type](e.data)})}}function l(e,t){U.forEach(function(n){n.postMessage({type:e,data:t})})}function d(){l("stateUpdate",D)}function f(e){p({type:"synced",numTotalFiles:e}),d()}function p(e){e.type!==D.type&&(r.debug("syncStatus: changing state to ",e),"synced"===e.type&&"unknown"!==D.type&&n.$broadcast("bgSyncStatus:syncComplete")),D=e,"uploading"!==e.type&&(F={})}function h(){"uploading"!==D.type&&p({type:"uploading"});var e=0,t=0,n=0;angular.forEach(F,function(r){e+=r,++t,r>=1&&++n}),D.progress=e/t,D.numTotalFiles=t,D.numCompleteFiles=n,d()}function g(e){"waiting"!==D.type&&p({type:"waiting"}),D.numTotalFiles=e,d()}function m(e){"offline"!==D.type&&p({type:"offline"}),D.numTotalFiles=e,d()}function v(){c.areAllLocalFilesSynced()["catch"](function(){return!1}).then(function(e){e?(r.debug("syncStatus: treating auth error with no local files as synced"),f(0)):(p({type:"error",errorReason:"token"}),d())})}function b(){p({type:"error",errorReason:"forbidden"}),d()}function y(){var e=null,t=!0,n=!1,r=void 0;try{for(var o,i=L.values()[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var a=o.value;a&&(e=a)}}catch(c){n=!0,r=c}finally{try{!t&&i["return"]&&i["return"]()}finally{if(n)throw r}}p({type:"error",numTotalFiles:L.size,errorReason:e}),d()}function w(){i.checkSetup().then(y,function(e){"token"===e?v():"forbidden"===e?b():y()})}function x(e){var n=t.getTargetFileState(e,"drive");return n&&n.config.isSyncUpload?n:null}function S(e){var n=0,r=0;angular.forEach(e,function(e,t){F[t]=e&&e.progress||F[t]||0,e?"uploading"===e.state?++n:"queued"===e.state&&++r:r++}),n?h():r&&(t.isOnline()?g(r):m(r))}function E(){t.isOnline()?w():m(0)}function k(e,t){var n=t.config,o=t.error;n.isSyncUpload&&(r.debug("sync error detected",o),L.has(n.fileId)&&L["delete"](n.fileId),L.set(n.fileId,o&&o.reason),M())}function R(){return"error"==D.type}function C(){R()||v()}function A(){R()||b()}function _(){L.clear(),M()}function P(){p({type:"unknown"}),d(),$=n.$new(!0);var r=o(M,300,!0);$.$watchGroup([e.getListVersionId,t.getWatcherStateId,t.isOnline],function(){r()}),$.$on("uploader:failed",k),$.$on("event:syncAuthError",C),$.$on("event:syncForbiddenError",A),$.$on("event:userAccountChanged",_)}function T(){$&&$.$destroy(),$=null,p({type:"disabled"}),d()}var I={},$=null,D={type:"unknown"},F={},L=new Map,U=[],M=u.wrap(regeneratorRuntime.mark(function j(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!(L.size>0)){t.next=3;break}return E(),t.abrupt("return");case 3:return t.next=5,c.areAllLocalFilesSynced()["catch"](function(){return!1});case 5:if(!t.sent){t.next=8;break}return f(0),t.abrupt("return");case 8:e.listFiles().then(function(e){if($){var t={},n=!1,r=0;angular.forEach(e,function(e){e.autoShare||(e.isSynced?F.hasOwnProperty(e.id)&&(F[e.id]=1):(t[e.id]=x(e.id),n=!0),++r)}),angular.forEach(F,function(t,n){e[n]||delete F[n]}),n?S(t):f(r)}},function(e){r.debug("syncStatus list err",e),i.isRateLimitError(e)||E()});case 9:case"end":return t.stop()}},j,this)}));return I.retry=function(){L.clear(),c.syncFiles()},I.getState=function(){return D},I.install=function(){n.$watch(e.isSyncEnabled,function(e){e?P():T()}),a.onConnect.addListener(s)},I}]),angular.module("castifyExt.syncNotifications",["castifyExt.bgSyncStatus","w69b.throttle","w69b.chromeNotifications","castifyExt.ui.openInAppTab","castifyExt.appOptions","w69b.promiseTool","castifyExt.helpCenter"]).factory("syncNotifications",["$rootScope","bgSyncStatus","$log","throttle","chromeNotifications","$q","openInAppTab","appOptions","helpCenter","promiseTool",function(e,t,n,r,o,i,a,c,u,s){function l(e,t){x(function(){e=y+e;var n,r=!w;return w&&w!==e?(n=o.clear(w),r=!0):n=i.when(),t=angular.extend({type:"basic",priority:0,eventTime:Date.now(),isClickable:!1,title:"Saving on Drive",iconUrl:"images/icon128.png"},t),w=e,r?n.then(function(){return o.create(e,t)}):n.then(function(){return o.update(e,t)})})}function d(e){c.values.notifySyncProgress&&l("progress",{type:"progress",priority:0,message:"Your recording(s) are being saved "+e.numCompleteFiles+" / "+e.numTotalFiles,progress:Math.floor(100*e.progress)})}function f(e){c.values.notifySyncProgress&&l("waiting",{priority:0,message:e.numTotalFiles+" recording(s) are waiting to get saved on Drive."})}function p(e){l("offline",{title:"You are offline",priority:1,message:e.numTotalFiles+" recording(s) are not saved on Drive yet."})}function h(e){"token"===e.errorReason?l("auth",{priority:2,title:"Drive Authentication Problem",message:"Screencastify cannot save to Drive.",buttons:[{title:"Sign In"}]}):"forbidden"===e.errorReason?l("forbidden",{priority:2,title:"Drive Access Problem",message:"Drive API/Apps are disabled for your domain.",buttons:[{title:"Help"}]}):"quotaExceeded"===e.errorReason?l("quotaExceeded",{priority:2,title:"Out of Drive storage space",message:"You have reached your storage limit on Drive. Screencastify cannot store save to Drive anymore.",buttons:[{title:"Help"}]}):l("error",{priority:2,title:"Failed to save recordings on Drive.",message:"We failed to save "+e.numTotalFiles>0?e.numTotalFiles:"some recording(s) on Drive. Please contact support if this problem persists.",buttons:[{title:"Retry"}]})}function g(){x(function(){if(w){var e=o.clear(w);return w=null,e}})}function m(e,n){function r(t,r){return e===y+t&&n===(r||0)}r("error")?t.retry():r("auth")?a("#/setup/"):r("forbidden")?u.openHelp("drive_apps"):r("quotaExceeded")&&u.openHelp("quotaExceeded")}function v(){var e=t.getState(),n=S[e.type];n&&n(e)}var b={},y="sync_state_",w=null,x=s.serializer(),S={uploading:d,waiting:f,offline:p,error:h,synced:g,disabled:g};return b.install=function(){t.install();var n=r(v,1e3,!1);e.$watchCollection(t.getState,function(){n()}),o.onButtonClicked.addListener(m)},b}]),angular.module("castifyExt.youtubeAuth",["w69b.uritool","castifyExt.castifyAuth"]).provider("youtubeAuth",function(){var e,t=["https://www.googleapis.com/auth/youtube"];this.setScopes=function(e){t=e},this.setClientId=function(t){e=t},this.$get=["castifyAuth","$log","uritool","$q","$http","castifyConfig",function(n,r,o,i,a,c){function u(e){return m+"?"+o.encodeQuery(e)}function s(e){return e.data}function l(){return n.getRedirectURL().then(function(o){var a={redirect_uri:o,scope:t.join(" "),response_type:"code",client_id:e,access_type:"offline",include_granted_scopes:!1,prompt:"select_account consent"},c=u(a),s={url:c,interactive:!0};return n.launchWebAuthFlow(s).then(function(e){return r.debug("youtube oauth result",e),e.code?e.code:i.reject("youtube_flow_returned_no_code")})})}function d(e){return a.post(h,{code:e,version:2
},{googleAuth:!0}).then(s,function(e){return r.warn("adding youtube code failed",e),i.reject("youtube_add_code_failed")})}function f(e){return a.get(g+"/"+e,{googleAuth:!0}).then(s).then(function(e){return e.expiresAt=Number(new Date(e.expiresAt)),e.issuedAt=Number(new Date(e.issuedAt)),e})}var p=c.API_URL+"/youtube/",h=p+"channels",g=p+"tokens",m="https://accounts.google.com/o/oauth2/auth",v={},b=0,y={};return y.addChannel=function(){return n.getAuthToken({interactive:!0}).then(l).then(d)},y.listChannels=function(){return a.get(h,{googleAuth:!0}).then(s)},y.removeChannel=function(e){return a["delete"](h+"/"+e,{googleAuth:!0}).then(s)},y.getAuthToken=function(e){if(!e.channelId)throw new Error;var t,n=e.channelId,r=Math.floor(Date.now()-b)+12e4,o=v[n];return o&&o.expiresAt>r?t=i.when(o):(t=f(n),t.then(function(e){v[n]=e,e.issuedAt&&(b=Date.now()-Number(e.issuedAt))})),t.then(function(e){return e.accessToken})},y}]}).factory("youtubeHttpAuthInterceptor",["$q","$injector","$log",function(e,t,n){function r(e){var t={channelId:e};return i().getAuthToken(t)}function o(e){return{Authorization:"Bearer "+e}}function i(){return a||(a=t.get("youtubeAuth")),a}var a;return{request:function(t){return t.youtubeAuth?(t.googleAuth&&delete t.googleAuth,r(t.youtubeAuth).then(function(e){return t.headers=angular.extend(t.headers||{},o(e)),t},function(t){return n.warn("youtubeAuth failed",t),e.reject("youtubeAuth failed")})):t}}}]),angular.module("castifyExt.enterprisePolicy",["w69b.chromeStorage"]).provider("enterprisePolicy",function(){var e={};this.setOverride=function(t){e=t},this.$get=["chromeStorage","$rootScope",function(t,n){var r={},o=!1,i={options:{}};angular.extend(i,e);var a=["disableSharing","disableSaveToDisk","options"];return a.forEach(function(e){Object.defineProperty(r,e,{get:function(){return i[e]}})}),r.loadedPromise=t.managed.get(a).then(function(t){angular.extend(i,t,e),o=!0}),r.isLoaded=function(){return o},r.has=function(e){return i.hasOwnProperty(e)},r.get=function(e){return i[e]},t.onChanged.addListener(function(e,t){"managed"===t&&(angular.forEach(e,function(e,t){i[t]=e.newValue}),n.$$phase||n.$digest())}),r}]}),angular.module("castifyExt.crashReporter",["w69b.chromePersistentLogger","w69b.chromeRuntime"]).factory("crashReporter",["castifyConfig","chromeRuntime","$http","chromePersistentLogger",function(e,t,n,r){function o(){return t.getManifest().version}function i(){return r.save().then(function(){return r.getMergedLogs(["popup","background","app"])})}var a=e.API_URL+"/crash",c={};return c.report=function(e,t){i().then(function(r){return n.post(a,{module:e,version:o(),logs:r.join("\n"),core:t})})},c}]),angular.module("castifyExt.helpCenter",["w69b.chromeTabs"]).factory("helpCenter",["chromeTabs",function(e){var t={};return t.tagUrls={},t.registerUrl=function(e,n){t.tagUrls[e]=n},t.hasHelpFor=function(e){return t.tagUrls.hasOwnProperty(e)},t.openHelp=function(n){var r=t.tagUrls[n];if(!r)throw new Error("No help url registered for "+n);e.create({url:r})},t.setNotifyHelp=function(e,n){e.onButtonClicked=e.onClicked=function(){t.openHelp(n),e.clear()}},t}]),angular.module("castifyExt.helpCenterConfig",["castifyExt.helpCenter"]).run(["helpCenter",function(e){e.registerUrl("load_nacl","https://screencastify.helpscoutdocs.com/article/33-failed-to-load-nacl-module"),e.registerUrl("disk_space","https://screencastify.helpscoutdocs.com/article/32-out-of-disk-space"),e.registerUrl("drive_apps","https://screencastify.helpscoutdocs.com/article/34-enabling-drive-on-google-apps"),e.registerUrl("start_recording","https://screencastify.helpscoutdocs.com/article/35-failed-to-start-recording"),e.registerUrl("change_account","https://screencastify.helpscoutdocs.com/article/31-how-to-sign-in-with-a-different-account"),e.registerUrl("quotaExceeded","https://screencastify.helpscoutdocs.com/article/20-out-of-space-on-google-drive"),e.registerUrl("youtubeSignupRequired","https://screencastify.helpscoutdocs.com/article/24-youtubesignuprequired-error-when-uploading-to-youtube"),e.registerUrl("no_audio","https://screencastify.helpscoutdocs.com/article/82-failed-to-capture-audio"),e.registerUrl("no_cam","https://screencastify.helpscoutdocs.com/article/83-failed-to-access-your-webcam"),e.registerUrl("trial_monthly_limit","https://www.screencastify.com/buy?utm_source=app&utm_content=notify&utm_campaign=monthly_limit")}]),angular.module("castifyExt.oauthTokenCache",["w69b.chromeStorage"]).factory("oauthTokenCache",["chromeStorage","$q",function(e,t){function n(n){function r(){return e.local.getSingle(n).then(function(e){return e||{}})}function o(e){var t=i();angular.forEach(e,function(n,r){(!r.expiresAt||r.expiresAt<=t)&&delete e[n]})}function i(){return Math.floor(Date.now()-a)+12e4}var a=0,c={};return c.get=function(e){return r().then(function(n){var r=n[e];return r&&r.expiresAt>i()?t.when(r):t.reject()})},c.put=function(t,i){return r().then(function(r){return r[t]=i,i.issuedAt&&(a=Date.now()-Number(i.issuedAt)),o(r),e.local.setSingle(n,r)})},c.removeByToken=function(t){return r().then(function(r){return angular.forEach(r,function(e,n){e.accessToken===t&&delete r[n]}),e.local.setSingle(n,r)})},c.remove=function(t){return r().then(function(r){return delete r[t],e.local.setSingle(n,r)})},c.clear=function(){return e.local.remove(n)},c.withCache=function(e,t){return c.get(e)["catch"](function(){return t().then(function(t){return c.put(e,t).then(function(){return t})})})},c}return n}]),angular.module("castifyExt.castifyAuth",["castifyExt.simpleBgServiceConsumer"]).factory("castifyAuth",["simpleBgServiceConsumer",function(e){return e("castifyAuth",["launchWebAuthFlow","getRedirectURL","removeCachedAuthToken","getAuthToken","getAccount"])}]).factory("googleauth",["castifyAuth","$q",function(e,t){var n={};return n.loadClient=function(){return t.when()},n.getAuthToken=function(t){e.getAuthToken(angular.isObject(t)?t:{interactive:!!t})},n}]),angular.module("castifyExt.bgCastifyAuth",["w69b.chromeStorage","w69b.uritool","w69b.es6","w69b.chromeRuntime","w69b.uuid","w69b.promiseTool","castifyExt.oauthTokenCache","w69b.spawn","w69b.chromeNotifications","castifyExt.helpCenter","castifyExt.simpleBgServicePublisher","castifyExt.castifyAuth"]).provider("bgCastifyAuth",function(){var e,t=[],n="";this.setScopes=function(e){t=e},this.setClientId=function(t){e=t},this.setRedirectUri=function(e){n=e},this.$get=["$q","uritool","$rootElement","$window","chromeRuntime","$interval","castifyConfig","$http","chromeStorage","oauthTokenCache","uuid","promiseTool","$log","$rootScope","spawn","chromeNotifications","helpCenter","simpleBgServicePublisher",function(r,o,i,a,c,u,s,l,d,f,p,h,g,m,v,b,y,w){function x(e){return l.get(M,{params:{access_token:e}})}function S(e){return x(e.accessToken).then(function(){return!0},function(e){return 400!==e.status})}function E(t){return t=angular.extend({redirect_uri:n,response_type:"code",client_id:e,access_type:"offline",include_granted_scopes:"true"},t),U+"?"+o.encodeQuery(t)}function k(e){var t=r.defer(),n=function(n){if("oauth2AuthResult"===n.type){var r=n.data,i=o.parseUrl(r),a=o.parseQuery((i.hash||i.query).substring(1));if(!a||a.state!==e)return;a.error?t.reject({error:a.error||"immediate_failed"}):t.resolve(a)}};return c.onMessageExternal.addListener(n),t.promise["finally"](function(){c.onMessageExternal.removeListener(n)}),t}function R(e){e.expiresAt=Number(new Date(e.expiresAt)),e.issuedAt=Number(new Date(e.issuedAt))}function C(e){return v(regeneratorRuntime.mark(function t(){var n,r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,l.post(j,{code:e},{headers:{"x-castify-version":c.getManifest().version}})["catch"]($);case 2:return n=t.sent,r=n.data,R(r.token),t.abrupt("return",r);case 6:case"end":return t.stop()}},t,this)}))}function A(e,t){var n=a.open(e),r=!1,o=k(t);o.promise.then(function(){r=!0});var i=u(function(){n.closed&&!r&&(g.debug("castifyAuth: user closed oauth window"),o.reject("auth_window_closed"))},200),c=h.withTimeout(function(){return o.promise},9e4);return c["finally"](function(){u.cancel(i)}),c}function _(t){var n=p(),r={scope:t.scope,response_type:"code",client_id:e,access_type:"offline",state:n},o=[];t.email?r.login_hint=t.email:t.accountChooser&&o.push("select_account"),t.forceConsent&&o.push("consent"),r.prompt=o.join(" ");var i=E(r),a=A(i,n);return a.then(function(e){return e.code})}function P(e){function t(e){return _(e).then(C)}var n=t(e)["catch"](function(n){return n&&n.data&&"no_refresh_code"===n.data.error?t(angular.extend({},e,{forceConsent:!0})):r.reject(n)});return n}function T(e){return d.sync.getSingle(B,{}).then(function(t){return t[e]})}function I(e,t){var n={};return n[e]=t,d.sync.setSingle(B,n)}function $(e){return g.debug("castifyAuth: handling HTTP error",e),401===e.status?r.reject(W.NotSignedInError):e.status<=0||e.status>=500&&e.status<=599?r.reject(W.NetworkError):r.reject(e)}function D(e){return v(regeneratorRuntime.mark(function t(){var n,o,i,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,T(e.email);case 2:if(n=t.sent){t.next=5;break}return t.abrupt("return",r.reject(W.NotSignedInError));case 5:return o=null,e.scope&&(o=e.scope.split(" ")),t.next=9,l.get(j,{headers:{Authorization:n,"x-castify-version":c.getManifest().version},params:{scopes:o}})["catch"]($)["catch"](function(t){return t===W.NotSignedInError?I(e.email,null).then(function(){return r.reject(t)}):r.reject(t)});case 9:return i=t.sent,a=i.data,R(a.token),t.abrupt("return",a);case 13:case"end":return t.stop()}},t,this)}))}function F(){return null}function L(){m.$broadcast("event:signInChanged"),c.sendMessage({type:"event:signInChanged"})}var U="https://accounts.google.com/o/oauth2/auth",M="https://www.googleapis.com/oauth2/v1/tokeninfo",j=s.API_URL+"/client_auth",O="castifyAuth:account",q="castifyAuth:cache",B="castifyAuth:clientToken",N=f(q),V=h.serializer(),W={};return W.NotSignedInError="not_signed_in",W.NetworkError="network_error",W.getAccount=function(){return d.local.getSingle(O).then(function(e){return e?e:null})},W.setAccount=function(e){return d.local.setSingle(O,e)},W.getAuthToken=function(e){function n(e){return e+":"+u.scope}function o(t){return v(regeneratorRuntime.mark(function r(){var o,i,a;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return u.email=t,o=n(t),r.next=4,N.get(o)["catch"](F);case 4:if(i=r.sent,r.t0=i&&e.validate,!r.t0){r.next=10;break}return r.next=9,S(i);case 9:r.t0=!r.sent;case 10:if(!r.t0){r.next=13;break}i=null,N.remove(o);case 13:if(!i){r.next=15;break}return r.abrupt("return",{token:i});case 15:return r.prev=15,r.next=18,D(u);case 18:a=r.sent,r.next=31;break;case 21:if(r.prev=21,r.t1=r["catch"](15),!e.interactive){r.next=30;break}return r.next=26,P(u);case 26:a=r.sent,s=!0,r.next=31;break;case 30:throw r.t1;case 31:return r.next=33,N.put(o,a.token);case 33:return r.abrupt("return",a);case 34:case"end":return r.stop()}},r,this,[[15,21]])}))}function i(){return e.interactive?v(regeneratorRuntime.mark(function t(){var e,o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,P(u);case 2:return e=t.sent,s=!0,o=e.token,t.next=7,r.all([N.put(n(o.email),o),W.setAccount(o.email)]);case 7:return t.abrupt("return",e);case 8:case"end":return t.stop()}},t,this)})):r.reject(W.NotSignedInError)}function a(){return"select_account"===e.interactive?r.reject():W.getAccount()}function c(){var e=v(regeneratorRuntime.mark(function t(){var e,n,r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,a()["catch"](F);case 2:if(e=t.sent,!e){t.next=9;break}return t.next=6,o(e);case 6:n=t.sent,t.next=12;break;case 9:return t.next=11,i();case 11:n=t.sent;case 12:if(r=n.clientToken,!r){t.next=16;break}return t.next=16,I(e||n.token.email,r);case 16:return s&&L(),t.abrupt("return",n.token.accessToken);case 18:case"end":return t.stop()}},t,this)}));return e["catch"](function(e){e===W.NotSignedInError&&m.$broadcast("castifyAuth:notSignedIn")}),e}e=angular.extend({interactive:!1,scopes:t},e),e.scopes||(e.scopes=t);var u={accountChooser:"select_account"===e.interactive,scope:e.scopes.join(" ")},s=!1;return V(c)},W.removeCachedAuthToken=function(e){return N.removeByToken(e.token)},W.launchWebAuthFlow=function(e){return e.interactive?A(e.url,e.state):A(e.url,e.state)},W.getRedirectURL=function(){return r.when(n)},W.signOut=function(){return r.all([d.sync.remove(B),N.clear(),d.sync.remove(O)]).then(function(){return null})},W.install=function(){w("castifyAuth",W,["install"])},W}]}).factory("castifyAuth",["bgCastifyAuth",function(e){return e}]),angular.module("castifyExt.branding",["castifyExt.userAccount","w69b.filesHelper","w69b.spawn"]).factory("branding",["userAccount","$http","filesHelper","spawn","$log",function(e,t,n,r,o){function i(){return n.getDirByPath(c,{create:!0})}var a="/images/branding.png",c="_branding",u=c+"/_branding.png",s={};return s.getFilename=function(){return r(regeneratorRuntime.mark(function c(){var r,s,l,d,f;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.prev=0,c.next=3,e.getAccount();case 3:if(r=c.sent.license,r.branding){c.next=6;break}return c.abrupt("return",null);case 6:return c.next=8,i();case 8:return c.next=10,n.getFileEntryByPath(u,{create:!0});case 10:return s=c.sent,c.next=13,n.getMetadata(s);case 13:if(l=c.sent,l.size){c.next=23;break}return c.next=17,n.createWriter(s);case 17:return d=c.sent,c.next=20,t.get(a,{responseType:"blob"});case 20:return f=c.sent,c.next=23,n.writeFile(d,f.data);case 23:return c.abrupt("return",u);case 26:return c.prev=26,c.t0=c["catch"](0),o.error("failed to prepare branding file",c.t0),c.abrupt("return",null);case 30:case"end":return c.stop()}},c,this,[[0,26]])}))},s}]),angular.module("castifyExt.simpleBgServicePublisher",["w69b.chromeRuntime"]).factory("simpleBgServicePublisher",["chromeRuntime","$q","$log",function(e,t,n){function r(r,o,i){function a(e,i,a){var c=function(e){try{a(e)}catch(t){}};if(e&&"simpleService"===e.type&&e.service===r&&o.hasOwnProperty(e.fn)&&!u[e.fn]){var s=t.when(o[e.fn].apply(o,e.data));return s.then(function(e){c({data:e})},function(t){n.debug("simpleService("+r+")."+e.fn+" failed : ",t),c({error:t})}),!0}return!1}function c(){e.onMessage.removeListener(a)}var u={};return(i||[]).forEach(function(e){u[e]=!0}),e.onMessage.addListener(a),c}return r}]),angular.module("castifyExt.simpleBgServiceConsumer",["w69b.chromeRuntime"]).factory("simpleBgServiceConsumer",["chromeRuntime","$q",function(e,t){function n(n,r){function o(e){return e.error?t.reject(e.error):e.data}function i(t){return function(){return e.sendMessage({type:"simpleService",fn:t,service:n,data:Array.prototype.concat.apply([],arguments)}).then(o)}}var a={};return r.forEach(function(e){a[e]=i(e)}),a}return n}]),angular.module("castifyExt.simplePortService",["w69b.chromeRuntime"]).factory("simplePortService",["chromeRuntime",function(e){function t(t){function n(e){e.name===t&&(r.add(e),e.onDisconnect.addListener(function(){r["delete"](e)}),e.onMessage.addListener(function(e){o.handlers.hasOwnProperty(e.type)&&o.handlers[e.type](e.data)}))}var r=new Set,o={handlers:{}};return o.postMessage=function(e,t){var n=!0,o=!1,i=void 0;try{for(var a,c=r[Symbol.iterator]();!(n=(a=c.next()).done);n=!0){var u=a.value;u.postMessage({type:e,data:t})}}catch(s){o=!0,i=s}finally{try{!n&&c["return"]&&c["return"]()}finally{if(o)throw i}}},o.install=function(){e.onConnect.addListener(n)},o}return t}]),angular.module("castifyExt.connect.connectedApps",["w69b.chromeStorage","w69b.spawn","castifyExt.connect.appRegistry"]).factory("connectedApps",["chromeStorage","spawn","appRegistry","$rootScope",function(e,t,n,r){function o(){return e.sync.getSingle(l,[]).then(function(e){return e.map(function(e){return angular.isObject(e)?e:{id:e,hasShareUrl:!0}})})}function i(t){return e.sync.setSingle(l,t)}function a(){return e.sync.getSingle(d)}function c(t){return e.sync.setSingle(d,t)}function u(e,t){return e.some(function(e){return e.id===t})}var s={},l="connectedAppIds",d="connectedAppRecentId";s.getConnected=function(e){return t(regeneratorRuntime.mark(function n(){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,o();case 2:return t=n.sent,e&&(t=t.filter(function(t){var n=!0;return angular.forEach(e,function(e,r){n=n&&t[r]===e}),n})),n.abrupt("return",t.map(function(e){return e.id}));case 5:case"end":return n.stop()}},n,this)}))},s.getConnectedAppInfo=t.wrap(regeneratorRuntime.mark(function p(){var e,t;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,o();case 2:return e=r.sent,r.next=5,n.getApps(e.map(function(e){return e.id}));case 5:return t=r.sent,t=angular.copy(t),t.forEach(function(t){var n=e.find(function(e){return e.id===t.id});angular.extend(t,n)}),r.abrupt("return",t);case 9:case"end":return r.stop()}},p,this)})),s.getConnectedAppInfoForApp=t.wrap(regeneratorRuntime.mark(function h(e){var t,n;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,s.getConnectedAppInfo();case 2:if(t=r.sent,n=t.find(function(t){return t.id===e})){r.next=6;break}return r.abrupt("return",null);case 6:return r.abrupt("return",n);case 7:case"end":return r.stop()}},h,this)})),s.isConnected=function(e){return t(regeneratorRuntime.mark(function n(){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,o();case 2:return t=n.sent,n.abrupt("return",u(t,e));case 4:case"end":return n.stop()}},n,this)}))},s.disconnect=function(e){return t(regeneratorRuntime.mark(function n(){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,o();case 2:return t=n.sent,t=t.filter(function(t){return t.id!==e}),n.next=6,c(null);case 6:return n.next=8,i(t);case 8:r.$broadcast("connect:appDisconnected",e);case 9:case"end":return n.stop()}},n,this)}))},s.connect=function(e){return t(regeneratorRuntime.mark(function a(){var t,s;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,o();case 2:return t=a.sent,a.next=5,n.getAppInfo(e);case 5:if(s=a.sent,u(t,e)){a.next=11;break}if(t.push({id:e,hasShareUrl:!!s.shareUrl}),!s.shareUrl){a.next=11;break}return a.next=11,c(e);case 11:return a.next=13,i(t);case 13:r.$broadcast("connect:appConnected",e,s);case 14:case"end":return a.stop()}},a,this)}))};var f=t.wrap(regeneratorRuntime.mark(function g(e,t,n){var r,a,c;return regeneratorRuntime.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return u.next=2,o();case 2:if(r=u.sent,a=r.find(function(t){return t.id===e})){u.next=6;break}throw new Error("Cannot set user data for non-connected app");case 6:return c=a[t],null===n||angular.isUndefined(n)?delete a[t]:a[t]=n,u.next=10,i(r);case 10:return u.abrupt("return",c);case 11:case"end":return u.stop()}},g,this)}));return s.setUserExpiryDate=t.wrap(regeneratorRuntime.mark(function m(e,t){var n;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,f(e,"userExpiryDate",t);case 2:n=o.sent,r.$broadcast("connect:userExpiryDateChange",n,t);case 4:case"end":return o.stop()}},m,this)})),s.setUserShareUrl=function(e,t){return f(e,"shareUrl",t)},s.clearRecent=function(){return c(null)},s.getRecent=function(){return a()},s}]),angular.module("castifyExt.connect.bgConnectService",["castifyExt.connect.appPermissions","castifyExt.connect.connectedApps","castifyExt.connect.appRecorder","castifyExt.simpleBgServicePublisher","castifyExt.bgSyncManager","castifyExt.bgFiles","w69b.chromeTabs","w69b.chromeWindows","w69b.asyncResponse","w69b.chromeRuntime","w69b.spawn","w69b.uritool","w69b.promiseTool"]).factory("bgConnectService",["connectedApps","appPermissions","$q","chromeTabs","spawn","uritool","simpleBgServicePublisher","chromeRuntime","asyncResponse","$log","chromeWindows","promiseTool","bgSyncManager","appRecorder","bgFiles",function(e,t,n,r,o,i,a,c,u,s,l,d,f,p,h){function g(e){var t="app.html#/files/"+encodeURIComponent(e);return r.create({url:t})}function m(e,t){return o(regeneratorRuntime.mark(function n(){var o,i,a,c,u,f,p,h,g,m,v,b;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:o=function(e){return d.withTimeout(function(){return e.sendWithResponse("shareFiles",t)},k)},i=!0,a=!1,c=void 0,n.prev=4,u=S.entries()[Symbol.iterator]();case 6:if(i=(f=u.next()).done){n.next=32;break}if(p=f.value,h=p[0],g=p[1],g.app.id===e){n.next=12;break}return n.abrupt("continue",29);case 12:return m=g.sender,n.prev=13,n.next=16,o(m);case 16:v=n.sent,n.next=23;break;case 19:n.prev=19,n.t0=n["catch"](13),s.debug("connect: shareFiles handler rejected with",n.t0),v=!1;case 23:if(!v){n.next=29;break}return b=h.sender.tab,s.debug("connect: shareFiles handled directly, focusing",b),r.update(b.id,{active:!0}),l.update(b.windowId,{focused:!0}),n.abrupt("return",!0);case 29:i=!0,n.next=6;break;case 32:n.next=38;break;case 34:n.prev=34,n.t1=n["catch"](4),a=!0,c=n.t1;case 38:n.prev=38,n.prev=39,!i&&u["return"]&&u["return"]();case 41:if(n.prev=41,!a){n.next=44;break}throw c;case 44:return n.finish(41);case 45:return n.finish(38);case 46:return n.abrupt("return",!1);case 47:case"end":return n.stop()}},n,this,[[4,34,38,46],[13,19],[39,,41,45]])}))}function v(e,t,n){var r=!0,o=!1,i=void 0;try{for(var a,c=S.values()[Symbol.iterator]();!(r=(a=c.next()).done);r=!0){var u=a.value;u.app.id===t&&u.sender.send(e,n)}}catch(s){o=!0,i=s}finally{try{!r&&c["return"]&&c["return"]()}finally{if(o)throw i}}}function b(e){var t=!0,n=!1,r=void 0;try{for(var o,i=S.values()[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var a=o.value;if(a.app.id===e)return!0}}catch(c){n=!0,r=c}finally{try{!t&&i["return"]&&i["return"]()}finally{if(n)throw r}}return!1}function y(e){return E&&E.appId===e.id}function w(e){"connectFrame"===e.name&&e.onMessage.addListener(function t(n){if("connect"===n.type){var r=n.data,o=u.createSender(function(t){e.postMessage(t)}),i=u.createRespond(e.postMessage.bind(e));e.onMessage.addListener(function(t){if(!o.handleResult(t)&&A.hasOwnProperty(t.type)){var n=A[t.type](r,t.data,e.sender);i(n,t)}}),e.onDisconnect.addListener(function(){var t=S.get(e);t&&y(t.app)&&(s.debug("connect: cancelling start due to port disconnect"),E.cancelPendingStart()),S["delete"](e)}),S.set(e,{app:r,sender:o}),e.onMessage.removeListener(t)}})}var x={},S=new Map,E=null,k=5e3,R="busy",C="access_denied";x.share=function(a,c,u){return o(regeneratorRuntime.mark(function l(){var o,d,p,h,g;return regeneratorRuntime.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,f.requestSyncLocal(c);case 2:if(o=t.allowAccess(a,c),u){l.next=11;break}return l.next=6,e.getConnectedAppInfoForApp(a);case 6:if(d=l.sent,u=d&&d.shareUrl){l.next=11;break}return s.warn("connect.share() called for app without shareUrl",d),l.abrupt("return",n.reject("no_share_url"));case 11:return l.next=13,o;case 13:return p=[c],l.next=16,m(a,p);case 16:if(!l.sent){l.next=18;break}return l.abrupt("return");case 18:return h=JSON.stringify({ids:p}),g=u+"?"+i.encodeQuery({state:h}),l.abrupt("return",r.create({url:g}));case 21:case"end":return l.stop()}},l,this)}))};var A={};return A.startRecording=function(e,t,r){return o(regeneratorRuntime.mark(function i(){return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(t=t||{},s.debug("connect: startRecording",e,t),!E||E.appId===e.id){o.next=4;break}return o.abrupt("return",n.reject(R));case 4:if(o.t0=E,!o.t0){o.next=9;break}return o.next=8,E.cancelPendingStart();case 8:o.t0=!o.sent;case 9:if(!o.t0){o.next=12;break}return s.debug("connect: could not cancel pending start"),o.abrupt("return",n.reject(R));case 12:if(!E&&b(e.id)){o.next=14;break}return o.abrupt("return",n.reject(R));case 14:return E=p(e),E.ended.then(function(){v("recordingStateChanged",e.id,"inactive"),E=null}),E.onStateChanged=function(t){v("recordingStateChanged",e.id,t)},E.onTimeChanged=function(t){v("recordingTimeChanged",e.id,t)},t.tabId=r.tab.id,o.abrupt("return",E.start(t));case 20:case"end":return o.stop()}},i,this)}))},A.stopRecording=function(e){return y(e)?E.stop():n.reject(R)},A.pauseRecording=function(e){return y(e)?E.pause():n.reject(R)},A.resumeRecording=function(e){return y(e)?E.resume():n.reject(R)},A.getRecordingState=function(e){return y(e)?E.getState():"inactive"},A.getRecordingTime=function(e){return y(e)?E.getTime():0},A.storeFileInLibrary=o.wrap(regeneratorRuntime.mark(function _(e,r){var o,i;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return r=r||{},o=r.fileId,a.next=4,t.hasAccess(e.id,o);case 4:if(a.sent){a.next=6;break}return a.abrupt("return",n.reject(C));case 6:return a.next=8,h.getFileDescriptor(o);case 8:if(i=a.sent,i.autoShare){a.next=11;break}return a.abrupt("return",n.reject("file is already stored in library"));case 11:return a.next=13,f.storeAutoSharedFile(o);case 13:if(!r.openFile){a.next=16;break}return a.next=16,g(o);case 16:case"end":return a.stop()}},_,this)})),x.install=function(){c.onConnect.addListener(w),a("connect",x,["install"])},x}]),angular.module("castifyExt.connect.appRegistry",["w69b.spawn","w69b.chromeStorage"]).factory("appRegistry",["castifyConfig","$http","$q","spawn","chromeStorage",function(e,t,n,r,o){function i(){return o.local.getSingle(h,[])}function a(e){return o.local.setSingle(h,e)}function c(e){return i().then(function(t){return t.filter(function(t){return e.includes(t.id)})})}function u(e,t){var n=Date.now(),r=e.some(function(e){return n>e._fetchTimestamp+g});return!r&&t.length===e.length}function s(e){return e.forEach(function(e){delete e._fetchTimestamp}),e}function l(e,t){return r(regeneratorRuntime.mark(function n(){var r;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return e=new Set(e||[]),n.next=3,i();case 3:return r=n.sent,t.forEach(function(t){e.add(t.id)}),r=r.filter(function(t){return!e.has(t.id)}),t.forEach(function(e){e._fetchTimestamp=Date.now()}),r=r.concat(t),n.next=10,a(r);case 10:case"end":return n.stop()}},n,this)}))}function d(e){return r(regeneratorRuntime.mark(function o(){var r,i,a;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(e&&0!==e.length){o.next=2;break}return o.abrupt("return",n.when([]));case 2:return o.next=4,c(e);case 4:if(i=o.sent,!u(i,e)){o.next=7;break}return o.abrupt("return",s(i));case 7:return o.prev=7,o.next=10,t.get(f,{params:{ids:e}});case 10:a=o.sent,r=a.data,o.next=17;break;case 14:return o.prev=14,o.t0=o["catch"](7),o.abrupt("return",s(i));case 17:return o.next=19,l(e,r);case 19:return o.abrupt("return",s(r));case 20:case"end":return o.stop()}},o,this,[[7,14]])}))}var f=e.API_URL+"/apps",p={},h="appRegistry:cache",g=6e4;return p.getApps=function(e){return d(e)},p.getAppInfo=function(e){return d([e]).then(function(e){return e.length?e[0]:n.reject()})},p}]),angular.module("castifyExt.connect.appPermissions",["w69b.chromeStorage","w69b.spawn"]).factory("appPermissions",["chromeStorage","spawn",function(e,t){function n(e){var t=Date.now();return e.filter(function(e){return e.timeout>=t})}function r(){return e.local.getSingle(i,[]).then(n)}function o(t){return e.local.setSingle(i,t)}var i="appPermissions",a=18e5,c={};return c.hasAccess=function(e,t){return r().then(function(n){return n.some(function(n){return n.appId===e&&n.fileId===t})})},c.allowAccess=function(e,n){return t(regeneratorRuntime.mark(function i(){var t;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,r();case 2:return t=i.sent,t=t.filter(function(t){return t.appId!==e&&t.appId!==n}),t.push({appId:e,fileId:n,timeout:Date.now()+a}),i.next=7,o(t);case 7:case"end":return i.stop()}},i,this)}))},c}]),angular.module("castifyExt.connect.appRecorder",["castifyExt.bgRecord","castifyExt.recordTool","w69b.spawn"]).factory("appRecorder",["bgRecordService","recordTool","$q","$rootScope","spawn",function(e,t,n,r,o){function i(i){function f(){v.resolve()}function p(){var e=[];e.push(r.$watch(b.getState,function(e,t){e!==t&&b.onStateChanged&&b.onStateChanged(e)})),e.push(r.$watch(b.getTime,function(e,t){e!==t&&b.onTimeChanged&&b.onTimeChanged(e)})),b.ended.then(function(){e.forEach(function(e){e()})})}function h(e){return angular.isObject(e)&&g(e.width,a,c)&&g(e.height,a,c)}function g(e,t,n){return angular.isNumber(e)&&e>=t&&e<=n}function m(e){e.recordConfig=e.recordConfig||{};var t=e.recordConfig;if(!angular.isObject(t))throw new Error("invalid recordConfig");if(t.audio=t.audio||{},!angular.isObject(t.audio))throw new Error("invalid recordConfig.audio");if(t.captureSource=t.captureSource||"desktop",!["desktop","screen","tab"].includes(t.captureSource))throw new Error("invalid captureSource");if(t.maxResolution=t.maxResolution||null,t.maxResolution){if(!h(t.maxResolution))throw new Error("invalid maxResolution");t.maxResolution={width:t.maxResolution.width,height:t.maxResolution.height}}if(t.maxFps=t.maxFps||null,t.maxFps&&!g(t.maxFps,s,u))throw new Error("invalid maxFps");if(t.startDelay=t.startDelay||0,t.startDelay&&!g(t.startDelay,l,d))throw new Error("invalid startDelay");if(!e.shareUrl&&!i.shareUrl)throw new Error("shareUrl required");if(e.shareUrl&&!/https?:\/\//.test(e.shareUrl))throw new Error("invalid shareUrl")}var v=n.defer(),b={};b.appId=i.id,b.ended=v.promise;var y=null,w=o.wrap(regeneratorRuntime.mark(function x(n){var r,o,a,c,u,s;return regeneratorRuntime.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return n=n||{},m(n),r=n.recordConfig,o=t.canCaptureSystemAudio(),a=n.payload,l.next=7,t.getRecordConfig();case 7:return c=l.sent,u={},"tab"===r.captureSource&&(o=!0,angular.isObject(r.draw)&&(s=r.draw,u.draw={showToolbox:!!s.showToolbox},[null,"pointer"].includes(s.tool)&&(u.draw.tool=s.tool))),angular.extend(u,{captureSource:r.captureSource,tabId:n.tabId,startDelay:r.startDelay,targetFPS:r.maxFps,resolution:r.maxResolution,audio:{mic:!!r.audio.mic,micSourceId:r.audio.micSourceId||c.audio.micSourceId,system:o&&r.audio.system},autoShareApp:{id:i.id},connectMeta:{appId:i.id,shareUrl:n.shareUrl,payload:a}}),l.abrupt("return",e.start(u));case 12:case"end":return l.stop()}},x,this)}));return b.start=function(e){var t=n.when(w(e));y=t["finally"](function(){y=null}),t["catch"](f);var o=r.$on("recorder:stopped",function(){f(),o()});return t},b.pause=function(){return e.pause()},b.resume=function(){return e.resume()},b.stop=function(){return e.stop()},b.getState=function(){return e.getRecorderState().state},b.getTime=function(){return e.getRecorderState().time},b.cancelPendingStart=function(){if(y&&e.cancelPendingStart()){var t=y.then(function(){return!1},function(){return!0});return y=null,t}return n.when(!1)},p(),b}var a=64,c=4096,u=60,s=1,l=0,d=10;return i}]),angular.module("castifyExt.webrtcRecorder",["w69b.spawn","w69b.filesHelper","w69b.asyncResponse","castifyExt.pausableTimer"]).factory("webrtcRecorder",["$log","filesHelper","spawn","asyncResponse","PausableTriggeringTimer","$rootScope","$q","PausableTimeout",function(e,t,n,r,o,i,a,c){function u(){function u(){R={state:"inactive",time:0}}function h(t){return I=I.then(function(){if(t||U>$){var e=new Blob(L);return L.length=0,U=0,_.sendWithResponse("write",e)}})["catch"](function(t){e.error("webrtcRecoder: flushQueue failed",t)})}function g(e){L.push(e),U+=e.size,M+=e.size,h()}function m(e){var t=e.data;g(t)}function v(){if(u(),T&&(T.dispose(),T=null),E){try{E.stop()}catch(e){}E=null,L.length=0,U=0}P&&(P.terminate(),P=null,_=null),j.reset()}function b(t){q||(q=!0,e.error("webrtcRecorder: fatal error: ",t),v(),C.onError&&C.onError(t))}function y(){var e=E?E.state:"inactive";if(T||R.state!=e){if(T)R.state=T.paused?"paused":"recording";else switch(R.state=e,e){case"paused":j.pause();break;case"recording":j.paused?j.resume():j.started||j.start()}C.onStateChanged&&C.onStateChanged(R.state)}}function w(){
R.time=j.time,N(),V(),C.onTimeChanged&&C.onTimeChanged(R.time),i.$$phase||i.$apply()}function x(){A.forEach(function(e){E.addEventListener(e,y)})}function S(e,t){E.addEventListener(e,function n(){E.removeEventListener(e,n),t.apply(this,arguments)})}var E,k,R,C={},A=["start","stop","pause","resume","error"];u();var _,P,T,I=Promise.resolve(),$=65536,D=500,F=500,L=[],U=0,M=0,j=new o(w,F),O=f,q=!1,B=7,N=n.wrap(regeneratorRuntime.mark(function W(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!_){e.next=4;break}return e.next=3,_.sendWithResponse("getFps");case 3:R.fps=e.sent;case 4:case"end":return e.stop()}},W,this)})),V=n.wrap(regeneratorRuntime.mark(function H(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:_&&R.time>=B&&(M||b("no_data"));case 1:case"end":return e.stop()}},H,this)}));return C.onStateChanged=null,C.onTimeChanged=null,C.start=n.wrap(regeneratorRuntime.mark(function z(n,o){var i;return regeneratorRuntime.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:i=function(){return T=null,a.when(new Promise(function(t){S("start",function(){e.debug("webrtcEncoder: onStart"),t()}),x(),E.start(D)}))},e.debug("webrtcRecorder: onStart",n,o),k=new l,k.addTrack(o.videoTrack),o.audioTrack&&k.addTrack(o.audioTrack),u.prev=5,E=new s(k,{BitRate:o.bitRate||p,mimeType:o.mimeType||d,videoBitsPerSecond:o.bitRate||p}),u.next=13;break;case 9:throw u.prev=9,u.t0=u["catch"](5),e.error("failed to create MediaRecorder",u.t0),u.t0;case 13:if(!t.isSupported()){u.next=16;break}return u.next=16,t.removeByPath(n)["catch"](function(){return null});case 16:if(P=new Worker(O),_=r.createSender(function(e){return P.postMessage(e)}),P.addEventListener("message",function(e){return _.handleResult(e.data)}),_.send("init",{path:n,fsType:"PERSISTENT"}),E.addEventListener("dataavailable",m),!o.startDelay){u.next=31;break}return j.setStartTime(-o.startDelay),j.start(),T=new c(o.startDelay),T.start(),T.promise.then(i),y(),u.abrupt("return",a.when());case 31:return u.abrupt("return",i());case 32:case"end":return u.stop()}},z,this,[[5,9]])})),C.pause=function(){return T?(T.pause(),j.pause()):E.pause(),y(),a.when()},C.resume=function(){return T?(T.resume(),j.resume()):E.resume(),y(),a.when()},C.getStateObj=function(){return R},C.load=function(){return a.when()},C.getCurrentTime=function(){return R.time},C.stop=n.wrap(regeneratorRuntime.mark(function J(){var e,t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(!T){n.next=7;break}T.dispose(),T=null,j.reset(),y(),n.next=15;break;case 7:return e=new Promise(function(e){S("stop",function(){e()})}),E.stop(),n.next=11,e;case 11:return j.pause(),E=null,n.next=15,h(!0);case 15:return n.next=17,_.sendWithResponse("end");case 17:return t=n.sent,P.terminate(),P=null,_=null,j.reset(),n.abrupt("return",t);case 23:case"end":return n.stop()}},J,this)})),C}var s=window.MediaRecorder,l=window.webkitMediaStream||window.MediaStream,d='video/webm; codecs="vp9, opus"',f="/components/castifyMediawriter/dist/mediawriter.worker.min.js",p=497664e3;return u.isSupported=function(){function e(){var e=navigator.userAgent,t=e.match(/Firefox\/(\d+)/);return t&&t[1]>=44&&e.indexOf("Android")<0}function t(){var e=/Chrome\/(\d+)/.exec(window.navigator.userAgent);return e&&e[1]<51}return"undefined"!=typeof s&&(s.isTypeSupported&&s.isTypeSupported(d)||e())&&!t()},u}]),function(){var e=function(){function e(){_classCallCheck(this,e),this.reset()}return _createClass(e,[{key:"_now",value:function(){return Date.now()/1e3}},{key:"start",value:function(){this.reset(),this._firstTimestamp=this._now()}},{key:"reset",value:function(){this._firstTimestamp=-1,this._pausedAtTimestamp=-1,this._offset=0}},{key:"pause",value:function(){this.paused||(this._pausedAtTimestamp=this._now())}},{key:"resume",value:function(){if(!this.paused)throw new Error;this._offset-=this._now()-this._pausedAtTimestamp,this._pausedAtTimestamp=-1}},{key:"time",get:function(){return this.started?this.paused?this._pausedAtTimestamp-this._firstTimestamp+this._offset:this._now()-this._firstTimestamp+this._offset:0}},{key:"started",get:function(){return this._firstTimestamp>=0}},{key:"paused",get:function(){return this._pausedAtTimestamp>=0}}]),e}(),t=function(e){function t(e,n){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._interval=n,r._listener=e,r._startTime=0,r}return _inherits(t,e),_createClass(t,[{key:"setStartTime",value:function(e){this._startTime=e}},{key:"_fireChange",value:function(){this._listener&&this._listener(this.time)}},{key:"_startInterval",value:function(){this._listener&&this._interval&&(this._intervalId=setInterval(this._fireChange.bind(this),this._interval))}},{key:"_stopInterval",value:function(){this._intervalId&&clearInterval(this._intervalId),this._intervalId=0,this._fireChange()}},{key:"reset",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this._stopInterval()}},{key:"start",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this),this._startInterval()}},{key:"pause",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"pause",this).call(this),this._stopInterval()}},{key:"resume",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"resume",this).call(this),this._startInterval()}},{key:"time",get:function(){return _get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"time",this)+this._startTime}}]),t}(e),n=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n._timeout=e,n.promise=new Promise(function(e){return n._resolve=e}),n}return _inherits(t,e),_createClass(t,[{key:"_startInterval",value:function(){this._timerId=setTimeout(this._onTimer.bind(this),1e3*this.remaining)}},{key:"_onTimer",value:function(){this._timerId=null,this._resolve(),this.dispose()}},{key:"_stopInterval",value:function(){this._timerId&&clearTimeout(this._timerId)}},{key:"start",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this),this._startInterval()}},{key:"pause",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"pause",this).call(this),this._stopInterval()}},{key:"resume",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"resume",this).call(this),this._startInterval()}},{key:"dispose",value:function(){this._stopInterval(),this._resolve=null,this.promise=null}},{key:"remaining",get:function(){return this._timeout-this.time}}]),t}(e);angular.module("castifyExt.pausableTimer",[]).value("PausableTimer",e).value("PausableTimeout",n).value("PausableTriggeringTimer",t)}(),angular.module("castifyExt.optionalPermissions",["w69b.chromePermissions"]).factory("optionalPermissions",["chromePermissions",function(e){function t(e){return e&&(!e.draw||e.draw&&!e.draw.showToolbox&&null===e.draw.tool)?o:r}var n={},r={permissions:["tabCapture","webNavigation","activeTab"],origins:["<all_urls>"]},o={permissions:["tabCapture","webNavigation","activeTab"],origins:[]};return n.hasLiteTabPermissions=function(){return e.contains(o)},n.hasTabPermissions=function(n){return e.contains(t(n))},n.requestTabPermissions=function(n){return e.request(t(n))},n}]),angular.module("castifyExt.hdpiTool",[]).factory("hdpiTool",["$window",function(e){var t={};return t.devicePixelRatio=e.devicePixelRatio,t.toPhysicalResolution=function(e){return{width:Math.floor(e.width*t.devicePixelRatio),height:Math.floor(e.height*t.devicePixelRatio)}},t.toCssResolution=function(e){return{width:Math.round(e.width/t.devicePixelRatio),height:Math.round(e.height/t.devicePixelRatio)}},t.getScreenCssResolution=function(){return{width:e.screen.width,height:e.screen.height}},t}]),angular.module("castifyExt.userAccount",["castifyExt.simpleBgServiceConsumer","castifyExt.chromeEventPublisher"]).factory("userAccount",["simpleBgServiceConsumer",function(e){return e("userAccount",["getAccount","signIn","postUpdate","signOut"])}]),angular.module("castifyExt.bgUserAccount",["castifyExt.userAccount","castifyExt.chromeEventPublisher","castifyExt.simpleBgServicePublisher","castifyExt.castifyAuth","castifyExt.bgLicensing","castifyExt.statsClient","w69b.chromeRuntime","w69b.chromeStorage","w69b.promiseTool","w69b.chromeAnalytics","w69b.spawn"]).factory("bgUserAccount",["$http","castifyAuth","$rootScope","castifyConfig","spawn","promiseTool","simpleBgServicePublisher","$log","chromeStorage","chromeRuntime","bgLicensing","$q","analytics","statsClient",function(e,t,n,r,o,i,a,c,u,s,l,d,f,p){function h(e){return e.data}function g(t){return e.post(C,t,{googleAuth:!0}).then(h)}function m(e){return P=e,u.local.setSingle(A,e)}function v(){return u.local.getSingle(A,null)}function b(e){return!e.license||!e.license.validTill||e.license.validTill<Date.now()}function y(){P&&P.user&&(c.debug("userAccount: refreshing account due to auth sign-in error"),x())}function w(){n.$broadcast("event:userAccountChanged"),s.sendMessage({type:"event:userAccountChanged"})["catch"](angular.identity),c.debug("userAccount: firing accountChanged")}function x(){c.debug("userAccount: refreshing account"),F(),D()["finally"](function(){w()})}function S(e,t,n){n.isPaidInstall&&x()}function E(e,t,n){function r(e){return!e||e>=Date.now()}r(t)!=r(n)&&x()}function k(e,t){return t?t.isPaid?t:e.isPaid?e:t.isTester?t:e.isTester?e:t.branding?e.branding?t.limitNumRecordings?e.limitNumRecordings?t:e:t:e:t:e}var R={},C=r.API_URL+"/account",A="userAccount",_=i.serializer(),P=null,T=o.wrap(regeneratorRuntime.mark(function U(){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.getAccount();case 2:if(n.sent){n.next=4;break}return n.abrupt("return",null);case 4:return n.abrupt("return",e.get(C,{params:{license:"1"},googleAuth:!0}).then(h));case 5:case"end":return n.stop()}},U,this)})),I=o.wrap(regeneratorRuntime.mark(function M(e){var t,n,r,o,i;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,d.all([e?e:T()["catch"](function(){return null}),l.getLicense()]);case 2:return t=a.sent,n=_slicedToArray(t,2),r=n[0],o=n[1],i=null,r&&(i=r.license,delete r.license),i=k(o,i),a.abrupt("return",{license:i,user:r});case 10:case"end":return a.stop()}},M,this)})),$=i.serializer().wrap(o.wrap(regeneratorRuntime.mark(function j(e){var t,n;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(!P){r.next=2;break}return r.abrupt("return",{account:P,updated:!1});case 2:return t=e,n=!1,e&&b(e)&&(e=null),r.next=7,I(e);case 7:if(e=r.sent,c.debug("userAccount: fetched",e),e.user||!t||!t.user){r.next=14;break}c.debug("userAccount: using expired, but signed-in account",t),e=t,r.next=19;break;case 14:return n=!0,m(e),r.next=18,p.clearDirtyNumRecordings();case 18:c.debug("userAccount: updated cache");case 19:return P=e,r.abrupt("return",{account:e,updated:n});case 21:case"end":return r.stop()}},j,this)}))),D=_.wrap(o.wrap(regeneratorRuntime.mark(function O(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!P){t.next=2;break}return t.abrupt("return",P);case 2:return t.next=4,v();case 4:if(e=t.sent,e&&e.license){t.next=11;break}return t.next=8,$(e);case 8:return t.abrupt("return",t.sent.account);case 11:if(!e||!b(e)){t.next=16;break}return _(function(){return $(e)}).then(function(e){e.updated&&w()}),t.abrupt("return",e);case 16:return t.abrupt("return",e);case 17:case"end":return t.stop()}},O,this)}))),F=_.wrap(function(){return c.debug("userAccount: clearing cache"),P=null,m(null)}),L=o.wrap(regeneratorRuntime.mark(function q(e){var t,n,r;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return t=function(e){return e.getUTCFullYear()+"-"+e.getUTCMonth()},o.next=3,p.getDirtyNumRecordings();case 3:return n=o.sent,r=0,e.user&&e.user.fetchedAt&&e.user.numRecordingsMonth&&t(new Date(e.user.fetchedAt))==t(new Date)&&(r=e.user.numRecordingsMonth),e.numRecordingsMonth=n+r,o.abrupt("return",e);case 8:case"end":return o.stop()}},q,this)}));return R.signIn=function(e){var n=t.getAuthToken({interactive:!e||"select_account"});return f.trackEvent("signIn","start"),n.then(function(){f.trackEvent("signIn","success")},function(){f.trackEvent("signIn","cancelled")}),n},R.signOut=o.wrap(regeneratorRuntime.mark(function B(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return c.debug("userAccount: signOut"),e.next=3,d.all([t.signOut(),F()]);case 3:x();case 4:case"end":return e.stop()}},B,this)})),R.getAccount=o.wrap(regeneratorRuntime.mark(function N(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=L,e.next=3,D();case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}},N,this)})),R.update=function(){return x()},R.postUpdate=o.wrap(regeneratorRuntime.mark(function V(e){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.t0=I,n.next=3,g(e);case 3:return n.t1=n.sent,n.next=6,(0,n.t0)(n.t1);case 6:return t=n.sent,n.next=9,p.clearDirtyNumRecordings();case 9:return m(t),w(),n.abrupt("return",L(t));case 12:case"end":return n.stop()}},V,this)})),R.$testClearMemoryCache=function(){P=null},R.install=function(){a("userAccount",R,["install"]),n.$on("event:signInChanged",x),n.$on("connect:appConnected",S),n.$on("connect:userExpiryDateChange",E),n.$on("castifyAuth:notSignedIn",y)},R}]).factory("userAccount",["bgUserAccount",function(e){return e}]),angular.module("castifyExt.statsClient",["w69b.chromeStorage","w69b.spawn"]).factory("statsClient",["$http","castifyConfig","chromeStorage","spawn","$q",function(e,t,n,r,o){function i(){var e=new Date;return e.getUTCFullYear()+"-"+e.getUTCMonth()}function a(e){var t={};return t[i()]=e,n.local.setSingle(d,t)}function c(){return null}var u={},s=t.API_URL+"/stats",l={googleAuth:!0},d="numRecordingsByMonthDirty";u.getDirtyNumRecordings=r.wrap(regeneratorRuntime.mark(function p(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n.local.getSingle(d,{});case 2:return e=t.sent,t.abrupt("return",e[i()]||0);case 4:case"end":return t.stop()}},p,this)})),u.clearDirtyNumRecordings=function(){return a(0)};var f=r.wrap(regeneratorRuntime.mark(function h(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,u.getDirtyNumRecordings();case 2:return e=t.sent,t.next=5,a(++e);case 5:case"end":return t.stop()}},h,this)}));return u.sendRecordingCreated=function(t){return o.all([f(),e.post(s+"/recording_created",{duration:t},l)])["catch"](c)},u}]),angular.module("castifyExt.downloadHelper",[]).factory("downloadHelper",function(){var e={};return e.download=function(e,t){var n=angular.element("<a></a>"),r=t.replace(/[\/,\\]/g,"");n.attr("href",e),n.attr("download",r),n[0].dispatchEvent(new MouseEvent("click"))},e}),angular.module("castifyEdit.pnaclVideoEditor",["w69b.pnaclModule","w69b.promiseTool"]).factory("pnaclVideoEditor",["pnaclModule","$q","$log","$rootScope","promiseTool",function(e,t,n,r,o){function i(i,a){function c(){v={state:"inactive",time:0}}function u(){b.unload(),c()}function s(e){v=e,"done"!==e.state&&"cancelled"!==e.state||b.unload()}function l(e){u(),y&&y.reject(e),y=null}function d(e){n.error("pnaclVideoEditorError",e),l(e),S.onError&&S.onError(e)}function f(e,t){b.postMessage({type:e,data:t||{}})}function p(e,n){if(y)throw new Error("there is still a pending operation");return y=t.defer(),e&&f(e,n),y.promise}function h(e){if(!/^\/html5_(temporary|persistent)\//.test(e))throw new Error("invalid filename")}function g(e){l(),S.onCrash&&S.onCrash(e)}function m(){return Number((/Chrome\/(\d+)/.exec(window.navigator.userAgent)||[void 0,0])[1])}var v,b=e(i,a),y=null,w=8e5,x=["start","cancel"],S={};return b.onMessage=function(e){if(e=e.data,x.indexOf(e.type)>=0){if(!y)return;e.data?y.reject(e.data):y.resolve(),y=null}else if("error"==e.type)d(e.data),r.$$phase||r.$digest();else if("state"==e.type)s(e.data),r.$$phase||r.$digest();else if("stack_trace"==e.type)g(e.data);else{var t;e.data&&(t=e.data,t.trim&&(t=t.trim())),n.debug(e.type,t)}},S.onCrash=void 0,b.onCrash=g,S.load=function(){return b.load()},S.getStateObj=function(){return v},S.cancel=function(){return o.withTimeout(function(){return p("cancel")},1e3)["catch"](function(){return null}).then(function(){l()})},S.hasPendingOperation=function(){return!!y},S.start=function(e){return h(e.inFilename),h(e.outFilename),o.withTimeout(function(){return b.load().then(function(){return p("start",{config:JSON.stringify(e),chromeVersion:m()})})},w,function(){return d("start_timeout"),t.reject("start_timeout")})},c(),S}return i}]),angular.module("castifyEdit.localEditJob",["castifyEdit.pnaclVideoEditor","w69b.filesHelper"]).factory("startLocalEditJob",["pnaclVideoEditor","$q","$log","$rootScope",function(e,t,n,r){function o(i){function a(){l=r.$watch(function(){return s.getStateObj().state},function(e){"done"===e?u.resolve():"error"===e&&u.resolve(s.getStateObj().errorReason)})}function c(){return n.debug("startLocalEditJob: starting job",i),s=e(o.NACL_URL),u=t.defer(),s.start(i).then(a,function(e){n.error("failed to start local edit job",e),u.reject("start_error")}),s.onCrash=function(e){n.error("startLocalEditJob crashed",e),u.reject("crash")},s.onError=function(e){n.error("localEditJob error: ",e),u.reject(e)},u.promise["finally"](l),u.promise}var u,s,l=angular.noop,d={};return d.getProgress=function(){var e=s.getStateObj();return e.totalMs&&e.progressMs?e.progressMs/e.totalMs:0},d.cancel=function(){return s.cancel()},d.promise=c(),d}return o}]),angular.module("castifyEdit.remoteEditJob",["castifyEdit.pnaclVideoEditor"]).factory("startRemoteEditJob",["$q","$log","$timeout","$http","castifyConfig",function(e,t,n,r,o){function i(o){function i(){g&&n.cancel(g),n(function(){g=null,d()},c)}function u(){return r.get(a+"/"+h,{googleAuth:!0}).then(function(e){return e.data})}function s(e){p.reject(e)}function l(e){var t;t=e.result.gcsFile?{isExport:!0,saveFileName:e.result.saveFileName,url:a+"/export/"+e.id+"/"+e.result.gcsFile}:e.result,p.resolve(t)}function d(){u().then(function(e){var n=e.state;"completed"===n?l(e):"failed"===n?s(e.result&&e.result.error?e.result.error:"remote_failed"):"cancelled"===n?t.debug("remote edit job was cancelled",h):(m=e.progress,i())},function(e){e.status>=400&&e.status<500?s(e):i()})}function f(){return p=e.defer(),r.post(a,{config:o,version:2},{googleAuth:!0}).then(function(e){var n=e.data;t.debug("startRemoteEditJob: job created",n.id),h=n.id,i()},s),p.promise}var p,h,g,m=0,v={};return v.getProgress=function(){return m},v.cancel=function(){return h?r["delete"](a+"/"+h,{googleAuth:!0}):e.reject()},v.promise=f(),v}var a=o.API_URL+"/edit",c=3e3;return i}]),angular.module("castifyEdit.bgEditJobScheduler",["castifyEdit.startEditJob","castifyEdit.fixWebmJob","castifyExt.bgFiles","castifyExt.simplePortService"]).factory("ScheduledEditJob",["startEditJob","bgFiles","startFixWebmJob","$q",function(e,t,n,r){function o(e){this.config=e,this.state="queued",this.id=i++,this._doneDeferred=r.defer(),this.promise=this._doneDeferred.promise,e.meta&&e.meta.fileId&&t.getFileDescriptor(e.meta.fileId).then(function(e){this.fileDesc=e}.bind(this))}var i=1,a=o.prototype;return a.start=function(){var t=this;t.state="running";var r="fixWebm"===this.config.type?n:e,o=r(t.config);return o=o.then(function(e){return t.editJob=e,e.promise}),o.then(t.onComplete_.bind(t),t.onError_.bind(t)),o.then(this._doneDeferred.resolve.bind(this._doneDeferred),this._doneDeferred.reject.bind(this._doneDeferred)),o},a.getProgress=function(){return"done"===this.state?1:"running"===this.state&&this.editJob?this.editJob.getProgress():0},a.onComplete_=function(e){this.result=e,this.state="done"},a.onError_=function(){this.state="error"},a.cancel=function(){return!(!this.editJob||!this.editJob.cancel)&&(this.editJob.cancel(),this.state="cancelled",!0)},a.toJSON=function(){var e={id:this.id,result:this.result,state:this.state,progress:this.getProgress(),cancelDanger:"fixWebm"===this.config.type};return e.cancelable=!(!this.editJob||!this.editJob.cancel),this.config.meta&&this.config.meta.fileId&&(e.fileId=this.config.meta.fileId),this.fileDesc&&(e.fileTitle=this.fileDesc.title),e},o}]).factory("bgEditJobScheduler",["simplePortService","$rootScope","ScheduledEditJob","$log","chromeRuntime",function(e,t,n,r,o){function i(e){return m.filter(function(t){return t.state===e})}function a(e){return m.find(function(t){return t.id===e})}function c(){return i("running")}function u(){return i("queued")}function s(){if(!(c().length>0)){var e=i("queued");if(e.length){var n=e[0];r.debug("starting scheduled edit",n);var o=n.start();t.$broadcast("editJob:started",n.id),o.then(d.bind(null,n),l.bind(null,n))}}}function l(e,n){r.warn("scheduled edit job failed",e,n),s(),t.$broadcast("editJob:failed",e.id,n)}function d(e,n){r.debug("scheduled edit job completed",e,n),s(),t.$broadcast("editJob:completed",e.id,n)}function f(){function n(){o.postMessage("jobsList",g.getJobs())}function r(){t.$on("editJob:completed",n),t.$on("editJob:started",n),t.$on("editJob:failed",n),t.$on("editJob:cancelled",n),o.install()}var o=e("editor");return o.handlers={addJob:g.addJob,cancel:g.cancel,getJobs:n,clearComplete:g.clearComplete},r(),{postJobs:n}}function p(){(u().length||c().length)&&(r.info("onSuspend() while editing is active, preventing unloading"),o.getBackgroundPage())}var h,g={},m=[];return g.addJob=function(e){r.debug("adding edit job",e);var t=new n(e);return m.push(t),s(),t},g.cancel=function(e){r.debug("canceling edit job",e);var n=a(e);n&&n.cancel()&&t.$broadcast("editJob:cancelled",n.id)},g.getJob=function(e){return a(e)},g.getJobs=function(){return m},g.clearComplete=function(e){m=m.filter(function(t){return"done"!==t.state||e&&t.id!==e}),h&&h.postJobs()},g.install=function(){h=f(),o.onSuspend.addListener(p)},g}]),angular.module("castifyEdit.startEditJob",["castifyEdit.localEditJob","castifyEdit.remoteEditJob","castifyExt.bgFiles","castifyExt.videoPreviewRenderer","castifyExt.fileNameGenerator","w69b.filesHelper","w69b.spawn"]).factory("startEditJob",["startLocalEditJob","startRemoteEditJob","bgFiles","filesHelper","videoPreviewRenderer","$log","fileNameGenerator","$q","spawn",function(e,t,n,r,o,i,a,c,u){function s(s){function g(){return r.getDirByPath(d,{create:!0})}function m(){var t="gif"===s.outFormat?p:f;return g().then(function(){var r=angular.extend({inFilename:l+n.idToLocalFilename(P.id),outFilename:l+t},s);return delete r.meta,e(r)})}function v(){return i.debug("running local post edit steps"),"gif"===s.outFormat?b():y()}function b(){return i.info("gif export complete"),r.getFileEntryByPath(p).then(function(e){return{url:e.toURL(),isExport:!0,saveFileName:P.title+"."+s.outFormat}})}function y(){var e;return a("",".webm").then(function(t){return e=n.localFilenameToId(t),r.moveFileByPath(f,t)["catch"](function(e){return i.error("failed to move edited file to ",t),c.reject(e)})}).then(function(){return i.debug("rendering preview"),o.renderPreview(e)["catch"](function(){return i.info("rendering preview image for edit failed"),null})}).then(function(){return n.registerLocalFile(e)}).then(function(){var t=P.title;return s.meta.copy&&(t+=h),n.rename(e,t),{fileId:e}})}function w(e){return i.debug("running local post edit steps"),c.reject(e)}function x(){r.removeByPath(f),r.removeByPath(p)}function S(){var e=angular.extend({},s,{meta:angular.extend(s.meta,{driveId:P.driveInfo.id})});return t(e)}function E(e){return i.debug("running drive post edit steps for",e),n.refresh(e.id),{fileId:e.id}}function k(e){return e}function R(e){return i.debug("remote edit job completed"),e.isExport?k(e):E(e)}function C(e){return c.reject(e)}function A(e){return u(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(s.meta.copy||"gif"===s.outFormat){t.next=3;break}return t.next=3,n.remove(P.id)["catch"](angular.noop);case 3:return t.abrupt("return",e);case 4:case"end":return t.stop()}},t,this)}))}function _(){return u(regeneratorRuntime.mark(function e(){var t,r,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.getFileDescriptor(s.meta.fileId);case 2:if(t=e.sent,P=t,!t.driveInfo){e.next=9;break}r=S(),o=r.promise.then(R,C),e.next=15;break;case 9:return e.next=11,m(t);case 11:r=e.sent,o=r.promise.then(v,w),i=r.cancel.bind(r),r.cancel=function(){return i().then(x)};case 15:return o=o.then(A),r.promise=o,e.abrupt("return",r);case 18:case"end":return e.stop()}},e,this)}))}var P;return _()}e.NACL_URL="manifest_editor.nmf";var l="/html5_persistent/",d="_tmp",f=d+"/edited.webm",p=d+"/exported.gif",h=" - Edited";return s}]),angular.module("castifyEdit.editNotifications",["w69b.chromeNotifications","w69b.promiseTool","castifyEdit.bgEditJobScheduler","castifyExt.ui.openInAppTab","castifyExt.appOptions","castifyExt.downloadHelper"]).factory("editNotifications",["$rootScope","$log","chromeNotifications","$q","openInAppTab","appOptions","chromeTabs","promiseTool","$interval","bgEditJobScheduler","downloadHelper",function(e,t,n,r,o,i,a,c,u,s,l){function d(e){function t(t,o){d(function(){var i,a=y+e+":"+t,c=!l;return l&&l!==a?(i=n.clear(l),c=!0):i=r.when(),o=angular.extend({type:"basic",priority:0,eventTime:Date.now(),isClickable:!1,title:"Processing Video",iconUrl:"images/icon128.png"},o),l=a,c?i.then(function(){return n.create(a,o)}):i.then(function(){return n.update(a,o)})})}function o(){t("progress",{type:"progress",message:"We are currently processing your video.",progress:Math.floor(100*p.getProgress())})}var a,l=null,d=c.serializer(),f={},p=s.getJob(e);return f.hide=function(){u.cancel(a),d(function(){if(l){var e=n.clear(l);return l=null,e}})},f.start=function(){i.values.notifyEditProgress&&(o(),a=u(o,1e3))},f.complete=function(e,n){i.values.notifyEditProgress&&(u.cancel(a),n.fileId&&t("complete",{type:"basic",title:"Processing Complete",message:"Your video is ready",buttons:[{title:"Show File"}]}),n.isExport?t("export_complete",{type:"basic",title:"Processing Complete",message:"Your export is ready",buttons:[{title:"Save File"}]}):f.hide())},f.failure=function(){u.cancel(a),t("failed",{type:"basic",title:"Failed to process Video",message:"Please contact support if this problem persists"})},f}function f(e){var t=w[e];return t||(t=d(e),w[e]=t),t}function p(e,t){f(t).start()}function h(e,t,n){f(t).failure(n),delete w[t]}function g(e,t,n){f(t).complete(t,n),delete w[t]}function m(e,t){f(t).hide(),delete w[t]}function v(e,t){if(e.startsWith(y)){var r=Number(e.split(":").slice(1,2)[0]),i=s.getJob(r),a=e.split(":").slice(2,3)[0];i&&i.result&&("complete"===a?o("app.html#/files/"+encodeURIComponent(i.result.fileId)):"export_complete"===a&&(l.download(i.result.url,i.result.saveFileName),s.clearComplete(r))),n.clear(e)}}var b={},y="edit:",w={};return b.install=function(){e.$on("editJob:started",p),e.$on("editJob:failed",h),e.$on("editJob:completed",g),e.$on("editJob:cancelled",m),n.onButtonClicked.addListener(v)},b}]),angular.module("castifyEdit.fixWebmJob",["w69b.asyncResponse","w69b.spawn","w69b.filesHelper"]).factory("startFixWebmJob",["asyncResponse","spawn","filesHelper","$q",function(e,t,n,r){function o(){return n.getDirByPath(u,{create:!0})}function i(e){this.config=e,this.progress=0}var a,c="/components/castifyMediawriter/dist/mediawriter.worker.min.js",u="_tmp",s=u+"/edited.webm",l=i.prototype;return l.start=function(){return this.promise=this._doStart(),this.promise},l._doStart=t.wrap(regeneratorRuntime.mark(function d(){var t,i,u,l;return regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return t=this.config,a=new Worker(c),this._cancelDeferred=r.defer(),d.next=5,o();case 5:return i=e.createSender(function(e){return a.postMessage(e)}),a.addEventListener("message",function(e){var t=e.data;i.handleResult(t)||"progress"===t.type&&(this.progress=t.data)}.bind(this)),i.send("init",{path:s,fsType:"PERSISTENT"}),u=!1,l=i.sendWithResponse("readChromeFile",{path:t.inPath,fsType:"PERSISTENT"}),d.next=12,r.race([this._cancelDeferred.promise.then(function(){return u=!0}),l]);case 12:if(a.terminate(),a=null,this._cancelDeferred=null,u){d.next=20;break}return d.next=18,n.moveFileByPath(s,t.outPath);case 18:return d.next=20,n.removeByPath(t.inPath);case 20:return d.abrupt("return",{fileId:this.config.fileId});case 21:case"end":return d.stop()}},d,this)})),l.cancel=t.wrap(regeneratorRuntime.mark(function f(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a&&this._cancelDeferred){t.next=2;break}return t.abrupt("return",!1);case 2:return a.terminate(),e=this.config,t.next=6,n.removeByPath(s)["catch"](function(){return null});case 6:return t.next=8,n.moveFileByPath(e.inPath,e.outPath);case 8:return this._cancelDeferred.resolve(),t.abrupt("return",!0);case 10:case"end":return t.stop()}},f,this)})),l.getProgress=function(){return this.progress},function(e){var t=new i(e);return t.start(),Promise.resolve(t)}}]),angular.module("w69b.chromeAnalytics",[]).provider("analytics",function(){var e,t;this.setTrackingId=function(t){e=t},this.setApp=function(e,n){t=arguments},this.$get=["$window",function(n){if(!t)throw new Error("make sure to call analyticsProvider.setApp()");if(!n.analytics)throw new Error("chrome-analytics lib not loaded");var r=n.analytics,o=r.getService.apply(r,t),i=o.getTracker(e),a={};return a.tracker=i,a.eventBuilder=function(){return r.EventBuilder.builder()},a.setEnabled=function(e){o.getConfig().addCallback(function(t){t.setTrackingPermitted(e)})},a.send=function(){i.send.apply(i,arguments)},a.trackPageView=function(e){i.sendAppView(e)},a.trackEvent=function(){i.sendEvent.apply(i,arguments)},a.sendNonInteractionEvent=function(e,t,n,o){var i={eventCategory:e,eventAction:t,eventLabel:n,eventValue:o,nonInteraction:!0};a.send(r.HitTypes.EVENT,i)},a.trackTimer=function(e,t,n){var r,o={};return o.start=function(){return r=(new Date).getTime(),o},o.send=function(a,c,u){var s=(new Date).getTime();return i.sendTiming(a||e,c||t,s-r,u||n),o},o.start(),o},a}]}),angular.module("w69b.chromeCapture",["w69b.promiseTool","w69b.webrtc"]).factory("chromeCapture",["promiseTool","webrtc","$q",function(e,t,n){var r={};return r.tabCapture=function(){return chrome.tabCapture?e.wrapChromeError(chrome.tabCapture.capture,chrome.tabCapture).apply(null,arguments):n.reject("tabCapture permission missing")},chrome.desktopCapture&&(r.chooseDesktopMedia=function(){function t(e){chrome.desktopCapture.cancelChooseDesktopMedia(i),o.reject(e||"cancelled")}e.wrapChromeError(chrome.desktopCapture.chooseDesktopMedia,chrome.desktopCapture);var r=Array.prototype.slice.call(arguments,0),o=n.defer();r.push(function(e){chrome.runtime.lastError?o.reject(chrome.runtime.lastError):o.resolve(e)});var i=chrome.desktopCapture.chooseDesktopMedia.apply(chrome.desktopCapture,r);return{promise:o.promise,cancel:t}}),r.desktopCapture=function(e){var n={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:1920,maxHeight:1200}}};return t.getUserMedia(n)},r}]),angular.module("w69b.chromeCommands",["w69b.promiseTool"]).factory("chromeCommands",["promiseTool",function(e){var t={};return t.getAll=e.wrapChromeError(chrome.commands.getAll,chrome.commands),t.onCommand=chrome.commands.onCommand,t}]),angular.module("w69b.chromePersistentLogger",["w69b.chromeStorage","w69b.logging","w69b.structs.CircularBuffer"]).provider("chromePersistentLogger",["$logProvider",function(e){function t(e,t){var r={level:e,args:t,timestamp:(new Date).getTime()};return n?n.add(r):o.push(r),!0}var n,r="logs",o=[],i=!1,a=1e3,c="logs_",u=!1,s=!0;
this.setStorageKey=function(e){r=e},this.setMaxNumLogs=function(e){a=e},this.enableAutoLoad=function(e){i=e},this.enableAutoSave=function(e){s=e},this.enableGlobalHandler=function(e){u=e},this.install=function(){this.enableAutoLoad(!0),e.setCustomHook(t)},this.$get=["$window","$q","chromeStorage","CircularBuffer","$log",function(e,l,d,f,p){function h(e){var t=e.args.map(function(e){if(!angular.isObject(e))return e;try{return angular.toJson(e)}catch(t){return e}});return[new Date(e.timestamp).toISOString(),e.level.toUpperCase(),t.join(", ")].join(" ")}function g(e){var t=new f(a);return e.forEach(function(e){t.add(e)}),t}var m={};return m.load=function(){return d.local.getSingle(c+r).then(function(e){e&&e.length&&(n=g(e.concat(m.getEntries())))})},m.save=function(e){return d.local.setSingle(c+(e||r),m.getEntries())},m.clear=function(){n.clear()},m.getEntries=function(){return n.getValues()},m.getLogs=function(){return m.getEntries().map(h)},m.getMergedLogs=function(e){return e=e.map(function(e){return c+e}),d.local.get(e).then(function(e){var t=[];return angular.forEach(e,function(e,n){e&&e.length&&e.forEach(function(e){e.storageKey=n.substr(c.length),t.push(e)})}),t.sort(function(e,t){return e.timestamp-t.timestamp}),t.map(function(e){return"["+e.storageKey+"] "+h(e)})})},m.hookFn=t,n=g(o),o=null,i&&m.load(),u&&(e.onerror=function(e,t,n){p.error("global error",e,t,n)}),s&&e.addEventListener("unload",function(){m.save()}),m}]}]).run(["chromePersistentLogger",angular.noop]),angular.module("w69b.chromeRuntime",["w69b.promiseTool"]).factory("chromeRuntime",["promiseTool",function(e){var t={};return t.sendMessage=e.wrapChromeError(chrome.runtime.sendMessage,chrome.runtime),t.getBackgroundPage=e.wrapChromeError(chrome.runtime.getBackgroundPage,chrome.runtime),t.connect=chrome.runtime.connect.bind(chrome.runtime),t.getManifest=chrome.runtime.getManifest.bind(chrome.runtime),t.id=chrome.runtime.id,chrome.runtime.getPlatformInfo&&(t.getPlatformInfo=e.wrapChromeError(chrome.runtime.getPlatformInfo,chrome.runtime)),t.setUninstallURL=e.wrapChromeError(chrome.runtime.setUninstallURL,chrome.runtime),["onMessage","onMessageExternal","onConnect","onConnectExternal","onInstalled","onSuspend"].forEach(function(e){t[e]={addListener:function(t){chrome.runtime[e].addListener(t)},removeListener:function(t){chrome.runtime[e].removeListener(t)}}}),t}]),angular.module("w69b.chromeStorage",["w69b.promiseTool"]).factory("chromeStorage",["promiseTool",function(e){var t=chrome.storage,n={};return["local","sync","managed"].forEach(function(r){n[r]={},["set","get","remove","clear"].forEach(function(o){n[r][o]=e.wrapChromeError(t[r][o],t[r])}),n[r].setSingle=function(e,t){var o={};return o[e]=t,n[r].set(o)},n[r].getSingle=function(e,t){return n[r].get(e).then(function(n){return n.hasOwnProperty(e)?n[e]:t})}}),n.onChanged=t.onChanged,n}]),angular.module("w69b.chromeTabs",["w69b.promiseTool"]).factory("chromeTabs",["$window","promiseTool","$q",function(e,t,n){if(!e.chrome||!e.chrome.tabs)return null;var r=e.chrome,o={};return o.query=t.wrapChromeError(r.tabs.query,r.tabs),o.getActiveTab=function(){return o.query({active:!0,windowId:r.windows.WINDOW_ID_CURRENT}).then(function(e){return e.length?e[0]:n.reject()})},o.get=t.wrapChromeError(r.tabs.get,r.tabs),o.update=t.wrapChromeError(r.tabs.update,r.tabs),o.remove=t.wrapChromeError(r.tabs.remove,r.tabs),o.create=t.wrapChromeError(r.tabs.create,r.tabs),o.connect=r.tabs.connect.bind(r.tabs),o.setZoomSettings=t.wrapChromeError(r.tabs.setZoomSettings,r.tabs),o.setZoom=t.wrapChromeError(r.tabs.setZoom,r.tabs),o.executeScript=t.wrapChromeError(r.tabs.executeScript,r.tabs),o.insertCSS=t.wrapChromeError(r.tabs.insertCSS,r.tabs),o.sendMessage=t.wrapChromeError(r.tabs.sendMessage,r.tabs),o.onUpdated=r.tabs.onUpdated,o.onActivated=r.tabs.onActivated,o.sendMessageActive=function(e,t){return o.getActiveTab().then(function(n){return o.sendMessage(n.id,e,t)})},o}]).directive("newTab",["chromeTabs",function(e){return{restrict:"A",link:function(t,n,r){n.bind("click",function(t){t.preventDefault(),e.create({url:r.href}).then(function(e){chrome.windows.update(e.windowId,{focused:!0},angular.noop)})})}}}]),angular.module("w69b.chromeWindows",[]).factory("chromeWindows",["promiseTool",function(e){var t={};return t.get=e.wrapChromeError(chrome.windows.get,chrome.windows),t.create=e.wrapChromeError(chrome.windows.create,chrome.windows),t.update=e.wrapChromeError(chrome.windows.update,chrome.windows),t.getCurrent=e.wrapChromeError(chrome.windows.getCurrent,chrome.windows),t.remove=e.wrapChromeError(chrome.windows.remove,chrome.windows),t.onRemoved=chrome.windows.onRemoved,t}]),angular.module("w69b.filesHelper",["w69b.promiseTool"]).factory("filesHelper",["$window","promiseTool","$q",function(e,t,n){function r(e){var t=e.split("/"),n=t.slice(0,-1).join("/"),r=t.slice(-1)[0];return[n,r]}e.requestFileSystem=e.requestFileSystem||e.webkitRequestFileSystem;var o=window.PERSISTENT,i=104857600,a={},c=["readEntries","remove","getFile","getMetadata","moveTo","file","getDirectory","createWriter"];return c.forEach(function(e){a[e]=function(n){var r=[].slice.call(arguments,1);return t.wrapCallbacks(n[e],n).apply(null,r)}}),a.getFileSystem=function(n,r){return angular.isUndefined(n)&&(n=o),r=r||i,t.wrapCallbacks(e.requestFileSystem,e)(n,r)},a.getPersistentQuota=function(){var t=n.defer();return e.navigator.webkitPersistentStorage.queryUsageAndQuota(function(e,n){t.resolve({usage:e,quota:n})},function(e){t.reject(e)}),t.promise},chrome.system&&chrome.system.storage&&(a.getStorageInfo=t.wrapChromeError(chrome.system.storage.getInfo,chrome.system.storage)),a.getDirByPath=function(e,t){function r(e,o){return o.length?a.getDirectory(e,o[0],t||{}).then(function(e){return r(e,o.slice(1))}):n.when(e)}var o=e.split("/");return""===o[0]&&o.splice(0,1),a.getFileSystem().then(function(e){return r(e.root,o,t)})},a.moveFileByPath=function(e,t){var o=r(t),i=o[0],c=o[1];return n.all({file:a.getFileEntryByPath(e),targetDir:a.getDirByPath(i)}).then(function(e){return a.moveTo(e.file,e.targetDir,c)})},a.getFileEntryByPath=function(e,t,n){var o=r(e),i=o[0],c=o[1];return a.getDirByPath(i,n).then(function(e){return a.getFile(e,c,t||{})})},a.getFileByPath=function(e){return a.getFileEntryByPath(e).then(function(e){return a.file(e)})},a.removeByPath=function(e){return a.getFileEntryByPath(e).then(function(e){return a.remove(e)})},a.listByPath=function(e){return a.getDirByPath(e).then(function(e){var t=e.createReader();return a.readEntries(t)})},a.requestPersistentQuota=function(e){return t.wrapCallbacks(navigator.webkitPersistentStorage.requestQuota,navigator.webkitPersistentStorage)(e||i)},a.requestTemporaryQuota=function(e){return t.wrapCallbacks(navigator.webkitTemporaryStorage.requestQuota,navigator.webkitTemporaryStorage)(e||i)},a.writeFile=function(e,t){var r=n.defer();return e.onwriteend=r.resolve.bind(r),e.onerror=r.reject.bind(r),e.write(t),r.promise},a.isSupported=function(){return!!window.requestFileSystem},a}]),angular.module("w69b.googleHttpAuthInterceptor",[]).provider("googleHttpAuthInterceptor",function(){var e=0,t="googleauth";this.enableAuthAutoRetry=function(t){e=t?1:0},this.setAuthProvider=function(e){t=e},this.$get=["$q","$log","$injector",function(n,r,o){function i(){return d||(d=o.get(t)),d}function a(e){return i().getAuthToken(e)}function c(e){return{Authorization:"Bearer "+e}}function u(){return l||(l=o.get("$http")),l}function s(t){var o=t.status;if(401==o&&t.config.googleAuth&&t.config.authAutoRetry!==!1){r.debug("auth error detected",t);var i=angular.copy(t.config);if(i.authRetryCount?i.authRetryCount++:i.authRetryCount=1,i.authRetryCount<=e)return a({scopes:i.googleAuthScopes,validate:!0}).then(function(){return r.debug("googleAuthHttpInterceptor: auto-retrying with validated token"),u()(i)})}return n.reject(t)}var l,d;return{request:function(e){return e.googleAuth?a({scopes:e.googleAuthScopes}).then(function(t){return e.headers=angular.extend(e.headers||{},c(t)),e},function(e){return r.warn("googleAuthHttpInterceptor: no token, aborting request",e),n.reject("googleAuthFailed")}):e},responseError:s}}]}),angular.module("w69b.uuid",[]).factory("uuid",["$window",function(e){function t(e){for(var t=e.toString(16);t.length<4;)t="0"+t;return t}function n(){var n=new Uint16Array(8);return e.crypto.getRandomValues(n),t(n[0])+t(n[1])+"-"+t(n[2])+"-4"+t(n[3]).substring(1)+"-y"+t(n[4]).substring(1)+"-"+t(n[5])+t(n[6])+t(n[7])}return n}]),angular.module("w69b.uritool",[]).factory("uritool",function(){function e(e){return decodeURIComponent(e.replace(t," "))}var t=/\+/g,n={};return n.parseQuery=function(t,n){"?"==t[0]&&(t=t.substring(1));for(var r,o=/([^&=]+)=?([^&]*)/g,i={};r=o.exec(t);){var a=e(r[1]),c=e(r[2]);n&&i.hasOwnProperty(a)?i[a].push(c):i[a]=n?[c]:c}return i},n.parseUrl=function(e){var t=document.createElement("a");return t.href=e,{protocol:t.protocol.replace(":",""),host:t.hostname,port:t.port,query:t.search,hash:t.hash,path:t.pathname}},n.encodeQuery=function(e){var t=[];return angular.forEach(e,function(e,n){angular.isArray(e)?angular.forEach(e,function(e){t.push(encodeURIComponent(n)+(e===!0?"":"="+encodeURIComponent(e)))}):t.push(encodeURIComponent(n)+(e===!0?"":"="+encodeURIComponent(e)))}),t.length?t.join("&"):""},n}),angular.module("w69b.googleUploader",["w69b.ngProgressHttp"]).factory("googleUploader",["$progressHttp","$http","$q","$timeout","$log",function(e,t,n,r,o){function i(e,t){var o=e.headers("Retry-After");if(o&&f)o=Math.min(l,1e3*Number(o));else{if(!t)return n.when(e);o=t}return r(angular.noop,o).then(function(){return e})}function a(e){return e.data}function c(r,o){function c(e){return!g&&l&&308===e.status?s():d&&!g&&l&&(e.status<=0||e.status>=500&&e.status<=599||e.config&&e.config.authAutoRetry===!1&&401===e.status)?i(e,2e3).then(s):n.reject(e)}function u(t){if(308==t.status){var i,a=t.headers("Range");i=a?Number(a.match(/bytes=0-(\d+)/)[1])+1:0;var c=Math.min(r.size,h),u=Math.min(i+c,r.size)-1,s="bytes "+i+"-"+u+"/"+r.size,d=angular.extend({},o,{url:l,method:"PUT",progressEvents:"upload",transformRequest:null,data:r.slice(i,u+1),googleAuth:!0,authAutoRetry:!1,timeout:p});return d.headers=angular.extend({},d.headers,{"Content-Type":r.type,"Content-Range":s}),e(d).then(null,null,function(e){return e=e.event,{loaded:e.loaded+i,total:r.size}})}return 200==t.status?t:n.reject(t)}function s(){var e=angular.extend({},o,{timeout:p,googleAuth:!0});return e.headers=angular.extend({},e.headers,{"Content-Range":"bytes */"+r.size}),t.put(l,"",e).then(i,i).then(u)["catch"](c)}var l=null,f=n.defer(),p=f.promise,g=!1,m={};return m.start=function(e,i,u){u=angular.extend({},o,u),angular.extend(u.headers||{},{"X-Upload-Content-Length":r.size,"X-Upload-Content-Type":"video/*"}),u.googleAuth=!0,u.timeout=p;var d=n.defer();return t.post(e,i,u).then(function(e){return l=e.headers("Location"),d.notify({uploadUrl:l}),s()})["catch"](c).then(d.resolve.bind(d),d.reject.bind(d),d.notify.bind(d)),m.promise=d.promise.then(a),m.promise},m.resume=function(e){return l=e,m.promise=s().then(a),m.promise},m.cancel=function(){g=!0,f.resolve()},m}var u="https://www.googleapis.com/upload/youtube/v3/videos",s="https://www.googleapis.com/upload/drive/v2/files?uploadType=resumable",l=6e4,d=!0,f=!0,p=1073741824,h=1*p,g={};return g.setAutoResumeEnabled=function(e){d=e},g.setRespectRetryAfterHeader=function(e){f=e},g.setMaxChunkSize=function(e){h=e},g.resumeUpload=function(e,t,n){var r=c(e,n);return r.resume(t),r},g.youtubeUpload=function(e,t,n){t=t||{},t.privacy||(t.privacy="public");var r={snippet:{title:t.title||e.name,description:t.description||""},status:{privacyStatus:t.privacy}},o={params:{part:Object.keys(r).join(","),uploadType:"resumable"}};return g.upload(u,e,r,n,o)},g.driveUpload=function(e,t,n){return g.upload(s,e,t,n)},g.upload=function(e,t,n,r,o){var i=c(t,r);return i.start(e,n,o),i},g}]),angular.module("w69b.logging",[]).provider("$log",function(){var e=!0,t=this,n=!1;this.debugEnabled=function(t){return angular.isDefined(t)?(e=t,this):e},this.setCustomHook=function(e){n=e},this.$get=["$window",function(r){function o(e){return e instanceof Error&&(e.stack?e=e.message&&e.stack.indexOf(e.message)===-1?"Error: "+e.message+"\n"+e.stack:e.stack:e.sourceURL&&(e=e.message+"\n"+e.sourceURL+":"+e.line)),e}function i(e){var t=r.console||{},i=t[e]||t.log||angular.noop,a=!1;try{a=!!i.apply}catch(c){}return a?function(){var r=[];if(angular.forEach(arguments,function(e){r.push(o(e))}),n&&n(e,r))return i.apply(t,r)}:function(t,r){n&&n(e,[t,r])&&i(t,null===r?"":r)}}return{log:i("log"),info:i("info"),warn:i("warn"),error:i("error"),debug:function(){var n=i("debug");return function(){e&&n.apply(t,arguments)}}()}}]}),angular.module("w69b.ngProgressHttp",[]).service("$progressHttp",["$http","$q",function(e,t){function n(n){n.headers=n.headers||{},n.method=n.method||"POST";var r,o=t.defer();n.headers.__setXHR__=function a(){return function(e){return e?(r=e,n.progressEvents&&"download"!==n.progressEvents||(r.addEventListener("progress",function(e){o.notify({type:"download",event:e})},!1),r.addEventListener("load",function(e){e.lengthComputable&&o.notify({type:"download",event:e})},!1)),void(n.progressEvents&&"upload"!==n.progressEvents||(r.upload.addEventListener("progress",function(e){o.notify({type:"upload",event:e})},!1),r.upload.addEventListener("load",function(e){e.lengthComputable&&o.notify({type:"upload",event:e})},!1)))):a()}},e(n).then(o.resolve.bind(o),o.reject.bind(o),o.notify.bind(o));var i=o.promise;return i.abort=function(){return r&&r.abort(),i},i}return n}]).config(function(){window.XMLHttpRequest=function(e){return function(){var t=new e;return t.setRequestHeader=function(e){return function(n,r){"__setXHR__"===n?r(t):e.apply(t,arguments)}}(t.setRequestHeader),t}}(window.XMLHttpRequest)}),angular.module("w69b.pnaclModule",[]).factory("pnaclModule",["$q","$log","$timeout",function(e,t,n){function r(r,i,a){function c(){g.addEventListener("crash",s,!0),g.addEventListener("message",l,!0)}function u(){g.removeEventListener("message",l,!0),g.removeEventListener("crash",s,!0)}function s(){t.error("pnacl module crashed",v.lastError),m.onCrash&&m.onCrash(v.lastError)}function l(e){m.onMessage&&m.onMessage(e)}var d=i?"pnacl":"nacl",f=["<embed ","width=0 height=0 ",'src="'+r+'" ','ps_tty_prefix="ps:" ps_stdout="/dev/tty" ps_stderr="/dev/tty" type="application/x-'+d+'" />'].join("");a||(a=document.body);var p,h,g=document.createElement("div"),m={isLoaded:!1};m.onMessage=void 0,m.onCrash=void 0;var v;return m.load=function(){function t(){g.removeEventListener("load",r,!0),g.removeEventListener("error",i,!0)}function r(){t(),u.resolve()}function i(){t(),u.reject(v.lastError)}if(p)return p;var u=e.defer();g.addEventListener("load",r,!0),g.addEventListener("error",i,!0),c(),h=n(function(){u.reject("load_timeout")},o),g.innerHTML=f,v=g.children[0],a.appendChild(g),g.focus(),p=u.promise,p["finally"](function(){n.cancel(h),h=null});var s=p;return p["catch"](function(){m.unload()}),s},m.unload=function(){m.isLoaded=!1,u(),g.innerHTML="",a.removeChild(g),v=null,p=null},m.getElement=function(){return v},m.postMessage=function(e){if(!v)throw new Error("not loaded");v.postMessage(e)},m}var o=8e3;return r}]),angular.module("w69b.pnaclVideoEncoder",["w69b.pnaclModule"]).factory("pnaclVideoEncoder",["pnaclModule","$q","$log","$rootScope","$timeout",function(e,t,n,r,o){function i(i,a){function c(){m={state:"inactive",time:0}}function u(){b.unload(),c()}function s(e){m=e}function l(e){u(),y&&y.reject(e),y=null}function d(e){n.error("pnaclVideoEncoderError",e),l(e),S.onError&&S.onError(e)}function f(e){l(),S.onCrash&&S.onCrash(e)}function p(){return Number((/Chrome\/(\d+)/.exec(window.navigator.userAgent)||[void 0,0])[1])}function h(e,t){b.postMessage({type:e,data:t||{}})}function g(e,n){if(y)throw new Error("there is still a pending operation");return y=t.defer(),e&&h(e,n),y.promise}var m,v,b=e(i,a),y=null,w=8e3,x=["start","stop","pause","resume","replaceTracks"],S={};return b.onMessage=function(e){if(e=e.data,x.indexOf(e.type)>=0){if(!y)return;e.data?y.reject(e.data):y.resolve(),y=null}else if("error"==e.type)d(e.data),r.$$phase||r.$digest();else if("state"==e.type)s(e.data),r.$$phase||r.$digest();else if("stack_trace"==e.type)f(e.data);else{var t;e.data&&(t=e.data,t.trim&&(t=t.trim())),n.debug(e.type,t)}},S.onCrash=void 0,b.onCrash=f,S.stop=function(){return g("stop").then(function(){u()})},S.load=function(){return b.load()["catch"](function(e){return n.warn("original pnacl.load error: ",e),t.reject("nacl_load")})},S.getState=function(){return m.state},S.getStateObj=function(){return m},S.getFPS=function(){return m.fps},S.getCurrentTime=function(){return m.time},S.replaceTracks=function(e){return g("replaceTracks",e)},S.pause=function(){return g("pause")},S.resume=function(){return g("resume")},S.hasPendingOperation=function(){return!!y},S.start=function(e,t){if(!e)throw new Error("invalid filename");e="/html5_persistent/"+e;var n=g();return v=o(function(){d("start_timeout")},w),b.load().then(function(){var r=angular.extend({},t,{filename:e,chromeVersion:p()});return h("start",r),n})["finally"](function(){o.cancel(v),v=null})},c(),S}return i}]),angular.module("w69b.promiseTool",[]).factory("promiseTool",["$q","$timeout",function(e,t){var n={};return n.wrapChromeError=function(t,n){return function(){var r=Array.prototype.slice.call(arguments,0),o=e.defer();return r.push(function(e){chrome.runtime.lastError?o.reject(chrome.runtime.lastError):o.resolve(e)}),t.apply(n,r),o.promise}},n.wrapCallbacks=function(t,n){return function(){var r=Array.prototype.slice.call(arguments,0),o=e.defer();return r.push(o.resolve.bind(o)),r.push(o.reject.bind(o)),t.apply(n,r),o.promise}},n.serializer=function(){var t=null,n=function(n){var r=e.defer();return(t||e.when())["finally"](function(){var e=n.call();r.resolve(e)}),t=r.promise,t["finally"](function(){t=null}),r.promise};return n.wrap=function(e){return function(){return n(e.bind.apply(e,[this].concat(Array.prototype.slice.call(arguments))))}},n},n.withTimeout=function(n,r,o){o||(o=angular.noop);var i=e.defer(),a=t(function(){var e=o();angular.isDefined(e)?i.resolve(e):i.reject("timeout"),i=null},r),c=n(),u=i.promise;return c["finally"](function(){t.cancel(a),a=null}),c.then(function(){i&&i.resolve.apply(i,arguments)},function(){i&&i.reject.apply(i,arguments)}),u},n}]),angular.module("w69b.streamedVideo",[]).factory("streamedVideo",["$q",function(e){return function(){function t(){a.onEnded&&a.onEnded()}var n,r,o,i=document.createElement("video"),a={onEnded:null};return a.stop=function(){r&&(i.pause(),i.src="",window.URL.revokeObjectURL(n),r.removeEventListener("ended",t),r.stop(),r=null,o=!1)},a.load=function(c){if(r)throw new Error;r=c;var u=e.defer();return c.addEventListener("ended",t),n=window.URL.createObjectURL(c),i.addEventListener("canplay",function s(){i.removeEventListener("canplay",s),i.play(),0===i.videoHeight||0===i.videoWidth?(a.stop(),u.reject("loading video failed")):(o=!0,u.resolve())}),i.addEventListener("error",function l(){i.removeEventListener("error",l),a.stop(),u.reject(i.error)}),i.src=n,i.volume=0,u.promise},a.isLoaded=function(){return o},a.getVideoElement=function(){return i},a}}]),angular.module("w69b.structs.CircularBuffer",[]).factory("CircularBuffer",function(){var e=function(e){this.maxSize_=e||100,this.buff_=[]},t=e.prototype;return t.nextPtr_=0,t.add=function(e){this.buff_[this.nextPtr_]=e,this.nextPtr_=(this.nextPtr_+1)%this.maxSize_},t.get=function(e){return e=this.normalizeIndex_(e),this.buff_[e]},t.set=function(e,t){e=this.normalizeIndex_(e),this.buff_[e]=t},t.getCount=function(){return this.buff_.length},t.isEmpty=function(){return 0===this.buff_.length},t.clear=function(){this.buff_.length=0,this.nextPtr_=0},t.getValues=function(){return this.getNewestValues(this.getCount())},t.getNewestValues=function(e){for(var t=this.getCount(),n=this.getCount()-e,r=[],o=n;o<t;o++)r.push(this.get(o));return r},t.getKeys=function(){for(var e=[],t=this.getCount(),n=0;n<t;n++)e[n]=n;return e},t.containsKey=function(e){return e<this.getCount()},t.containsValue=function(e){for(var t=this.getCount(),n=0;n<t;n++)if(this.get(n)==e)return!0;return!1},t.getLast=function(){return 0===this.getCount()?null:this.get(this.getCount()-1)},t.normalizeIndex_=function(e){if(e>=this.buff_.length)throw Error("Out of bounds exception");return this.buff_.length<this.maxSize_?e:(this.nextPtr_+Number(e))%this.maxSize_},e}),angular.module("w69b.spawn",[]).factory("spawn",["$q","$log",function(e,t){function n(t,n){function r(e,t){var n;try{n=e(t)}catch(r){return o(r)}return n.done?i(n.value):i(n.value).then(c,u)}var o=n?Promise.reject.bind(Promise):e.reject.bind(e),i=n?Promise.resolve.bind(Promise):e.when.bind(e),a=t(),c=r.bind(null,a.next.bind(a)),u=r.bind(null,a["throw"].bind(a));return c()}return n.wrap=function(e){return function(){var t=arguments;return n(e.bind.apply(e,[this].concat(_toConsumableArray(t))))}},n}]),angular.module("w69b.throttle",[]).factory("throttle",["$timeout",function(e){function t(t,n,r){var o,i,a;r=r!==!1;var c=function(){return a=angular.copy(arguments,[]),i=function(){return o=null,i=null,t.apply(null,a)},r?(o&&e.cancel(o),o=e(i,n)):o||(o=e(i,n)),o};return c.flush=function(){o&&(e.cancel(o),i())},c}return t}]),angular.module("w69b.webrtc",["w69b.promiseTool"]).factory("webrtc",["promiseTool","$window","$q",function(e,t,n){function r(e){return e.some(function(e){return!!e.label})}var o={},i=t.navigator;return o.getUserMedia=e.wrapCallbacks(i.getUserMedia||i.webkitGetUserMedia||i.mozGetUserMedia||i.msGetUserMedia,i),i.mediaDevices&&i.mediaDevices.enumerateDevices?o.getSources=function(){return n.when(i.mediaDevices.enumerateDevices()).then(function(e){return e.filter(function(e){return e.kind.endsWith("input")}).map(function(e){var t={id:e.deviceId,label:e.label};return t.kind=e.kind.substring(0,e.kind.length-5),t})})}:o.getSources=e.wrapCallbacks(MediaStreamTrack.getSources,MediaStreamTrack),o.getSourcesByKind=function(e){return o.getSources().then(function(t){return t.filter(function(t){return t.kind===e})})},o.getVideoSources=function(){return o.getSourcesByKind("video")},o.getAudioSources=function(){return o.getSourcesByKind("audio")},o.hasCamera=function(){return o.getVideoSources().then(function(e){return e.length>0})},o.hasMicrophone=function(){return o.getAudioSources().then(function(e){return e.length>0})},o.hasVideoAccess=function(){return o.getVideoSources().then(r)},o.hasAudioAccess=function(){return o.getAudioSources().then(r)},o}]),angular.module("w69b.clipboard",[]).factory("clipboard",["$document",function(e){var t={};return t.copy=function(t){var n=angular.element("<textarea></textarea>");n.text(t),e.find("body").append(n),n[0].select(),e[0].execCommand("copy"),n.remove()},t}]),angular.module("w69b.googledrive",[]).factory("googledrive",["$q","googleauth","$location","$interval","$http",function(e,t,n,r,o){function i(e){return e.data}function a(e,t){return o.get(l+e,{googleAuth:!0,params:t}).then(i)}function c(e,t){return o.post(l+e,t,{googleAuth:!0}).then(i)}function u(e,t){return o({method:"PATCH",url:l+e,data:t,googleAuth:!0}).then(i)}var s=!1,l="https://www.googleapis.com/drive/v2/",d={};return d.isLoaded=function(){return s},d.loadLibs=function(){if(s)return e.when(null);var n=t.loadClient().then(function(){return e.all([t.gapiLoad("picker")])});return n.then(function(){s=!0})},d.getFile=function(e){return a("files/"+e)},d.listFiles=function(e){return a("files/",e).then(function(e){return e.items})},d.postFile=function(e){return c("files",e)},d.patchFile=function(e,t){return u("files/"+e,t)},d.trashFile=function(e){return c("files/"+e+"/trash")},d.getAbout=function(){return a("about")},d.showShareSettings=function(n){return t.gapiLoad("drive-share").then(function(){var o=new gapi.drive.share.ShareClient(t.getAppId());o.setItemIds([n]),o.showSettingsDialog();var i=e.defer(),a=r(function(){for(var e=!1,t=document.activeElement;t!==document.documentElement;){if(t.classList.contains("dcs-ad-dcs-c")){e=!0;break}t=t.parentNode}e||(r.cancel(a),i.resolve())},300);return i.promise})},d.listPermissions=function(e){return a("files/"+e+"/permissions").then(function(e){return e.items})},d.insertPermission=function(e,t){return o.post(l+"files/"+e+"/permissions",t,{googleAuth:!0}).then(i)},d.patchPermission=function(e,t,n){return u("files/"+e+"/permissions/"+t,n)},d.removePermission=function(e,t){return o["delete"](l+"files/"+e+"/permissions/"+t,{googleAuth:!0}).then(i)},d.getContextAction=function(){var e=n.search().state,t=null;if(angular.isString(e))try{t=JSON.parse(e)}catch(r){}if(t){var o=t.ids||[],i=t.exportIds||[];return{action:t.action,ids:o.concat(i),parentId:t.parentId,userId:t.userId}}return null},d}]),angular.module("w69b.chromeVersionOrder",[]).factory("chromeVersionOrder",function(){var e=[];return e.isLess=function(e,t){function n(e){return e.split(".").map(function(e){return Number(e)})}for(var r=n(e),o=n(t),i=0;i<Math.max(r.length,o.length);++i){if((r[i]||0)<(o[i]||0))return!0;if((r[i]||0)>(o[i]||0))return!1}return!1},e.isEqual=function(t,n){return!e.isLess(t,n)&&!e.isLess(n,t)},e.isLessOrEqual=function(t,n){return e.isLess(t,n)||e.isEqual(t,n)},e}),angular.module("w69b.chromeAlarms",["w69b.promiseTool"]).factory("chromeAlarms",["promiseTool",function(e){var t={};return t.create=chrome.alarms.create.bind(chrome.alarms),["get","getAll","clear","clearAll"].forEach(function(n){t[n]=e.wrapChromeError(chrome.alarms[n],chrome.alarms)}),t.onAlarm=chrome.alarms.onAlarm,t}]),angular.module("w69b.chromeNotifications",["w69b.promiseTool"]).factory("chromeNotifications",["promiseTool",function(e){function t(e){var t=c[e];t&&t.onClicked&&t.onClicked()}function n(e,t){var n=c[e];n&&n.onButtonClicked&&n.onButtonClicked(t)}function r(e,t){var n=c[e];n&&(n.onClosed&&n.onClosed(t),delete c[e],Object.keys(c).length||i())}function o(){a.onClicked.addListener(t),a.onButtonClicked.addListener(n),a.onClosed.addListener(r)}function i(){a.onClicked.removeListener(t),a.onButtonClicked.removeListener(n),a.onClosed.removeListener(r)}var a={},c={};return a.simple={},a.simple.defaultOptions={},a.simple.create=function(t,n){var r=e.serializer(),i={};return t=angular.extend({},a.simple.defaultOptions,t),r(function(){return a.create(n||"",t).then(function(e){i.id=e,Object.keys(c).length||o(),c[e]=i})}),i.clear=function(){r(function(){return a.clear(i.id)})},i.update=function(e){r(function(){return a.update(i.id,e)})},i.onClicked=angular.noop,i.onButtonClicked=angular.noop,i.onClosed=angular.noop,i},["clear","create","update","getAll","getPermissionLevel"].forEach(function(t){a[t]=e.wrapChromeError(chrome.notifications[t],chrome.notifications)}),["onClosed","onClicked","onButtonClicked","onPermissionLevelChanged","onShowSettings"].forEach(function(e){a[e]=chrome.notifications[e]}),a}]),angular.module("w69b.asyncResponse",[]).factory("asyncResponse",["$q",function(e){var t={};return t.createSender=function(t){var n={},r=0,o={};return n.sendWithResponse=function(n,i){var a=++r,c=e.defer();return o[a]=c,t({type:n,data:i,msgId:a}),c.promise},n.send=function(e,n){t({type:e,data:n})},n.handleResult=function(e){if(e&&"result"===e.type){var t=o[e.msgId];return delete o[e.msgId],e.hasOwnProperty("error")||e.isError?t.reject(e.error):t.resolve(e.data),!0}return!1},n},t.createRespond=function(t){return function(n,r){e.when(n).then(function(e){t({type:"result",msgId:r.msgId,data:e})},function(e){t({type:"result",msgId:r.msgId,error:e,isError:!0})})}},t}]),angular.module("w69b.ui.bytesFilter",[]).filter("bytes",["$injector",function(e){function t(t,r){return n||(n=e.get("$filter")("number")),n(t,r)}var n;return function(e,n){if(!angular.isNumber(e))return"-";if(angular.isUndefined(n)&&(n=1),e<=0)return"0 B";var r=["B","KB","MB","GB","TB","PB"],o=Math.floor(Math.log(e)/Math.log(1024));return t(e/Math.pow(1024,Math.floor(o)),n)+" "+r[o]}}]),angular.module("w69b.chromePermissions",["w69b.promiseTool"]).factory("chromePermissions",["promiseTool",function(e){var t=window.chrome&&window.chrome.permissions,n={};return t?(n.contains=e.wrapChromeError(t.contains,t),n.request=e.wrapChromeError(t.request,t),n.remove=e.wrapChromeError(t.remove,t),n.getAll=e.wrapChromeError(t.getAll,t),n):n}]),angular.module("w69b.chromeSystem",["w69b.promiseTool"]).factory("chromeSystem",["promiseTool",function(e){var t=window.chrome&&window.chrome.system,n={};return t?(t.cpu&&(n.cpu={getInfo:e.wrapChromeError(t.cpu.getInfo,t.cpu)}),t.memory&&(n.memory={getInfo:e.wrapChromeError(t.memory.getInfo,t.memory)}),n):n}]),angular.module("castifyExt.bgApp",["w69b.es6","castifyExt.commonConfig","castifyExt.bgRecord","castifyExt.bgUpload","w69b.chromePersistentLogger","castifyExt.recordingHooks","castifyExt.updateMigrationService","castifyExt.diskSpaceWatcher","castifyExt.licenseEnforcer","castifyExt.bgMessages","castifyExt.driveFileWatcher","castifyExt.bgFiles","castifyExt.bgSyncManager","castifyExt.syncNotifications","castifyExt.authConfig","castifyEdit.bgEditJobScheduler","castifyEdit.editNotifications","w69b.chromeNotifications","castifyExt.connect.bgConnectService","castifyExt.bgSyncDownloader","castifyExt.bgCastifyAuth","castifyExt.bgUserAccount"]).config(["analyticsProvider","chromePersistentLoggerProvider","chromeVideoRecorderProvider","bgCastifyAuthProvider","deployConfigProvider",function(e,t,n,r,o){n.setEncoderUrl("manifest_encoder.nmf",!1),t.setStorageKey("background"),t.enableGlobalHandler(!0),t.enableAutoSave(!1),t.install(),r.setClientId(o.clientId),r.setScopes(o.scopes),r.setRedirectUri(o.redirectUri)}]).run(["bgRecordService","bgUploadService","analytics","$log","bgMessages","$q","recordingHooks","updateMigrationService","diskSpaceWatcher","licenseEnforcer","driveFileWatcher","bgFiles","googleUploader","chromePersistentLogger","chromeRuntime","bgSyncManager","syncNotifications","onlineState","bgEditJobScheduler","editNotifications","chromeNotifications","bgConnectService","bgSyncDownloader","bgCastifyAuth","bgUserAccount",function(e,t,n,r,o,i,a,c,u,s,l,d,f,p,h,g,m,v,b,y,w,x,S,E,k){w.simple.defaultOptions={type:"basic",priority:2,iconUrl:"images/icon128.png"},f.setAutoResumeEnabled(!1),f.setRespectRetryAfterHeader(!1),a.install(),E.install(),i.all([g.install(),e.install(),t.install(),c.install(),u.install(),s.install(),o.install(),l.install(),d.install(),m.install(),b.install(),y.install(),x.install(),S.install(),k.install()])["finally"](function(){o.initializationCompleted()}),v.check(),h.onSuspend.addListener(function(){"inactive"===e.getRecorderState().state&&p.save()}),h.setUninstallURL("https://www.screencastify.com/api/on_uninstall")}]),e()}();